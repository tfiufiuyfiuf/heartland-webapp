# 🎯 第一步：分院测试实现方案

## 功能概述

注册完成后，用户进入霍格沃茨学院分院测试，根据回答分配到四个学院之一。

## 实现步骤

### 步骤 1：创建分院测试页面

**文件**：`heartland-webapp/sorting-hat.html`

**页面元素**：
- 魔法背景动画
- 分院帽图标
- 题目展示区
- 选项按钮（打乱顺序）
- 进度条
- 结果展示

---

### 步骤 2：设计测试题目

#### 题目示例（15题）

**格式**：
```javascript
{
  id: 1,
  question: "如果你发现朋友考试作弊，你会？",
  options: [
    { text: "直接制止，维护公平", house: "gryffindor", score: 3 },
    { text: "私下劝说，帮其改正", house: "hufflepuff", score: 3 },
    { text: "分析利弊，理性建议", house: "ravenclaw", score: 3 },
    { text: "保持沉默，各有选择", house: "slytherin", score: 3 }
  ]
}
```

#### 完整题库

1. **价值观题目**（5题）
   - 正义 vs 忠诚
   - 智慧 vs 勇气
   - 目标 vs 过程

2. **情景判断题**（5题）
   - 面对困难的选择
   - 团队协作场景
   - 道德困境

3. **性格特质题**（5题）
   - 领导力
   - 创造力
   - 决策方式

---

### 步骤 3：实现选项打乱算法

```javascript
// Fisher-Yates 洗牌算法
function shuffleOptions(options) {
  const shuffled = [...options];
  for (let i = shuffled.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
  }
  return shuffled;
}
```

---

### 步骤 4：计分系统

```javascript
// 统计各学院得分
function calculateHouse(answers) {
  const scores = {
    gryffindor: 0,
    slytherin: 0,
    ravenclaw: 0,
    hufflepuff: 0
  };
  
  answers.forEach(answer => {
    scores[answer.house] += answer.score;
  });
  
  // 找出最高分学院
  const maxScore = Math.max(...Object.values(scores));
  const houses = Object.keys(scores).filter(h => scores[h] === maxScore);
  
  // 如果有多个学院分数相同，随机选择一个
  return houses[Math.floor(Math.random() * houses.length)];
}
```

---

### 步骤 5：数据库表设计

```sql
-- 分院测试题目表
CREATE TABLE IF NOT EXISTS sorting_questions (
  id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
  question TEXT NOT NULL,
  options JSONB NOT NULL,
  category VARCHAR(50),
  difficulty INTEGER DEFAULT 2 CHECK (difficulty BETWEEN 1 AND 3),
  order_index INTEGER,
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 用户分院记录表
CREATE TABLE IF NOT EXISTS user_sorting_history (
  id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  answers JSONB NOT NULL,
  scores JSONB NOT NULL,
  final_house VARCHAR(20) NOT NULL,
  test_duration INTEGER, -- 测试用时（秒）
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 创建索引
CREATE INDEX idx_sorting_history_user ON user_sorting_history(user_id);
```

---

### 步骤 6：API 端点

#### 6.1 获取分院测试题目

**端点**：`GET /api/sorting/questions`

**返回**：
```json
{
  "success": true,
  "data": {
    "questions": [
      {
        "id": "uuid",
        "question": "题目内容",
        "options": [
          { "id": 1, "text": "选项A" },
          { "id": 2, "text": "选项B" },
          { "id": 3, "text": "选项C" },
          { "id": 4, "text": "选项D" }
        ]
      }
    ]
  }
}
```

#### 6.2 提交分院测试答案

**端点**：`POST /api/sorting/submit`

**请求**：
```json
{
  "answers": [
    { "questionId": "uuid", "optionId": 1 },
    { "questionId": "uuid", "optionId": 3 }
  ]
}
```

**返回**：
```json
{
  "success": true,
  "data": {
    "house": "gryffindor",
    "scores": {
      "gryffindor": 12,
      "slytherin": 8,
      "ravenclaw": 9,
      "hufflepuff": 10
    },
    "message": "恭喜！分院帽将你分配到了格兰芬多！"
  }
}
```

---

### 步骤 7：前端页面设计

#### 页面流程
1. **欢迎页面**
   - 分院帽介绍
   - 开始测试按钮

2. **测试页面**
   - 题目展示
   - 选项按钮（打乱顺序）
   - 进度条（显示当前第几题）
   - 上一题/下一题按钮

3. **结果页面**
   - 学院徽章动画
   - 学院介绍
   - 学院特质
   - 进入系统按钮

#### UI 设计要点
- **魔法主题**：使用哈利波特风格
- **动画效果**：分院帽说话动画
- **配色方案**：
  - 格兰芬多：红金色
  - 斯莱特林：绿银色
  - 拉文克劳：蓝铜色
  - 赫奇帕奇：黄黑色

---

### 步骤 8：集成到注册流程

#### 修改注册流程

**原流程**：
```
注册 → 自动登录 → 跳转主页
```

**新流程**：
```
注册 → 自动登录 → 检查是否完成分院测试
  ↓
  未完成 → 跳转分院测试页面 → 完成测试 → 更新学院 → 跳转主页
  ↓
  已完成 → 跳转主页
```

#### 修改用户表

```sql
-- 添加分院测试状态字段
ALTER TABLE users 
ADD COLUMN sorting_completed BOOLEAN DEFAULT false;
```

---

## 完整实现文件列表

### 前端文件
1. `heartland-webapp/sorting-hat.html` - 分院测试页面
2. `heartland-webapp/sorting-result.html` - 结果页面（可选）
3. `heartland-webapp/css/sorting-hat.css` - 样式
4. `heartland-webapp/js/sorting-hat.js` - 逻辑

### 后端文件
1. `backend/routes/sorting.js` - 分院测试路由
2. `backend/config/sorting-questions.sql` - 题目数据
3. `backend/config/sorting-schema.sql` - 数据库表

---

## 时间估算

- **设计题目**：2-3 小时
- **前端页面**：4-6 小时
- **后端 API**：2-3 小时
- **测试调试**：2-3 小时
- **总计**：10-15 小时

---

## 下一步

我可以立即开始实现：
1. 创建分院测试题目（15题）
2. 创建前端页面
3. 创建后端 API
4. 集成到注册流程

是否现在开始实现？


