<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¿ƒå±¿å­¦é™¢ - é’å°‘å¹´å¿ƒç†å¥åº·å­¦ä¹ å¹³å°</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- APIé…ç½®å’Œå°è£… -->
    <script src="./frontend/config.js"></script>
    <script src="./frontend/api.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #5B7FFF;
            --secondary-color: #7B68EE;
            --success-color: #00C48C;
            --warning-color: #FFA940;
            --danger-color: #FF4D6D;
            --dark-color: #1A1D2E;
            --light-color: #F8F9FA;
            --border-color: #E1E8ED;
            --shadow: 0 4px 12px rgba(0,0,0,0.08);
            --shadow-lg: 0 8px 24px rgba(0,0,0,0.12);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: var(--dark-color);
            min-height: 100vh;
            line-height: 1.6;
        }

        /* ================ ç™»å½•æ³¨å†Œé¡µé¢ ================ */
        .auth-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .auth-card {
            background: white;
            border-radius: 24px;
            padding: 48px;
            box-shadow: var(--shadow-lg);
            width: 100%;
            max-width: 480px;
            animation: slideUp 0.5s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .auth-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .auth-logo {
            width: 80px;
            height: 80px;
            margin: 0 auto 20px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
            color: white;
        }

        .auth-title {
            font-size: 28px;
            font-weight: 700;
            color: var(--dark-color);
            margin-bottom: 8px;
        }

        .auth-subtitle {
            color: #666;
            font-size: 14px;
        }

        .auth-tabs {
            display: flex;
            gap: 16px;
            margin-bottom: 32px;
            background: var(--light-color);
            padding: 6px;
            border-radius: 12px;
        }

        .auth-tab {
            flex: 1;
            padding: 12px;
            border: none;
            background: transparent;
            border-radius: 8px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            color: #666;
            transition: all 0.3s ease;
        }

        .auth-tab.active {
            background: white;
            color: var(--primary-color);
            box-shadow: var(--shadow);
        }

        .auth-form {
            display: none;
        }

        .auth-form.active {
            display: block;
        }

        .form-group {
            margin-bottom: 24px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark-color);
            font-size: 14px;
        }

        .form-input-group {
            position: relative;
        }

        .form-input {
            width: 100%;
            padding: 14px 16px;
            padding-left: 48px;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            font-size: 15px;
            transition: all 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(91, 127, 255, 0.1);
        }

        .form-icon {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
            font-size: 18px;
        }

        .form-input:focus + .form-icon {
            color: var(--primary-color);
        }

        .verification-group {
            display: flex;
            gap: 12px;
        }

        .verification-group .form-input {
            flex: 1;
        }

        .send-code-btn {
            padding: 14px 24px;
            background: var(--light-color);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            color: var(--primary-color);
            white-space: nowrap;
            transition: all 0.3s ease;
        }

        .send-code-btn:hover:not(:disabled) {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .send-code-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .form-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 24px;
        }

        .form-checkbox input {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .form-checkbox label {
            font-size: 14px;
            color: #666;
            cursor: pointer;
        }

        .form-checkbox a {
            color: var(--primary-color);
            text-decoration: none;
        }

        .form-checkbox a:hover {
            text-decoration: underline;
        }

        .submit-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(91, 127, 255, 0.3);
        }

        .submit-btn:active {
            transform: translateY(0);
        }

        .form-footer {
            text-align: center;
            margin-top: 24px;
            font-size: 14px;
            color: #666;
        }

        .form-footer a {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 600;
        }

        .form-footer a:hover {
            text-decoration: underline;
        }

        .demo-notice {
            background: linear-gradient(135deg, #FFF4E6, #FFE7BA);
            border-left: 4px solid var(--warning-color);
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 24px;
        }

        .demo-notice-title {
            font-weight: 600;
            color: var(--warning-color);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .demo-notice-content {
            font-size: 13px;
            color: #856404;
            line-height: 1.6;
        }

        /* ================ Toast æç¤º ================ */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideIn 0.3s ease;
            z-index: 10000;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .toast.success {
            border-left: 4px solid var(--success-color);
        }

        .toast.error {
            border-left: 4px solid var(--danger-color);
        }

        .toast.warning {
            border-left: 4px solid var(--warning-color);
        }

        .toast i {
            font-size: 20px;
        }

        .toast.success i {
            color: var(--success-color);
        }

        .toast.error i {
            color: var(--danger-color);
        }

        .toast.warning i {
            color: var(--warning-color);
        }

        /* ================ ä¸»åº”ç”¨ç•Œé¢ ================ */
        .app-container {
            display: none;
        }

        .app-container.active {
            display: block;
        }

        .app-header {
            background: white;
            box-shadow: var(--shadow);
            padding: 16px 0;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header-logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 24px;
            font-weight: 700;
            color: var(--primary-color);
        }

        .header-logo i {
            font-size: 32px;
        }

        .header-nav {
            display: flex;
            gap: 8px;
        }

        .nav-item {
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            color: #666;
        }

        .nav-item:hover {
            background: var(--light-color);
            color: var(--primary-color);
        }

        .nav-item.active {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
        }

        .header-user {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        .user-name {
            font-weight: 600;
            color: var(--dark-color);
        }

        .logout-btn {
            padding: 8px 16px;
            background: var(--light-color);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            color: var(--danger-color);
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: var(--danger-color);
            color: white;
        }

        .app-main {
            max-width: 1400px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .page-section {
            display: none;
        }

        .page-section.active {
            display: block;
        }

        .card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: var(--shadow);
            margin-bottom: 24px;
        }

        .card-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 16px;
            color: var(--dark-color);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            gap: 20px;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            color: white;
        }

        .stat-icon.primary {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        }

        .stat-icon.success {
            background: linear-gradient(135deg, #00C48C, #00A878);
        }

        .stat-icon.warning {
            background: linear-gradient(135deg, #FFA940, #FF8C00);
        }

        .stat-icon.danger {
            background: linear-gradient(135deg, #FF4D6D, #FF1744);
        }

        .stat-content h3 {
            font-size: 32px;
            font-weight: 700;
            color: var(--dark-color);
            margin-bottom: 4px;
        }

        .stat-content p {
            color: #666;
            font-size: 14px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(91, 127, 255, 0.3);
        }

        /* ================ å“åº”å¼ ================ */
        @media (max-width: 768px) {
            .auth-card {
                padding: 32px 24px;
            }

            .header-nav {
                display: none;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- ================ ç™»å½•æ³¨å†Œç•Œé¢ ================ -->
    <div id="auth-page" class="auth-container">
        <div class="auth-card">
            <div class="auth-header">
                <div class="auth-logo">
                    <i class="fas fa-heart"></i>
                </div>
                <h1 class="auth-title">å¿ƒå±¿å­¦é™¢</h1>
                <p class="auth-subtitle">é’å°‘å¹´å¿ƒç†å¥åº·å­¦ä¹ å¹³å°</p>
            </div>

            <div class="demo-notice">
                <div class="demo-notice-title">
                    <i class="fas fa-info-circle"></i>
                    æ¼”ç¤ºç‰ˆæœ¬è¯´æ˜
                </div>
                <div class="demo-notice-content">
                    è¿™æ˜¯æ¼”ç¤ºç‰ˆæœ¬ï¼ŒéªŒè¯ç åŠŸèƒ½æš‚æ—¶å…³é—­ã€‚åœ¨å®é™…é¡¹ç›®ä¸­ï¼ŒéªŒè¯ç åº”ç”±åç«¯å‘é€åˆ°æ‰‹æœºã€‚
                    <br><strong>æµ‹è¯•éªŒè¯ç ï¼š123456</strong>
                </div>
            </div>

            <div class="auth-tabs">
                <button class="auth-tab active" onclick="switchAuthTab('login')">ç™»å½•</button>
                <button class="auth-tab" onclick="switchAuthTab('register')">æ³¨å†Œ</button>
            </div>

            <!-- ç™»å½•è¡¨å• -->
            <form id="login-form" class="auth-form active" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label class="form-label">ç”¨æˆ·å</label>
                    <div class="form-input-group">
                        <input type="text" id="login-username" class="form-input" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" required>
                        <i class="fas fa-user form-icon"></i>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">å¯†ç </label>
                    <div class="form-input-group">
                        <input type="password" id="login-password" class="form-input" placeholder="è¯·è¾“å…¥å¯†ç " required>
                        <i class="fas fa-lock form-icon"></i>
                    </div>
                </div>

                <div class="form-checkbox">
                    <input type="checkbox" id="remember-me">
                    <label for="remember-me">è®°ä½æˆ‘</label>
                </div>

                <button type="submit" class="submit-btn">
                    <i class="fas fa-sign-in-alt"></i> ç™»å½•
                </button>

                <div class="form-footer">
                    è¿˜æ²¡æœ‰è´¦å·ï¼Ÿ<a href="#" onclick="switchAuthTab('register'); return false;">ç«‹å³æ³¨å†Œ</a>
                </div>
            </form>

            <!-- æ³¨å†Œè¡¨å• -->
            <form id="register-form" class="auth-form" onsubmit="handleRegister(event)">
                <div class="form-group">
                    <label class="form-label">æ‰‹æœºå·ï¼ˆé€‰å¡«ï¼‰</label>
                    <div class="form-input-group">
                        <input type="tel" id="register-phone" class="form-input" placeholder="è¯·è¾“å…¥æ‰‹æœºå·ï¼ˆå¯é€‰ï¼‰">
                        <i class="fas fa-phone form-icon"></i>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">ç”¨æˆ·å</label>
                    <div class="form-input-group">
                        <input type="text" id="register-username" class="form-input" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" required>
                        <i class="fas fa-user form-icon"></i>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">éªŒè¯ç ï¼ˆé€‰å¡«ï¼‰</label>
                    <div class="verification-group">
                        <div class="form-input-group">
                            <input type="text" id="register-code" class="form-input" placeholder="è¯·è¾“å…¥éªŒè¯ç ï¼ˆå¯é€‰ï¼‰">
                            <i class="fas fa-shield-alt form-icon"></i>
                        </div>
                        <button type="button" class="send-code-btn" onclick="sendVerificationCode()">
                            å‘é€éªŒè¯ç 
                        </button>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">å¯†ç </label>
                    <div class="form-input-group">
                        <input type="password" id="register-password" class="form-input" placeholder="è¯·è¾“å…¥å¯†ç ï¼ˆè‡³å°‘6ä½ï¼‰" required>
                        <i class="fas fa-lock form-icon"></i>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">ç¡®è®¤å¯†ç </label>
                    <div class="form-input-group">
                        <input type="password" id="register-password-confirm" class="form-input" placeholder="è¯·å†æ¬¡è¾“å…¥å¯†ç " required>
                        <i class="fas fa-lock form-icon"></i>
                    </div>
                </div>

                <div class="form-checkbox">
                    <input type="checkbox" id="agree-terms" required>
                    <label for="agree-terms">æˆ‘å·²é˜…è¯»å¹¶åŒæ„ <a href="#">ç”¨æˆ·åè®®</a> å’Œ <a href="#">éšç§æ”¿ç­–</a></label>
                </div>

                <button type="submit" class="submit-btn">
                    <i class="fas fa-user-plus"></i> æ³¨å†Œ
                </button>

                <div class="form-footer">
                    å·²æœ‰è´¦å·ï¼Ÿ<a href="#" onclick="switchAuthTab('login'); return false;">ç«‹å³ç™»å½•</a>
                </div>
            </form>
        </div>
    </div>

    <!-- ================ ä¸»åº”ç”¨ç•Œé¢ ================ -->
    <div id="app-container" class="app-container">
        <header class="app-header">
            <div class="header-content">
                <div class="header-logo">
                    <i class="fas fa-heart"></i>
                    <span>å¿ƒå±¿å­¦é™¢</span>
                </div>

                <nav class="header-nav">
                    <div class="nav-item active" onclick="switchPage('dashboard')">
                        <i class="fas fa-home"></i> é¦–é¡µ
                    </div>
                    <div class="nav-item" onclick="switchPage('courses')">
                        <i class="fas fa-book"></i> è¯¾ç¨‹
                    </div>
                    <div class="nav-item" onclick="switchPage('mood')">
                        <i class="fas fa-smile"></i> å¿ƒæƒ…
                    </div>
                    <div class="nav-item" onclick="switchPage('community')">
                        <i class="fas fa-users"></i> ç¤¾åŒº
                    </div>
                </nav>

                <div class="header-user">
                    <div class="user-avatar" id="user-avatar">U</div>
                    <div class="user-name" id="user-name">ç”¨æˆ·</div>
                    <button class="logout-btn" onclick="handleLogout()">
                        <i class="fas fa-sign-out-alt"></i> é€€å‡º
                    </button>
                </div>
            </div>
        </header>

        <main class="app-main">
            <!-- é¦–é¡µ -->
            <section id="page-dashboard" class="page-section active">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon primary">
                            <i class="fas fa-book"></i>
                        </div>
                        <div class="stat-content">
                            <h3 id="stat-courses">0</h3>
                            <p>å·²å­¦è¯¾ç¨‹</p>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon success">
                            <i class="fas fa-trophy"></i>
                        </div>
                        <div class="stat-content">
                            <h3 id="stat-points">0</h3>
                            <p>ç§¯åˆ†</p>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon warning">
                            <i class="fas fa-fire"></i>
                        </div>
                        <div class="stat-content">
                            <h3 id="stat-streak">0</h3>
                            <p>è¿ç»­æ‰“å¡</p>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon danger">
                            <i class="fas fa-heart"></i>
                        </div>
                        <div class="stat-content">
                            <h3 id="stat-mood">ğŸ˜Š</h3>
                            <p>ä»Šæ—¥å¿ƒæƒ…</p>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h2 class="card-title">æ¬¢è¿æ¥åˆ°å¿ƒå±¿å­¦é™¢</h2>
                    <p>è¿™æ˜¯ä¸€ä¸ªä¸“æ³¨äºé’å°‘å¹´å¿ƒç†å¥åº·çš„å­¦ä¹ å¹³å°ã€‚åœ¨è¿™é‡Œï¼Œä½ å¯ä»¥ï¼š</p>
                    <ul style="margin: 16px 0; padding-left: 24px; line-height: 2;">
                        <li>ğŸ“š å­¦ä¹ å¿ƒç†å¥åº·è¯¾ç¨‹</li>
                        <li>ğŸ˜Š è®°å½•æ¯æ—¥å¿ƒæƒ…</li>
                        <li>ğŸ’¬ å‚ä¸ç¤¾åŒºè®¨è®º</li>
                        <li>ğŸ¯ å®Œæˆå­¦ä¹ ä»»åŠ¡</li>
                        <li>ğŸ† è·å¾—æˆå°±å¾½ç« </li>
                    </ul>
                    <button class="btn btn-primary" onclick="switchPage('courses')">
                        <i class="fas fa-rocket"></i> å¼€å§‹å­¦ä¹ 
                    </button>
                </div>
            </section>

            <!-- è¯¾ç¨‹é¡µé¢ -->
            <section id="page-courses" class="page-section">
                <div class="card">
                    <h2 class="card-title">è¯¾ç¨‹ä¸­å¿ƒ</h2>
                    <p>è¯¾ç¨‹åŠŸèƒ½å¼€å‘ä¸­...</p>
                </div>
            </section>

            <!-- å¿ƒæƒ…é¡µé¢ -->
            <section id="page-mood" class="page-section">
                <div class="card">
                    <h2 class="card-title">å¿ƒæƒ…è®°å½•</h2>
                    <p>å¿ƒæƒ…è®°å½•åŠŸèƒ½å¼€å‘ä¸­...</p>
                </div>
            </section>

            <!-- ç¤¾åŒºé¡µé¢ -->
            <section id="page-community" class="page-section">
                <div class="card">
                    <h2 class="card-title">ç¤¾åŒº</h2>
                    <p>ç¤¾åŒºåŠŸèƒ½å¼€å‘ä¸­...</p>
                </div>
            </section>
        </main>
    </div>

    <script>
        // ================ å…¨å±€å˜é‡ ================
        let currentUser = null;
        let codeCountdown = 0;
        let codeTimer = null;

        // ================ é¡µé¢åˆå§‹åŒ– ================
        window.addEventListener('DOMContentLoaded', async () => {
            // æ£€æŸ¥æ˜¯å¦å·²ç™»å½•ï¼ˆå…¼å®¹æ–°æ—§ä¸¤ç§å­˜å‚¨keyï¼‰
            const token = localStorage.getItem('heartland_token') || localStorage.getItem('token');
            const userKey = localStorage.getItem('heartland_user') || localStorage.getItem('user');
            
            if (token && userKey) {
                try {
                    // éªŒè¯ token æ˜¯å¦æœ‰æ•ˆ
                    const userData = JSON.parse(userKey);
                    if (userData.id) {
                        currentUser = userData;
                        // å¦‚æœæ˜¯å­¦ç”Ÿè§’è‰²ä¸”æœªå®Œæˆåˆ†é™¢æµ‹è¯•ï¼Œè·³è½¬åˆ°åˆ†é™¢æµ‹è¯•
                        if (userData.role === 'student' && !userData.sorting_completed) {
                            window.location.href = 'sorting-hat.html';
                            return;
                        }
                        showApp();
                    } else {
                        showAuth();
                    }
                } catch (error) {
                    console.error('Token éªŒè¯å¤±è´¥:', error);
                    showAuth();
                }
            } else {
                showAuth();
            }
        });

        // ================ è®¤è¯ç›¸å…³å‡½æ•° ================
        function switchAuthTab(tab) {
            // åˆ‡æ¢æ ‡ç­¾æ ·å¼
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');

            // åˆ‡æ¢è¡¨å•
            document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
            if (tab === 'login') {
                document.getElementById('login-form').classList.add('active');
            } else {
                document.getElementById('register-form').classList.add('active');
            }
        }

        async function handleLogin(event) {
            event.preventDefault();

            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;

            try {
                showToast('æ­£åœ¨ç™»å½•...', 'warning');

                const response = await api.login({ username, password });

                if (response.success) {
                    // ä¿å­˜ç”¨æˆ·ä¿¡æ¯ï¼ˆä½¿ç”¨ç»Ÿä¸€çš„å­˜å‚¨keyï¼‰
                    localStorage.setItem('heartland_token', response.data.token);
                    localStorage.setItem('heartland_user', JSON.stringify(response.data.user));
                    // å…¼å®¹æ—§ç‰ˆæœ¬
                    localStorage.setItem('token', response.data.token);
                    localStorage.setItem('user', JSON.stringify(response.data.user));
                    currentUser = response.data.user;

                    // å¦‚æœæ˜¯å­¦ç”Ÿä¸”æœªå®Œæˆåˆ†é™¢æµ‹è¯•ï¼Œè·³è½¬åˆ°åˆ†é™¢æµ‹è¯•
                    if (currentUser.role === 'student' && !currentUser.sorting_completed) {
                        showToast('ç™»å½•æˆåŠŸï¼è®©æˆ‘ä»¬å…ˆå®Œæˆåˆ†é™¢æµ‹è¯•...', 'success');
                        setTimeout(() => {
                            window.location.href = 'sorting-hat.html';
                        }, 1500);
                    } else {
                        showToast('ç™»å½•æˆåŠŸï¼', 'success');
                        setTimeout(() => {
                            showApp();
                        }, 500);
                    }
                } else {
                    showToast(response.message || 'ç™»å½•å¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('ç™»å½•å¤±è´¥:', error);
                showToast(error.message || 'ç™»å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥', 'error');
            }
        }

        async function handleRegister(event) {
            event.preventDefault();

            const phone = document.getElementById('register-phone').value;
            const username = document.getElementById('register-username').value;
            const verificationCode = document.getElementById('register-code').value;
            const password = document.getElementById('register-password').value;
            const passwordConfirm = document.getElementById('register-password-confirm').value;

            // éªŒè¯å¯†ç 
            if (password !== passwordConfirm) {
                showToast('ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´', 'error');
                return;
            }

            if (password.length < 6) {
                showToast('å¯†ç é•¿åº¦è‡³å°‘ä¸º6ä½', 'error');
                return;
            }

            try {
                showToast('æ­£åœ¨æ³¨å†Œ...', 'warning');

                const registerData = {
                    username,
                    password
                };

                // åªæœ‰åœ¨å¡«å†™äº†æ‰‹æœºå·å’ŒéªŒè¯ç æ—¶æ‰æ·»åŠ è¿™äº›å­—æ®µ
                if (phone) registerData.phone = phone;
                if (verificationCode) registerData.verificationCode = verificationCode;

                const response = await api.register(registerData);

                if (response.success) {
                    // ä¿å­˜ç”¨æˆ·ä¿¡æ¯ï¼ˆä½¿ç”¨ç»Ÿä¸€çš„å­˜å‚¨keyï¼‰
                    localStorage.setItem('heartland_token', response.data.token);
                    localStorage.setItem('heartland_user', JSON.stringify(response.data.user));
                    // å…¼å®¹æ—§ç‰ˆæœ¬
                    localStorage.setItem('token', response.data.token);
                    localStorage.setItem('user', JSON.stringify(response.data.user));
                    currentUser = response.data.user;
                    
                    // å¦‚æœæ˜¯å­¦ç”Ÿä¸”æœªå®Œæˆåˆ†é™¢æµ‹è¯•ï¼Œè·³è½¬åˆ°åˆ†é™¢æµ‹è¯•
                    if (currentUser.role === 'student' && !currentUser.sorting_completed) {
                        showToast('æ³¨å†ŒæˆåŠŸï¼è®©æˆ‘ä»¬å…ˆå®Œæˆåˆ†é™¢æµ‹è¯•...', 'success');
                        setTimeout(() => {
                            window.location.href = 'sorting-hat.html';
                        }, 1500);
                    } else {
                        showToast('æ³¨å†ŒæˆåŠŸï¼æ­£åœ¨è‡ªåŠ¨ç™»å½•...', 'success');
                        setTimeout(() => {
                            showApp();
                        }, 1000);
                    }
                } else {
                    showToast(response.message || 'æ³¨å†Œå¤±è´¥', 'error');
                }
            } catch (error) {
                console.error('æ³¨å†Œå¤±è´¥:', error);
                showToast(error.message || 'æ³¨å†Œå¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥', 'error');
            }
        }

        async function sendVerificationCode() {
            const phone = document.getElementById('register-phone').value;

            if (!phone) {
                showToast('è¯·å…ˆè¾“å…¥æ‰‹æœºå·', 'error');
                return;
            }

            if (!/^1[3-9]\d{9}$/.test(phone)) {
                showToast('è¯·è¾“å…¥æœ‰æ•ˆçš„æ‰‹æœºå·', 'error');
                return;
            }

            if (codeCountdown > 0) {
                return;
            }

            try {
                // è¿™é‡Œåº”è¯¥è°ƒç”¨åç«¯ API å‘é€éªŒè¯ç 
                // const response = await api.sendVerificationCode({ phone });

                // æ¼”ç¤ºç‰ˆæœ¬ï¼šç›´æ¥æ˜¾ç¤ºæˆåŠŸ
                showToast('éªŒè¯ç å·²å‘é€ï¼ˆæ¼”ç¤ºç‰ˆæœ¬ï¼š123456ï¼‰', 'success');

                // å¼€å§‹å€’è®¡æ—¶
                startCodeCountdown();
            } catch (error) {
                console.error('å‘é€éªŒè¯ç å¤±è´¥:', error);
                showToast('å‘é€éªŒè¯ç å¤±è´¥', 'error');
            }
        }

        function startCodeCountdown() {
            codeCountdown = 60;
            const btn = document.querySelector('.send-code-btn');
            btn.disabled = true;

            codeTimer = setInterval(() => {
                codeCountdown--;
                btn.textContent = `${codeCountdown}ç§’åé‡è¯•`;

                if (codeCountdown <= 0) {
                    clearInterval(codeTimer);
                    btn.disabled = false;
                    btn.textContent = 'å‘é€éªŒè¯ç ';
                }
            }, 1000);
        }

        function handleLogout() {
            if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
                // æ¸…ç†æ‰€æœ‰å­˜å‚¨çš„ç™»å½•ä¿¡æ¯
                localStorage.removeItem('heartland_token');
                localStorage.removeItem('heartland_user');
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                currentUser = null;
                window.location.href = 'student-login.html';
            }
        }

        // ================ é¡µé¢åˆ‡æ¢ ================
        function showAuth() {
            document.getElementById('auth-page').style.display = 'flex';
            document.getElementById('app-container').classList.remove('active');
        }

        function showApp() {
            document.getElementById('auth-page').style.display = 'none';
            document.getElementById('app-container').classList.add('active');

            // æ›´æ–°ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤º
            if (currentUser) {
                document.getElementById('user-name').textContent = currentUser.username;
                document.getElementById('user-avatar').textContent = currentUser.username.charAt(0).toUpperCase();

                // æ›´æ–°ç»Ÿè®¡æ•°æ®
                document.getElementById('stat-points').textContent = currentUser.points || 0;
                // å…¶ä»–ç»Ÿè®¡æ•°æ®å¯ä»¥ä» API è·å–
            }
        }

        function switchPage(page) {
            // åˆ‡æ¢å¯¼èˆªé«˜äº®
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            event.target.closest('.nav-item').classList.add('active');

            // åˆ‡æ¢é¡µé¢å†…å®¹
            document.querySelectorAll('.page-section').forEach(section => section.classList.remove('active'));
            document.getElementById(`page-${page}`).classList.add('active');
        }

        // ================ Toast æç¤º ================
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'times-circle' : 'exclamation-circle'}"></i>
                <span>${message}</span>
            `;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // ================ é”™è¯¯å¤„ç† ================
        window.addEventListener('error', (event) => {
            console.error('å…¨å±€é”™è¯¯:', event.error);
            // ä¸æ˜¾ç¤º Toastï¼Œé¿å…å¹²æ‰°ç”¨æˆ·
        });

        window.addEventListener('unhandledrejection', (event) => {
            console.error('æœªå¤„ç†çš„ Promise é”™è¯¯:', event.reason);
            // ä¸æ˜¾ç¤º Toastï¼Œé¿å…å¹²æ‰°ç”¨æˆ·
        });
    </script>
</body>
</html>
















