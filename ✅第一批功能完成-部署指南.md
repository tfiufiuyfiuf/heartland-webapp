# ✅ 第一批功能完成 - 部署指南

## 已完成功能

### 1. ✅ 分院测试系统（完整实现）

**功能说明**：
- 注册后自动跳转到分院测试
- 15 道精心设计的题目
- 选项随机打乱
- 霍格沃茨风格UI
- 自动计算并分配学院

**文件**：
- `backend/config/sorting-schema.sql` - 数据库表和题目
- `backend/routes/sorting.js` - API接口
- `heartland-webapp/sorting-hat.html` - 前端页面

---

### 2. ✅ AI 助教接口（已预留）

**功能说明**：
- 学习助教（解答学习问题）
- 心理助教（心理健康支持+联网搜索）
- 预留国内 AI 接入接口

**API 端点**：
- `POST /api/ai/chat/learning` - 学习助教
- `POST /api/ai/chat/psychology` - 心理助教
- `GET /api/ai/history/:type` - 获取历史
- `DELETE /api/ai/history/:type` - 清空历史

**文件**：
- `backend/routes/ai.js` - AI 接口（含接入指南）

**支持的AI模型**：
- 通义千问（阿里云）- 推荐
- 文心一言（百度）
- 豆包（字节跳动）

---

## 部署步骤

### 步骤 1：在 Supabase 执行 SQL 脚本

1. 登录 https://supabase.com/dashboard
2. 进入项目 → SQL Editor
3. 点击 "New query"
4. 复制 `backend/config/sorting-schema.sql` 的内容
5. 粘贴并执行
6. 验证题目是否插入成功：
   ```sql
   SELECT COUNT(*) FROM sorting_questions;
   ```
   应该返回 15

---

### 步骤 2：提交代码到 GitHub

在终端运行：

```bash
cd "C:\Users\27867\Desktop\心屿1.0\backend"

# 添加所有修改
git add .

# 提交
git commit -m "feat: 添加分院测试系统和AI助教接口"

# 推送
git push origin main
```

---

### 步骤 3：Render 会自动部署

1. 推送后，Render 会自动检测到更新
2. 自动开始部署（等待 2-3 分钟）
3. 查看 Render Dashboard 中的部署日志
4. 确认部署成功

---

### 步骤 4：测试新功能

#### 测试分院测试

1. **访问前端**：https://heartland-webapp.vercel.app/index.html
2. **注册新账号**
3. **自动跳转到分院测试页面**
4. **完成 15 题测试**
5. **查看分配的学院**
6. **进入系统**

#### 测试 AI 助教（API）

在浏览器控制台运行：

```javascript
// 测试学习助教
fetch('https://heartland-backend.onrender.com/api/ai/chat/learning', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'Authorization': 'Bearer ' + localStorage.getItem('heartland_token')
  },
  body: JSON.stringify({
    message: '如何学好数学？'
  })
})
  .then(res => res.json())
  .then(data => console.log('学习助教:', data));

// 测试心理助教
fetch('https://heartland-backend.onrender.com/api/ai/chat/psychology', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'Authorization': 'Bearer ' + localStorage.getItem('heartland_token')
  },
  body: JSON.stringify({
    message: '我最近感到很焦虑',
    needSearch: true
  })
})
  .then(res => res.json())
  .then(data => console.log('心理助教:', data));
```

---

## 待完成功能（第二批）

### 高优先级
1. ⏳ 优化情绪追踪 UI 为笔记本样式
2. ⏳ 添加信息提醒区、设置区、个人中心
3. ⏳ 重构直播教室为主导布局 + 课程表

### 中优先级
4. ⏳ 优化自习室（简化界面）
5. ⏳ 优化呼吸训练视频

---

## AI 接入指南（待实际部署时完成）

### 通义千问（推荐）

1. **申请API**：
   - 访问：https://dashscope.console.aliyun.com/
   - 注册并创建应用
   - 获取 API Key

2. **安装 SDK**：
   ```bash
   cd backend
   npm install @alicloud/dashscope-sdk
   ```

3. **配置环境变量**（Render）：
   ```
   DASHSCOPE_API_KEY=您的API密钥
   ```

4. **修改代码**：
   在 `backend/routes/ai.js` 中实现实际的 AI 调用

---

### 文心一言

1. **申请API**：
   - 访问：https://cloud.baidu.com/product/wenxinworkshop
   - 创建应用获取 API Key 和 Secret Key

2. **安装 SDK**：
   ```bash
   npm install @baiducloud/qianfan
   ```

---

## 当前架构

```
前端（Vercel）
  ↓
后端 API（Render）
  ↓
数据库（Supabase）
  
待接入：
  ↓
AI 模型（通义千问/文心一言/豆包）
  ↓
搜索 API（用于心理助教）
```

---

## 费用估算

### 当前费用（免费层）
- ✅ Vercel：免费
- ✅ Render：免费（可能有休眠）
- ✅ Supabase：免费（2GB 存储）

### 添加 AI 后预计费用
- 通义千问：¥0.004/千tokens（约 ¥300-500/月）
- 文心一言：¥0.012/千tokens（约 ¥500-800/月）
- 豆包：价格类似

**建议**：先使用免费试用额度测试

---

## 快速检查清单

- [ ] Supabase 中已执行 sorting-schema.sql
- [ ] 代码已提交到 GitHub
- [ ] Render 已自动部署成功
- [ ] 测试注册功能正常
- [ ] 测试分院测试正常
- [ ] 用户成功分配学院
- [ ] AI 接口可以访问（返回演示数据）

---

## 下一步

1. **测试当前功能**
2. **确认分院测试工作正常**
3. **准备接入真实 AI（如需要）**
4. **继续实现第二批功能**

---

## 问题排查

### 问题 1：分院测试页面 404

**原因**：前端文件可能未同步到 Vercel

**解决**：
1. 确认 `sorting-hat.html` 已提交到 GitHub
2. Vercel 会自动部署
3. 等待 2-3 分钟后刷新

### 问题 2：分院测试 API 404

**原因**：后端路由未注册

**解决**：
1. 确认 `backend/server.js` 中已添加 sorting 路由
2. 确认 Render 已重新部署
3. 查看 Render 日志

### 问题 3：题目未显示

**原因**：数据库中没有题目

**解决**：
1. 在 Supabase SQL Editor 执行：
   ```sql
   SELECT COUNT(*) FROM sorting_questions;
   ```
2. 如果返回 0，重新执行 `sorting-schema.sql`

---

## 需要帮助？

如果遇到问题，请提供：
1. 具体的错误信息
2. 浏览器控制台的日志
3. Render 部署日志
4. 出错的步骤

我会继续协助解决！


