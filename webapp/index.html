<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>心屿学院 - 青少年心理健康学习平台</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@300;400;600;700&family=Nunito:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <!-- API配置和封装 -->
    <script src="frontend/config.js"></script>
    <script src="frontend/api.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Nunito', sans-serif;
            background: linear-gradient(180deg, #50A0D0 0%, #E0B040 50%, #D09030 100%);
            color: #333;
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        /* 插画风格背景层 */
        .illustration-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
            overflow: hidden;
        }

        /* 天空层 */
        .sky-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 60%;
            background: linear-gradient(180deg, #50A0D0 0%, #E0B040 30%);
            z-index: 1;
        }

        /* 云朵 */
        .cloud {
            position: absolute;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 50px;
            opacity: 0.7;
            animation: floatCloud 20s infinite ease-in-out;
        }

        .cloud:before,
        .cloud:after {
            content: '';
            position: absolute;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 50px;
        }

        .cloud:before {
            width: 50px;
            height: 50px;
            top: -25px;
            left: 10px;
        }

        .cloud:after {
            width: 60px;
            height: 60px;
            top: -35px;
            right: 10px;
        }

        .cloud1 {
            width: 80px;
            height: 40px;
            top: 10%;
            left: 10%;
            animation-duration: 25s;
        }

        .cloud2 {
            width: 100px;
            height: 50px;
            top: 20%;
            right: 15%;
            animation-duration: 30s;
            animation-delay: -5s;
        }

        .cloud3 {
            width: 70px;
            height: 35px;
            top: 15%;
            left: 50%;
            animation-duration: 22s;
            animation-delay: -10s;
        }

        @keyframes floatCloud {
            0%, 100% { transform: translateX(0) translateY(0); }
            50% { transform: translateX(30px) translateY(-10px); }
        }

        /* 草地层 */
        .grass-layer {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 40%;
            background: linear-gradient(180deg, #D09030 0%, #E0B040 50%, #8B9A5B 100%);
            z-index: 2;
        }

        /* 草地纹理 */
        .grass-blade {
            position: absolute;
            bottom: 0;
            width: 3px;
            background: linear-gradient(180deg, transparent 0%, #8B9A5B 50%, #6B7A4B 100%);
            border-radius: 2px;
            animation: sway 3s ease-in-out infinite;
        }

        @keyframes sway {
            0%, 100% { transform: rotate(-2deg); }
            50% { transform: rotate(2deg); }
        }

        /* 树木 */
        .tree {
            position: absolute;
            bottom: 0;
            z-index: 3;
        }

        .tree-trunk {
            width: 20px;
            height: 80px;
            background: #5D4037;
            margin: 0 auto;
            border-radius: 10px 10px 0 0;
        }

        .tree-crown {
            width: 0;
            height: 0;
            border-left: 40px solid transparent;
            border-right: 40px solid transparent;
            border-bottom: 60px solid #4A7C59;
            margin: -10px auto 0;
            position: relative;
            animation: treeSway 4s ease-in-out infinite;
        }

        .tree-crown:before {
            content: '';
            position: absolute;
            width: 0;
            height: 0;
            border-left: 35px solid transparent;
            border-right: 35px solid transparent;
            border-bottom: 50px solid #6B8E5A;
            top: 10px;
            left: -35px;
        }

        @keyframes treeSway {
            0%, 100% { transform: rotate(-1deg); }
            50% { transform: rotate(1deg); }
        }

        .tree-left {
            left: 5%;
            bottom: 10%;
        }

        .tree-right {
            right: 5%;
            bottom: 15%;
        }

        /* 小鸟 */
        .bird {
            position: absolute;
            width: 20px;
            height: 15px;
            background: #2C3E50;
            border-radius: 50% 0 50% 50%;
            z-index: 4;
            animation: fly 15s linear infinite;
        }

        .bird:before {
            content: '';
            position: absolute;
            width: 8px;
            height: 8px;
            background: #2C3E50;
            border-radius: 50% 0 50% 50%;
            top: -5px;
            left: 5px;
        }

        @keyframes fly {
            0% { transform: translateX(-50px) translateY(0); }
            50% { transform: translateX(calc(100vw + 50px)) translateY(-30px); }
            100% { transform: translateX(calc(100vw + 50px)) translateY(0); }
        }

        .app-container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.92);
            min-height: 100vh;
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.15);
            position: relative;
            z-index: 10;
            backdrop-filter: blur(10px);
        }

        /* 头部样式 - 插画风格 */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 2rem;
            background: linear-gradient(135deg, rgba(224, 176, 64, 0.95) 0%, rgba(208, 144, 48, 0.95) 100%);
            color: #333;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            border-bottom: 3px solid rgba(139, 154, 91, 0.3);
            position: relative;
            z-index: 100;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg width="100" height="100" xmlns="http://www.w3.org/2000/svg"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="rgba(0,0,0,0.05)"/><circle cx="75" cy="75" r="1" fill="rgba(0,0,0,0.05)"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
            opacity: 0.3;
            pointer-events: none;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            position: relative;
            z-index: 1;
        }

        .logo-icon {
            width: 45px;
            height: 45px;
            background: linear-gradient(135deg, #FF6B6B, #FF8E53);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.3rem;
            color: white;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
            animation: heartbeat 2s ease-in-out infinite;
        }

        @keyframes heartbeat {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .logo-text {
            font-family: 'Comfortaa', cursive;
            font-size: 1.6rem;
            font-weight: 700;
            color: #2C3E50;
            text-shadow: 2px 2px 4px rgba(255, 255, 255, 0.5);
        }

        .nav-links {
            display: flex;
            gap: 1.5rem;
            position: relative;
            z-index: 1;
        }

        .nav-link {
            color: #2C3E50;
            text-decoration: none;
            padding: 0.6rem 1.2rem;
            border-radius: 25px;
            transition: all 0.3s ease;
            font-family: 'Nunito', sans-serif;
            font-weight: 600;
            background: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(10px);
            border: 2px solid transparent;
        }

        .nav-link:hover, .nav-link.active {
            background: rgba(255, 255, 255, 0.9);
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            border-color: rgba(139, 154, 91, 0.5);
        }

        .house-badge {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255, 255, 255, 0.7);
            padding: 0.5rem 1rem;
            border-radius: 25px;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(139, 154, 91, 0.3);
            position: relative;
            z-index: 1;
        }

        .house-icon {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
        }

        .user-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .notification-icon, .settings-icon {
            position: relative;
            cursor: pointer;
            font-size: 1.2rem;
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #e74c3c;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            background: #3498db;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        /* 页面容器 */
        .page-container {
            display: none;
            padding: 2rem;
        }

        .page-container.active {
            display: block;
        }

        /* 学院积分板 */
        .house-points {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            border: 2px solid rgba(139, 154, 91, 0.2);
            backdrop-filter: blur(10px);
        }

        .points-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 1rem;
            font-family: 'Comfortaa', cursive;
            font-size: 1.2rem;
            color: #2C3E50;
        }

        .points-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .house-card {
            padding: 1rem;
            border-radius: 15px;
            text-align: center;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .house-card:hover {
            transform: translateY(-8px) scale(1.05);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .house-card.leading {
            border: 3px solid #FFD700;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.6);
            animation: glow 2s ease-in-out infinite;
        }

        @keyframes glow {
            0%, 100% { box-shadow: 0 0 20px rgba(255, 215, 0, 0.6); }
            50% { box-shadow: 0 0 30px rgba(255, 215, 0, 0.8); }
        }

        /* 全屏倒计时页面 */
        .timer-fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(255, 107, 107, 0.95), rgba(255, 142, 83, 0.95));
            z-index: 10000;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
        }

        .timer-fullscreen.active {
            display: flex;
        }

        .timer-close-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            background: rgba(255, 255, 255, 0.3);
            border: 2px solid rgba(255, 255, 255, 0.5);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.5rem;
            color: white;
            transition: all 0.3s ease;
            z-index: 10001;
        }

        .timer-close-btn:hover {
            background: rgba(255, 255, 255, 0.5);
            transform: scale(1.1);
        }

        .timer-display {
            text-align: center;
            color: white;
            margin-bottom: 2rem;
        }

        .timer-time {
            font-size: 8rem;
            font-family: 'Comfortaa', cursive;
            font-weight: 700;
            text-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
            margin-bottom: 1rem;
            animation: pulse 2s ease-in-out infinite;
        }

        .timer-label {
            font-size: 2rem;
            font-family: 'Nunito', sans-serif;
            opacity: 0.9;
            margin-bottom: 2rem;
        }

        .timer-progress {
            width: 300px;
            height: 10px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 2rem;
        }

        .timer-progress-bar {
            height: 100%;
            background: white;
            border-radius: 10px;
            transition: width 1s linear;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }

        .timer-encouragement {
            font-size: 1.5rem;
            font-family: 'Nunito', sans-serif;
            color: white;
            opacity: 0.8;
            text-align: center;
            max-width: 600px;
            padding: 0 2rem;
            line-height: 1.8;
        }

        /* 小动物装饰元素 */
        .cute-animal {
            position: fixed;
            pointer-events: none;
            z-index: 5;
            font-size: 2rem;
            animation: floatAnimal 6s ease-in-out infinite;
            opacity: 0.7;
        }

        @keyframes floatAnimal {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            25% { transform: translateY(-20px) rotate(5deg); }
            50% { transform: translateY(-10px) rotate(-5deg); }
            75% { transform: translateY(-15px) rotate(3deg); }
        }

        /* AI工具组件 */
        .ai-tools-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            border: 2px solid rgba(139, 154, 91, 0.2);
            backdrop-filter: blur(10px);
        }

        .ai-tools-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }

        .ai-tool-card {
            background: linear-gradient(135deg, rgba(255, 107, 107, 0.1), rgba(255, 142, 83, 0.1));
            padding: 1.5rem;
            border-radius: 15px;
            text-align: center;
            border: 2px solid rgba(255, 107, 107, 0.3);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .ai-tool-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(255, 107, 107, 0.3);
            border-color: rgba(255, 107, 107, 0.5);
        }

        .ai-tool-icon {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        /* 组队学习功能 */
        .team-study-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 2rem;
            margin-top: 2rem;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            border: 2px solid rgba(139, 154, 91, 0.2);
            backdrop-filter: blur(10px);
        }

        .team-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }

        .team-card {
            background: linear-gradient(135deg, rgba(224, 176, 64, 0.1), rgba(139, 154, 91, 0.1));
            padding: 1.5rem;
            border-radius: 15px;
            border: 2px solid rgba(139, 154, 91, 0.3);
            transition: all 0.3s ease;
        }

        .team-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        }

        .team-members {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .team-member-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: linear-gradient(135deg, #FF6B6B, #FF8E53);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        /* 预约模态框 */
        .appointment-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .appointment-modal.active {
            display: flex;
        }

        .appointment-container {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
        }

        .appointment-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        /* 正念练习和呼吸训练模态框 */
        .breathing-modal, .mindfulness-modal, .knowledge-modal, .daily-article-modal, .profile-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: flex-start;
            justify-content: center;
            z-index: 1000;
            overflow-y: auto;
            padding: 2rem 0;
        }

        .breathing-modal.active, .mindfulness-modal.active, .knowledge-modal.active, 
        .daily-article-modal.active, .profile-modal.active {
            display: flex;
        }

        .breathing-container, .mindfulness-container, .knowledge-container, 
        .daily-article-container, .profile-container {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
            margin: 2rem 0;
        }

        /* 呼吸训练动画 - 液态玻璃效果 */
        .breathing-circle {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.4), rgba(255, 255, 255, 0.1));
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.5);
            margin: 2rem auto;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #2C3E50;
            font-size: 1.5rem;
            font-weight: bold;
            box-shadow: 
                0 8px 32px rgba(31, 38, 135, 0.15),
                inset 0 0 20px rgba(255, 255, 255, 0.3),
                0 0 60px rgba(139, 154, 91, 0.2);
            position: relative;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .breathing-circle::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(
                45deg,
                rgba(255, 255, 255, 0.3) 0%,
                rgba(255, 255, 255, 0.1) 50%,
                rgba(255, 255, 255, 0.3) 100%
            );
            animation: shimmer 3s ease-in-out infinite;
        }

        @keyframes shimmer {
            0%, 100% { transform: rotate(0deg); opacity: 0.5; }
            50% { transform: rotate(180deg); opacity: 0.8; }
        }

        .breathing-circle.breathing-in {
            animation: breatheIn 4s ease-in-out forwards;
        }

        .breathing-circle.breathing-out {
            animation: breatheOut 4s ease-in-out forwards;
        }

        .breathing-circle.breathing-hold {
            animation: none;
            transform: scale(1.5);
        }

        @keyframes breatheIn {
            0% { 
                transform: scale(1); 
                box-shadow: 0 8px 32px rgba(31, 38, 135, 0.15), inset 0 0 20px rgba(255, 255, 255, 0.3), 0 0 60px rgba(139, 154, 91, 0.2);
            }
            100% { 
                transform: scale(1.5); 
                box-shadow: 0 12px 48px rgba(31, 38, 135, 0.25), inset 0 0 30px rgba(255, 255, 255, 0.4), 0 0 80px rgba(139, 154, 91, 0.4);
            }
        }

        @keyframes breatheOut {
            0% { 
                transform: scale(1.5); 
                box-shadow: 0 12px 48px rgba(31, 38, 135, 0.25), inset 0 0 30px rgba(255, 255, 255, 0.4), 0 0 80px rgba(139, 154, 91, 0.4);
            }
            100% { 
                transform: scale(1); 
                box-shadow: 0 8px 32px rgba(31, 38, 135, 0.15), inset 0 0 20px rgba(255, 255, 255, 0.3), 0 0 60px rgba(139, 154, 91, 0.2);
            }
        }

        /* 呼吸训练界面美化 */
        .breathing-container {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.98), rgba(255, 248, 240, 0.98)) !important;
            position: relative;
            overflow-y: auto !important;
        }

        .breathing-container::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 107, 107, 0.05) 0%, transparent 70%);
            animation: gentlePulse 8s ease-in-out infinite;
            pointer-events: none;
        }

        @keyframes gentlePulse {
            0%, 100% { transform: scale(1) rotate(0deg); opacity: 0.5; }
            50% { transform: scale(1.1) rotate(180deg); opacity: 0.8; }
        }

        /* 音乐控制 */
        .music-control {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.8rem 1.2rem;
            background: rgba(255, 107, 107, 0.1);
            border-radius: 25px;
            border: 2px solid rgba(255, 107, 107, 0.3);
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 1rem auto;
            width: fit-content;
        }

        .music-control:hover {
            background: rgba(255, 107, 107, 0.2);
            border-color: rgba(255, 107, 107, 0.5);
        }

        .music-control.active {
            background: rgba(255, 107, 107, 0.3);
        }

        /* 正念练习界面美化 */
        .mindfulness-container {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.98), rgba(240, 248, 255, 0.98)) !important;
            position: relative;
            overflow-y: auto !important;
        }

        .mindfulness-container::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(139, 154, 91, 0.05) 0%, transparent 70%);
            animation: gentlePulse 10s ease-in-out infinite;
            pointer-events: none;
        }

        .mindfulness-step {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(255, 248, 240, 0.9)) !important;
            border-left: 4px solid #FF6B6B !important;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08) !important;
        }

        .breathing-instruction {
            text-align: center;
            font-size: 1.5rem;
            color: #2C3E50;
            margin: 1rem 0;
            font-family: 'Nunito', sans-serif;
        }

        .breathing-controls {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 2rem;
        }

        /* 正念练习引导 */
        .mindfulness-step {
            background: rgba(255, 107, 107, 0.1);
            padding: 1.5rem;
            border-radius: 15px;
            margin-bottom: 1rem;
            border-left: 4px solid #FF6B6B;
        }

        .mindfulness-step h4 {
            color: #2C3E50;
            margin-bottom: 0.5rem;
            font-family: 'Comfortaa', cursive;
        }

        .mindfulness-timer {
            font-size: 3rem;
            text-align: center;
            color: #FF6B6B;
            font-weight: bold;
            margin: 2rem 0;
            font-family: 'Comfortaa', cursive;
        }

        /* 心理学知识库 */
        .knowledge-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }

        .knowledge-card {
            background: linear-gradient(135deg, rgba(255, 107, 107, 0.1), rgba(255, 142, 83, 0.1));
            padding: 1.5rem;
            border-radius: 15px;
            border: 2px solid rgba(255, 107, 107, 0.3);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .knowledge-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(255, 107, 107, 0.3);
        }

        .knowledge-card h4 {
            color: #2C3E50;
            margin-bottom: 0.5rem;
            font-family: 'Comfortaa', cursive;
        }

        .knowledge-card p {
            color: #666;
            font-size: 0.9rem;
        }

        /* 每日文章 */
        .daily-article-content {
            line-height: 1.8;
            color: #333;
            font-size: 1.1rem;
        }

        .daily-article-content h3 {
            color: #2C3E50;
            margin-bottom: 1rem;
            font-family: 'Comfortaa', cursive;
        }

        .daily-article-content p {
            margin-bottom: 1rem;
        }

        /* 个人信息设置 */
        .profile-avatar-selector {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 1rem;
            margin: 1.5rem 0;
        }
        
        /* 开关按钮样式 */
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 26px;
        }
        
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 26px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: #4CAF50;
        }
        
        input:disabled + .slider {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        input:checked + .slider:before {
            transform: translateX(24px);
        }

        .avatar-option {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .avatar-option:hover {
            transform: scale(1.1);
        }

        .avatar-option.selected {
            border-color: #FF6B6B;
            box-shadow: 0 0 15px rgba(255, 107, 107, 0.5);
        }

        .profile-form-group {
            margin-bottom: 1.5rem;
        }

        .profile-form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #2C3E50;
            font-weight: 600;
            font-family: 'Comfortaa', cursive;
        }

        .profile-form-group input {
            width: 100%;
            padding: 0.8rem;
            border: 2px solid rgba(139, 154, 91, 0.3);
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .profile-form-group input:focus {
            outline: none;
            border-color: #FF6B6B;
        }

        /* 同学交流系统样式 */
        .chat-header-actions {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .friend-list, .group-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .friend-item, .group-item {
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .friend-item:hover, .group-item:hover {
            background: rgba(255, 107, 107, 0.1);
        }

        .friend-avatar, .group-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: linear-gradient(135deg, #FF6B6B, #FF8E53);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.2rem;
        }

        .friend-info, .group-info {
            flex: 1;
        }

        .friend-name, .group-name {
            font-weight: 600;
            color: #2C3E50;
            margin-bottom: 0.2rem;
        }

        .friend-status, .group-members {
            font-size: 0.85rem;
            color: #666;
        }

        .chat-input-area {
            display: flex;
            gap: 0.5rem;
            align-items: flex-end;
        }

        .chat-input-area input {
            flex: 1;
        }

        .file-upload-btn {
            padding: 0.8rem;
            background: rgba(139, 154, 91, 0.1);
            border: 2px solid rgba(139, 154, 91, 0.3);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .file-upload-btn:hover {
            background: rgba(139, 154, 91, 0.2);
        }

        /* 学习小组自习界面 */
        .study-session-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(255, 248, 240, 0.98), rgba(240, 248, 255, 0.98));
            z-index: 10000;
            display: none;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .study-session-container.active {
            display: block;
        }

        .study-session-header {
            background: rgba(255, 255, 255, 0.95);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            border-bottom: 2px solid rgba(139, 154, 91, 0.2);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .study-members-display {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .study-member-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #FF6B6B, #FF8E53);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            border: 2px solid white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        .study-timer-display {
            font-size: 1.5rem;
            font-weight: bold;
            color: #2C3E50;
            font-family: 'Comfortaa', cursive;
        }

        .study-session-main {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            padding: 1rem;
            padding-bottom: 5rem;
            min-height: calc(100vh - 100px);
            max-width: 1200px;
            margin: 0 auto;
        }

        .study-content-area {
            background: rgba(255, 255, 255, 0.7);
            border-radius: 20px;
            padding: 2rem;
            position: relative;
            min-height: 800px;
        }
        
        /* 摄像头监督区域 */
        .camera-supervision {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 1.5rem;
            margin-top: 2rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        .camera-preview {
            width: 100%;
            max-width: 400px;
            height: 300px;
            background: #000;
            border-radius: 10px;
            margin: 1rem auto;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1rem;
            position: relative;
            overflow: hidden;
        }
        
        #camera-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }
        
        .camera-preview video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 10px;
        }
        
        .camera-controls {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        .healing-image-carousel {
            width: 100%;
            height: 400px;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 2rem;
            position: relative;
        }

        .carousel-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: none;
            animation: fadeIn 1s ease-in-out;
        }

        .carousel-image.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .study-sidebar {
            background: rgba(255, 255, 255, 0.7);
            border-radius: 20px;
            padding: 1.5rem;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            align-items: start;
        }

        .study-controls {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .study-status {
            padding: 1rem;
            background: rgba(255, 107, 107, 0.1);
            border-radius: 15px;
            text-align: center;
        }

        .study-status.studying {
            background: rgba(139, 154, 91, 0.1);
        }

        .study-status.resting {
            background: rgba(255, 142, 83, 0.1);
        }

        .study-chat-area {
            display: flex;
            flex-direction: column;
        }

        .study-chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 10px;
            margin-bottom: 1rem;
            max-height: 300px;
        }

        .study-chat-disabled {
            text-align: center;
            color: #999;
            padding: 2rem;
            font-style: italic;
        }

        .gryffindor { background: linear-gradient(135deg, #740001, #ae0001); color: white; }
        .slytherin { background: linear-gradient(135deg, #1a472a, #2a623d); color: white; }
        .ravenclaw { background: linear-gradient(135deg, #0e1a40, #222f5b); color: white; }
        .hufflepuff { background: linear-gradient(135deg, #ffdb00, #ffed4e); color: #333; }

        .house-name {
            font-family: 'Comfortaa', cursive;
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
        }

        .house-points-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        /* 欢迎区域 */
        .welcome-section {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .welcome-card {
            background: linear-gradient(135deg, rgba(255, 107, 107, 0.9), rgba(255, 142, 83, 0.9));
            color: white;
            border-radius: 20px;
            padding: 2rem;
            display: flex;
            align-items: center;
            gap: 1.5rem;
            box-shadow: 0 10px 30px rgba(255, 107, 107, 0.3);
            border: 3px solid rgba(255, 255, 255, 0.3);
            position: relative;
            overflow: hidden;
        }

        .welcome-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
            animation: shimmer 3s ease-in-out infinite;
        }

        @keyframes shimmer {
            0%, 100% { transform: rotate(0deg); }
            50% { transform: rotate(180deg); }
        }

        .welcome-avatar {
            width: 80px;
            height: 80px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
        }

        .welcome-text h2 {
            font-family: 'Comfortaa', cursive;
            margin-bottom: 0.5rem;
        }

        .motivation-text {
            font-style: italic;
            margin-top: 1rem;
            opacity: 0.9;
        }

        .today-overview {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 1.5rem;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            border: 2px solid rgba(139, 154, 91, 0.2);
            backdrop-filter: blur(10px);
        }

        .overview-title {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 1rem;
            font-family: 'Comfortaa', cursive;
            color: #2C3E50;
        }

        .overview-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .overview-item {
            text-align: center;
            padding: 1rem;
            background: linear-gradient(135deg, rgba(224, 176, 64, 0.2), rgba(139, 154, 91, 0.2));
            border-radius: 15px;
            border: 2px solid rgba(139, 154, 91, 0.3);
            transition: all 0.3s ease;
        }

        .overview-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            background: linear-gradient(135deg, rgba(224, 176, 64, 0.3), rgba(139, 154, 91, 0.3));
        }

        .overview-value {
            font-size: 2rem;
            font-weight: bold;
            background: linear-gradient(135deg, #FF6B6B, #FF8E53);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
        }

        /* 主要内容区域 */
        .main-content {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 2rem;
        }

        .live-class-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            border: 2px solid rgba(139, 154, 91, 0.2);
            backdrop-filter: blur(10px);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            background: linear-gradient(135deg, rgba(255, 107, 107, 0.9), rgba(255, 142, 83, 0.9));
            color: white;
            position: relative;
            overflow: hidden;
        }

        .card-header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
            animation: shimmer 3s ease-in-out infinite;
        }

        .card-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-family: 'Comfortaa', cursive;
            font-size: 1.2rem;
        }

        .live-status {
            background: #e74c3c;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .class-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1.5rem;
            border-bottom: 1px solid #eee;
        }

        .class-icon {
            width: 60px;
            height: 60px;
            background: #ffeaa7;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: #e17055;
        }

        .class-details {
            flex: 1;
        }

        .class-name {
            font-family: 'Comfortaa', cursive;
            font-size: 1.3rem;
            margin-bottom: 0.5rem;
        }

        .class-teacher, .class-time {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #666;
            margin-bottom: 0.3rem;
        }

        .video-container {
            padding: 2rem;
            background: #f8f9fa;
            text-align: center;
        }

        .video-placeholder {
            background: white;
            border: 2px dashed #ddd;
            border-radius: 10px;
            padding: 3rem 2rem;
        }

        .video-icon {
            font-size: 3rem;
            color: #667eea;
            margin-bottom: 1rem;
        }

        .class-controls {
            display: flex;
            gap: 1rem;
            padding: 1.5rem;
            background: #f8f9fa;
        }

        .btn {
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-family: 'Nunito', sans-serif;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #FF6B6B, #FF8E53);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .btn-ai {
            background: linear-gradient(135deg, #4ECDC4, #44A08D);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .btn-outline {
            background: rgba(255, 255, 255, 0.8);
            border: 2px solid #8B9A5B;
            color: #8B9A5B;
            backdrop-filter: blur(10px);
        }

        .btn:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        /* 认证模态框 */
        .auth-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .auth-container {
            background: white;
            border-radius: 15px;
            width: 400px;
            max-width: 90%;
            overflow: hidden;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
        }

        .auth-header {
            background: linear-gradient(135deg, rgba(255, 107, 107, 0.9), rgba(255, 142, 83, 0.9));
            color: white;
            padding: 2rem;
            text-align: center;
            font-family: 'Comfortaa', cursive;
            font-size: 1.5rem;
        }

        .auth-tabs {
            display: flex;
            background: #f8f9fa;
        }

        .auth-tab {
            flex: 1;
            text-align: center;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .auth-tab.active {
            background: white;
            font-weight: bold;
            color: #667eea;
        }

        .auth-form {
            padding: 2rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            color: #333;
            font-weight: 500;
        }

        .form-input {
            width: 100%;
            padding: 0.8rem 1rem;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
        }

        .form-submit {
            width: 100%;
            padding: 1rem;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .form-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .form-footer {
            text-align: center;
            margin-top: 1.5rem;
            color: #666;
        }

        .form-footer a {
            color: #667eea;
            text-decoration: none;
        }

        /* 验证码输入组样式 */
        .code-input-group {
            display: flex;
            gap: 10px;
            align-items: stretch;
        }

        .code-input-group .form-input {
            flex: 1;
            min-width: 0;
        }

        .btn-code {
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 0 15px;
            cursor: pointer;
            font-size: 0.9rem;
            white-space: nowrap;
            transition: all 0.3s ease;
            min-width: 100px;
        }

        .btn-code:hover {
            background: #5a6fd8;
            transform: translateY(-1px);
        }

        .btn-code:disabled {
            background: #cccccc;
            cursor: not-allowed;
            transform: none;
        }

        /* 表单验证样式 */
        .form-input:invalid {
            border-color: #ff6b6b;
        }

        .form-input:valid {
            border-color: #51cf66;
        }

        .error-message {
            color: #ff6b6b;
            font-size: 0.8rem;
            margin-top: 5px;
            display: none;
        }

        /* 霍格沃茨分院测试模态框样式 */
        .sorting-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1001;
            overflow-y: auto;
            padding: 2rem 0;
        }

        .sorting-modal.active {
            display: flex;
        }

        .sorting-container {
            background: white;
            border-radius: 20px;
            width: 700px;
            max-width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
            animation: sortingAppear 0.5s ease;
        }

        @keyframes sortingAppear {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .sorting-header {
            background: linear-gradient(135deg, #2C3E50, #34495e);
            color: white;
            padding: 2rem;
            text-align: center;
            border-radius: 20px 20px 0 0;
        }

        .sorting-header h2 {
            font-family: 'Comfortaa', cursive;
            font-size: 1.8rem;
            margin-bottom: 0.5rem;
        }

        .sorting-header p {
            opacity: 0.9;
            font-size: 1rem;
        }

        .sorting-content {
            padding: 2rem;
        }

        .sorting-hat-animation {
            font-size: 5rem;
            text-align: center;
            margin-bottom: 1rem;
            animation: hatFloat 3s ease-in-out infinite;
        }

        @keyframes hatFloat {
            0%, 100% { transform: translateY(0) rotate(-5deg); }
            50% { transform: translateY(-10px) rotate(5deg); }
        }

        .sorting-welcome h3 {
            font-family: 'Comfortaa', cursive;
            color: #2C3E50;
            text-align: center;
            margin-bottom: 1rem;
            font-size: 1.5rem;
        }

        .sorting-welcome > p {
            text-align: center;
            color: #666;
            margin-bottom: 2rem;
            line-height: 1.6;
        }

        .houses-preview {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin: 2rem 0;
        }

        .house-preview {
            border: 2px solid;
            border-radius: 15px;
            padding: 1.5rem;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .house-preview:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }

        .house-preview .house-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            margin: 0 auto 0.5rem;
        }

        .house-preview span {
            font-weight: 600;
            color: #2C3E50;
        }

        .sorting-start-btn {
            width: 100%;
            padding: 1.2rem;
            font-size: 1.1rem;
        }

        .question-progress {
            margin-bottom: 2rem;
        }

        .progress-bar {
            background: #e0e0e0;
            height: 8px;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 0.5rem;
        }

        .progress-fill {
            background: linear-gradient(90deg, #667eea, #764ba2);
            height: 100%;
            transition: width 0.3s ease;
            border-radius: 10px;
        }

        .progress-text {
            display: block;
            text-align: right;
            color: #666;
            font-size: 0.9rem;
        }

        .question-content {
            margin-bottom: 2rem;
        }

        .question-title {
            font-family: 'Comfortaa', cursive;
            color: #2C3E50;
            font-size: 1.3rem;
            margin-bottom: 1.5rem;
            line-height: 1.6;
        }

        .question-options {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .option-btn {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 1.2rem;
            text-align: left;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
            color: #333;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .option-btn:hover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.05);
            transform: translateX(5px);
        }

        .option-btn.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
        }

        .option-number {
            background: #667eea;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            flex-shrink: 0;
        }

        .sorting-navigation {
            display: flex;
            gap: 1rem;
            justify-content: space-between;
        }

        .result-hat-animation {
            font-size: 4rem;
            text-align: center;
            margin-bottom: 1rem;
            animation: resultCelebration 1s ease-in-out;
        }

        @keyframes resultCelebration {
            0%, 100% { transform: scale(1); }
            25% { transform: scale(1.2) rotate(-10deg); }
            50% { transform: scale(0.9) rotate(10deg); }
            75% { transform: scale(1.1) rotate(-5deg); }
        }

        .sorting-result h3 {
            font-family: 'Comfortaa', cursive;
            color: #2C3E50;
            text-align: center;
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .result-house {
            text-align: center;
            margin: 2rem 0;
            padding: 2rem;
            border-radius: 15px;
            animation: houseReveal 0.8s ease 0.5s both;
        }

        @keyframes houseReveal {
            from {
                opacity: 0;
                transform: scale(0.5);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .result-house .house-badge-large {
            font-size: 4rem;
            margin-bottom: 1rem;
        }

        .result-house .house-name {
            font-family: 'Comfortaa', cursive;
            font-size: 2rem;
            font-weight: bold;
            color: white;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .result-description {
            text-align: center;
            color: #666;
            line-height: 1.8;
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: rgba(0, 0, 0, 0.03);
            border-radius: 12px;
        }

        /* 匿名树洞和同伴支持模态框样式 */
        .tree-hole-modal, .peer-support-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: flex-start;
            justify-content: center;
            z-index: 1000;
            overflow-y: auto;
            padding: 2rem 0;
        }

        .tree-hole-modal.active, .peer-support-modal.active {
            display: flex;
        }

        .tree-hole-container, .peer-support-container {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
            margin: 2rem 0;
        }

        .tree-hole-notice, .peer-support-notice {
            background: linear-gradient(135deg, rgba(116, 185, 255, 0.1), rgba(85, 239, 196, 0.1));
            border-left: 4px solid #74b9ff;
            padding: 1rem;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .tree-hole-notice i, .peer-support-notice i {
            font-size: 1.5rem;
            color: #74b9ff;
        }

        .tree-hole-notice p, .peer-support-notice p {
            margin: 0;
            color: #666;
            line-height: 1.6;
        }

        .tree-hole-tabs, .peer-support-tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid #e0e0e0;
        }

        .tree-hole-tab, .peer-support-tab {
            background: none;
            border: none;
            padding: 1rem 1.5rem;
            cursor: pointer;
            color: #666;
            font-size: 1rem;
            transition: all 0.3s ease;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .tree-hole-tab.active, .peer-support-tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
            font-weight: 600;
        }

        .tree-hole-tab-content, .peer-support-tab-content {
            display: none;
        }

        .tree-hole-tab-content.active, .peer-support-tab-content.active {
            display: block;
        }

        .tree-hole-textarea {
            width: 100%;
            min-height: 150px;
            padding: 1rem;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 1rem;
            font-family: 'Nunito', sans-serif;
            resize: vertical;
            transition: border-color 0.3s ease;
        }

        .tree-hole-textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .char-count {
            text-align: right;
            color: #999;
            font-size: 0.85rem;
            margin-top: 0.5rem;
        }

        .tree-hole-filter {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .tree-hole-filter label {
            font-weight: 600;
            color: #2C3E50;
            white-space: nowrap;
        }

        .tree-hole-posts {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            max-height: 500px;
            overflow-y: auto;
        }

        .tree-hole-post-item {
            background: rgba(0, 0, 0, 0.02);
            border-radius: 12px;
            padding: 1.5rem;
            border-left: 4px solid #74b9ff;
            transition: all 0.3s ease;
        }

        .tree-hole-post-item:hover {
            background: rgba(0, 0, 0, 0.04);
            transform: translateX(5px);
        }

        .tree-hole-post-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .tree-hole-post-category {
            display: inline-block;
            background: #74b9ff;
            color: white;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.85rem;
        }

        .tree-hole-post-time {
            color: #999;
            font-size: 0.85rem;
        }

        .tree-hole-post-content {
            color: #333;
            line-height: 1.8;
            margin-bottom: 1rem;
        }

        .tree-hole-post-actions {
            display: flex;
            gap: 1rem;
        }

        .tree-hole-action-btn {
            background: none;
            border: none;
            color: #999;
            cursor: pointer;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
        }

        .tree-hole-action-btn:hover {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
        }

        .tree-hole-action-btn.active {
            color: #667eea;
        }

        .peer-match-form label {
            display: block;
            margin-bottom: 0.5rem;
            color: #2C3E50;
            font-weight: 600;
        }

        .peer-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }

        .peer-card:hover {
            border-color: #667eea;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
            transform: translateY(-3px);
        }

        .peer-card-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .peer-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
        }

        .peer-info {
            flex: 1;
        }

        .peer-name {
            font-weight: 600;
            color: #2C3E50;
            margin-bottom: 0.3rem;
        }

        .peer-match-score {
            color: #51cf66;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .peer-concerns {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .peer-concern-tag {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
            padding: 0.3rem 0.8rem;
            border-radius: 15px;
            font-size: 0.85rem;
        }

        .peer-about {
            color: #666;
            line-height: 1.6;
            margin-bottom: 1rem;
            font-size: 0.95rem;
        }

        .peer-actions {
            display: flex;
            gap: 0.5rem;
        }

        /* 图书馆模态框样式 */
        .library-modal, .book-detail-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: flex-start;
            justify-content: center;
            z-index: 1000;
            overflow-y: auto;
            padding: 2rem 0;
        }

        .library-modal.active, .book-detail-modal.active {
            display: flex;
        }

        .library-container {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            max-width: 1000px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
            margin: 2rem 0;
        }

        .book-detail-container {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            max-width: 700px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
            margin: 2rem 0;
            position: relative;
        }

        /* 积分显示 */
        .library-points-display {
            background: linear-gradient(135deg, #ffd93d 0%, #ffaa00 100%);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 15px;
            display: flex;
            align-items: center;
            gap: 0.8rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 15px rgba(255, 170, 0, 0.3);
        }

        .library-points-display i {
            font-size: 1.5rem;
        }

        .library-points-display strong {
            font-size: 1.3rem;
            font-weight: 700;
        }

        /* 轮播海报容器 */
        .library-banner-container {
            position: relative;
            width: 100%;
            height: 280px;
            margin-bottom: 2rem;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .library-banner-slider {
            display: flex;
            transition: transform 0.5s ease-in-out;
            height: 100%;
        }

        .library-banner-item {
            min-width: 100%;
            height: 100%;
            position: relative;
            cursor: pointer;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            padding: 2rem;
            gap: 2rem;
        }

        .library-banner-image {
            width: 180px;
            height: 240px;
            border-radius: 10px;
            object-fit: cover;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            color: rgba(255, 255, 255, 0.8);
        }

        .library-banner-content {
            flex: 1;
            color: white;
        }

        .library-banner-title {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 0.8rem;
            font-family: 'Comfortaa', cursive;
        }

        .library-banner-author {
            font-size: 1.1rem;
            margin-bottom: 1rem;
            opacity: 0.9;
        }

        .library-banner-description {
            font-size: 1rem;
            line-height: 1.6;
            margin-bottom: 1rem;
            opacity: 0.95;
        }

        .library-banner-reason {
            background: rgba(255, 255, 255, 0.2);
            padding: 1rem;
            border-radius: 10px;
            border-left: 4px solid rgba(255, 255, 255, 0.8);
            font-size: 0.95rem;
            line-height: 1.6;
        }

        .library-banner-prev,
        .library-banner-next {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.9);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: #333;
            transition: all 0.3s ease;
            z-index: 10;
        }

        .library-banner-prev:hover,
        .library-banner-next:hover {
            background: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .library-banner-prev {
            left: 1rem;
        }

        .library-banner-next {
            right: 1rem;
        }

        .library-banner-dots {
            position: absolute;
            bottom: 1rem;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 0.5rem;
            z-index: 10;
        }

        .library-banner-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.5);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .library-banner-dot.active {
            background: white;
            width: 30px;
            border-radius: 5px;
        }

        /* 图书分类标签 */
        .library-tabs {
            display: flex;
            gap: 0.8rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .library-tab {
            background: rgba(102, 126, 234, 0.1);
            border: 2px solid transparent;
            padding: 0.7rem 1.2rem;
            border-radius: 25px;
            cursor: pointer;
            color: #667eea;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 500;
        }

        .library-tab:hover {
            background: rgba(102, 126, 234, 0.2);
            transform: translateY(-2px);
        }

        .library-tab.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        /* 图书网格 */
        .library-books-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }

        .library-book-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            padding: 1.2rem;
            transition: all 0.3s ease;
            cursor: pointer;
            display: flex;
            flex-direction: column;
        }

        .library-book-card:hover {
            border-color: #667eea;
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.2);
            transform: translateY(-5px);
        }

        .library-book-cover {
            width: 100%;
            height: 200px;
            border-radius: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            color: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .library-book-title {
            font-size: 1rem;
            font-weight: 600;
            color: #2C3E50;
            margin-bottom: 0.5rem;
            line-height: 1.4;
            min-height: 2.8rem;
        }

        .library-book-author {
            font-size: 0.85rem;
            color: #999;
            margin-bottom: 0.8rem;
        }

        .library-book-price {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: auto;
            padding-top: 0.8rem;
            border-top: 1px solid #e0e0e0;
        }

        .library-book-price.free {
            color: #51cf66;
            font-weight: 600;
        }

        .library-book-price.points {
            color: #ff9800;
            font-weight: 600;
        }

        .library-book-price i {
            font-size: 1.1rem;
        }

        /* 图书详情样式 */
        .book-detail-header {
            display: flex;
            gap: 2rem;
            margin-bottom: 2rem;
            padding-bottom: 2rem;
            border-bottom: 2px solid #e0e0e0;
        }

        .book-detail-cover {
            width: 180px;
            height: 240px;
            border-radius: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 4rem;
            color: white;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
            flex-shrink: 0;
        }

        .book-detail-info {
            flex: 1;
        }

        .book-detail-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: #2C3E50;
            margin-bottom: 0.8rem;
            font-family: 'Comfortaa', cursive;
        }

        .book-detail-author {
            font-size: 1.1rem;
            color: #666;
            margin-bottom: 1rem;
        }

        .book-detail-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .book-detail-meta-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #666;
            font-size: 0.95rem;
        }

        .book-detail-meta-item i {
            color: #667eea;
        }

        .book-detail-section {
            margin-bottom: 2rem;
        }

        .book-detail-section h3 {
            font-size: 1.3rem;
            color: #2C3E50;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .book-detail-section h3 i {
            color: #667eea;
        }

        .book-detail-description {
            color: #666;
            line-height: 1.8;
            margin-bottom: 1rem;
        }

        .book-detail-reason {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            padding: 1.5rem;
            border-radius: 12px;
            border-left: 4px solid #667eea;
            color: #333;
            line-height: 1.8;
        }

        .book-detail-actions {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
        }

        .book-detail-actions .btn {
            flex: 1;
        }

        /* 角色切换器样式 */
        .role-switcher {
            position: relative;
            margin-right: 1rem;
        }

        .role-button {
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid #8B9A5B;
            border-radius: 25px;
            padding: 0.5rem 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            color: #2C3E50;
        }

        .role-button:hover {
            background: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .role-dropdown {
            position: absolute;
            top: calc(100% + 0.5rem);
            left: 0;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            min-width: 150px;
            display: none;
            z-index: 1000;
            overflow: hidden;
        }

        .role-dropdown.active {
            display: block;
            animation: dropdownAppear 0.3s ease;
        }

        @keyframes dropdownAppear {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .role-option {
            padding: 0.8rem 1rem;
            display: flex;
            align-items: center;
            gap: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
            color: #2C3E50;
        }

        .role-option:hover {
            background: rgba(139, 154, 91, 0.1);
        }

        .role-option.active {
            background: rgba(139, 154, 91, 0.2);
            font-weight: 600;
        }

        /* 家长端样式 */
        .parent-dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            padding: 2rem 0;
        }

        .parent-card {
            background: white;
            border-radius: 20px;
            padding: 1.5rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .parent-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .parent-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #f0f0f0;
        }

        .parent-card-header h3 {
            font-family: 'Comfortaa', cursive;
            color: #2C3E50;
            font-size: 1.2rem;
        }

        .update-time {
            font-size: 0.85rem;
            color: #999;
        }

        .report-summary {
            display: grid;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .report-item {
            padding: 1rem;
            background: rgba(139, 154, 91, 0.05);
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .report-label {
            color: #666;
            font-weight: 500;
        }

        .report-value {
            font-size: 1.1rem;
            font-weight: 600;
            color: #2C3E50;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .trend {
            font-size: 0.9rem;
            font-weight: 600;
        }

        .trend.up {
            color: #51cf66;
        }

        .trend.down {
            color: #ff6b6b;
        }

        .communication-tips, .safety-settings {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .tip-item, .setting-item {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            padding: 1rem;
            background: rgba(0, 0, 0, 0.02);
            border-radius: 10px;
        }

        .tip-item i {
            font-size: 1.5rem;
            color: #667eea;
            margin-top: 0.2rem;
        }

        .tip-item h4 {
            margin-bottom: 0.3rem;
            color: #2C3E50;
        }

        .tip-item p {
            color: #666;
            font-size: 0.95rem;
            line-height: 1.6;
        }

        .setting-item {
            justify-content: space-between;
        }

        .setting-info {
            display: flex;
            align-items: center;
            gap: 0.8rem;
        }

        .setting-info i {
            color: #667eea;
        }

        .setting-value {
            font-weight: 600;
            color: #51cf66;
        }

        /* 教师端样式 */
        .teacher-dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            padding: 2rem 0;
        }

        .teacher-card {
            background: white;
            border-radius: 20px;
            padding: 1.5rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .teacher-card.full-width {
            grid-column: 1 / -1;
        }

        .teacher-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .teacher-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #f0f0f0;
        }

        .teacher-card-header h3 {
            font-family: 'Comfortaa', cursive;
            color: #2C3E50;
            font-size: 1.2rem;
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
        }

        .guidance-stats {
            display: flex;
            gap: 2rem;
            justify-content: center;
            margin: 1.5rem 0;
        }

        .stat-item {
            text-align: center;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 0.3rem;
        }

        .stat-label {
            color: #666;
            font-size: 0.9rem;
        }

        .analysis-preview {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 150px;
            margin-bottom: 1rem;
            background: rgba(0, 0, 0, 0.02);
            border-radius: 10px;
        }

        .class-list, .student-activities {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .class-item {
            padding: 1rem;
            background: rgba(139, 154, 91, 0.05);
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s ease;
        }

        .class-item:hover {
            background: rgba(139, 154, 91, 0.1);
            transform: translateX(5px);
        }

        .class-info h4 {
            color: #2C3E50;
            margin-bottom: 0.3rem;
        }

        .class-info p {
            color: #666;
            font-size: 0.9rem;
        }

        .activity-item {
            padding: 1rem;
            background: rgba(0, 0, 0, 0.02);
            border-radius: 10px;
            border-left: 3px solid #667eea;
        }

        .activity-time {
            color: #999;
            font-size: 0.85rem;
            margin-bottom: 0.3rem;
        }

        .activity-content {
            color: #333;
        }

        /* 管理员端样式 */
        .admin-dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 2rem;
            padding: 2rem 0;
        }

        .admin-card {
            background: white;
            border-radius: 20px;
            padding: 1.5rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .admin-card.full-width {
            grid-column: 1 / -1;
        }

        .admin-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .admin-card-header {
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #f0f0f0;
        }

        .admin-card-header h3 {
            font-family: 'Comfortaa', cursive;
            color: #2C3E50;
            font-size: 1.2rem;
        }

        .admin-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }

        .admin-stat-item {
            padding: 1rem;
            background: rgba(139, 154, 91, 0.05);
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .admin-stat-item i {
            font-size: 2rem;
            color: #667eea;
        }

        .full-width {
            width: 100%;
        }

        .mb-1 {
            margin-bottom: 0.5rem;
        }

        .data-charts {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 2rem;
        }

        .chart-container {
            text-align: center;
        }

        .chart-container h4 {
            margin-bottom: 1rem;
            color: #2C3E50;
        }

        .chart-container canvas {
            max-width: 100%;
            height: auto;
        }

        /* 页脚 */
        .footer {
            text-align: center;
            padding: 2rem;
            color: #666;
            border-top: 1px solid #eee;
            margin-top: 2rem;
        }

        /* 老板键 */
        .boss-key {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            z-index: 100;
            transition: all 0.3s ease;
        }

        .boss-key:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }

        /* 当学习小组自习界面激活时隐藏老板键 */
        .study-session-container.active ~ .boss-key {
            display: none;
        }

        /* 页面头部样式 */
        .page-header {
            text-align: center;
            margin-bottom: 2rem;
            padding: 2rem;
            background: linear-gradient(135deg, rgba(255, 107, 107, 0.9), rgba(255, 142, 83, 0.9));
            color: white;
            border-radius: 20px;
            box-shadow: 0 8px 25px rgba(255, 107, 107, 0.3);
            border: 3px solid rgba(255, 255, 255, 0.3);
            position: relative;
            overflow: hidden;
        }

        .page-header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
            animation: rotate 10s linear infinite;
        }

        @keyframes rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .page-header h1 {
            font-family: 'Comfortaa', cursive;
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
            position: relative;
            z-index: 1;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }

        .page-header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        /* 自习室网格 */
        .study-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .study-card {
            background: rgba(255, 255, 255, 0.95);
            padding: 2rem;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            border: 2px solid rgba(139, 154, 91, 0.2);
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            position: relative;
            overflow: hidden;
        }

        .study-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s;
        }

        .study-card:hover::before {
            left: 100%;
        }

        .study-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 12px 35px rgba(0, 0, 0, 0.25);
            border-color: rgba(139, 154, 91, 0.5);
        }

        .study-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #FF6B6B, #FF8E53);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
            color: white;
            font-size: 2rem;
            box-shadow: 0 5px 20px rgba(255, 107, 107, 0.4);
            animation: floatIcon 3s ease-in-out infinite;
        }

        @keyframes floatIcon {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .study-card h3 {
            font-family: 'Comfortaa', cursive;
            margin-bottom: 1rem;
            color: #2C3E50;
        }

        /* 心理小岛特性卡片 */
        .island-features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 2rem;
        }

        .feature-card {
            background: rgba(255, 255, 255, 0.95);
            padding: 2rem;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            border: 2px solid rgba(139, 154, 91, 0.2);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .feature-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 107, 107, 0.1) 0%, transparent 70%);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .feature-card:hover::before {
            opacity: 1;
        }

        .feature-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 12px 35px rgba(0, 0, 0, 0.25);
            border-color: rgba(139, 154, 91, 0.5);
        }

        .feature-icon {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
            font-size: 1.5rem;
        }

        /* 情绪追踪样式 */
        .mood-container {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 2rem;
        }

        .mood-selector {
            background: rgba(255, 255, 255, 0.95);
            padding: 2rem;
            border-radius: 20px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            border: 2px solid rgba(139, 154, 91, 0.2);
            backdrop-filter: blur(10px);
        }

        .mood-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-top: 1rem;
        }

        .mood-option {
            padding: 1rem;
            text-align: center;
            border: 2px solid rgba(139, 154, 91, 0.3);
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
        }

        .mood-option:hover {
            border-color: #FF6B6B;
            transform: scale(1.08) translateY(-3px);
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.3);
            background: rgba(255, 255, 255, 0.95);
        }

        .mood-option i {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            display: block;
        }
        
        .mood-option.selected {
            border-color: #FF6B6B;
            background: rgba(255, 107, 107, 0.1);
            transform: scale(1.05);
        }
        
        .mood-records-list {
            max-height: 600px;
            overflow-y: auto;
        }
        
        .mood-record-item {
            background: white;
            border: 2px solid rgba(139, 154, 91, 0.2);
            border-radius: 15px;
            padding: 1rem;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
        }
        
        .mood-record-item:hover {
            border-color: #FF6B6B;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.2);
        }
        
        .mood-record-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.8rem;
        }
        
        .mood-record-mood {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.1rem;
            font-weight: 600;
            color: #2C3E50;
        }
        
        .mood-record-mood i {
            font-size: 1.5rem;
        }
        
        .mood-record-date {
            color: #999;
            font-size: 0.85rem;
        }
        
        .mood-record-note {
            color: #666;
            line-height: 1.6;
            padding: 0.8rem;
            background: rgba(139, 154, 91, 0.05);
            border-radius: 10px;
            margin-top: 0.5rem;
        }
        
        .weekly-report-chart {
            background: white;
            border: 2px solid rgba(139, 154, 91, 0.2);
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .mood-bar-chart {
            display: flex;
            align-items: flex-end;
            justify-content: space-around;
            height: 200px;
            margin: 1.5rem 0;
            gap: 0.5rem;
        }
        
        .mood-bar {
            flex: 1;
            background: linear-gradient(180deg, #FF6B6B, #FF8E53);
            border-radius: 10px 10px 0 0;
            position: relative;
            transition: all 0.3s ease;
            min-height: 20px;
        }
        
        .mood-bar:hover {
            opacity: 0.8;
            transform: translateY(-5px);
        }
        
        .mood-bar-label {
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.85rem;
            color: #666;
            white-space: nowrap;
        }
        
        .mood-bar-value {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-weight: 600;
            color: #2C3E50;
            font-size: 0.9rem;
        }
        
        .analysis-section {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .analysis-section h4 {
            color: #2C3E50;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .analysis-section p {
            color: #666;
            line-height: 1.8;
            margin-bottom: 0.8rem;
        }
        
        .suggestion-list {
            list-style: none;
            padding: 0;
        }
        
        .suggestion-list li {
            padding: 0.8rem;
            background: white;
            border-radius: 10px;
            margin-bottom: 0.8rem;
            display: flex;
            align-items: flex-start;
            gap: 0.8rem;
        }
        
        .suggestion-list li i {
            color: #FF6B6B;
            margin-top: 0.2rem;
        }
        
        .alert-warning {
            background: linear-gradient(135deg, rgba(255, 107, 107, 0.1), rgba(255, 142, 83, 0.1));
            border: 2px solid rgba(255, 107, 107, 0.3);
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .alert-warning h4 {
            color: #FF6B6B;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        /* 通知中心样式 */
        .notification-badge {
            background: #FF6B6B;
            color: white;
            padding: 0.2rem 0.5rem;
            border-radius: 10px;
            font-size: 0.8rem;
            margin-left: 0.3rem;
        }
        
        .notification-item {
            background: white;
            border: 2px solid rgba(139, 154, 91, 0.2);
            border-radius: 15px;
            padding: 1rem;
            margin-bottom: 1rem;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .notification-item:hover {
            border-color: #667eea;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2);
        }
        
        .notification-item.unread {
            background: rgba(102, 126, 234, 0.05);
            border-color: #667eea;
        }
        
        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .notification-title {
            font-weight: 600;
            color: #2C3E50;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .notification-time {
            color: #999;
            font-size: 0.85rem;
        }
        
        .notification-content {
            color: #666;
            line-height: 1.6;
        }
        
        .notification-tab {
            position: relative;
        }
        
        .notification-tab.active {
            background: #667eea;
            color: white;
        }

        .mood-history {
            background: rgba(255, 255, 255, 0.95);
            padding: 2rem;
            border-radius: 20px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            border: 2px solid rgba(139, 154, 91, 0.2);
            backdrop-filter: blur(10px);
        }

        /* 聊天界面样式 */
        .chat-container {
            display: grid;
            grid-template-columns: 250px 1fr;
            gap: 2rem;
            height: 600px;
        }

        .chat-sidebar {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 1.5rem;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            border: 2px solid rgba(139, 154, 91, 0.2);
            backdrop-filter: blur(10px);
        }

        .chat-room {
            padding: 1rem;
            margin-bottom: 0.5rem;
            border-radius: 10px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .chat-room.active, .chat-room:hover {
            background: linear-gradient(135deg, #FF6B6B, #FF8E53);
            color: white;
            transform: translateX(5px);
            box-shadow: 0 3px 10px rgba(255, 107, 107, 0.3);
        }

        .chat-main {
            display: flex;
            flex-direction: column;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            border: 2px solid rgba(139, 154, 91, 0.2);
            backdrop-filter: blur(10px);
            overflow: hidden;
        }

        .chat-messages {
            flex: 1;
            padding: 1.5rem;
            overflow-y: auto;
        }

        .chat-input {
            display: flex;
            padding: 1rem;
            border-top: 1px solid #eee;
            gap: 1rem;
        }

        .chat-input input {
            flex: 1;
            padding: 0.8rem 1rem;
            border: 1px solid #ddd;
            border-radius: 25px;
            outline: none;
        }

        .chat-input input:focus {
            border-color: #667eea;
        }

        .message {
            margin-bottom: 1rem;
            padding: 1rem;
            border-radius: 10px;
            background: #f8f9fa;
        }

        .message.system {
            background: #e3f2fd;
            text-align: center;
            font-style: italic;
        }

        /* 兴趣社区网格 */
        .communities-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 2rem;
        }

        .community-card {
            background: rgba(255, 255, 255, 0.95);
            padding: 2rem;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            border: 2px solid rgba(139, 154, 91, 0.2);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .community-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s;
        }

        .community-card:hover::before {
            left: 100%;
        }

        .community-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 12px 35px rgba(0, 0, 0, 0.25);
            border-color: rgba(139, 154, 91, 0.5);
        }

        .community-icon {
            width: 70px;
            height: 70px;
            background: linear-gradient(135deg, #FF6B6B, #FF8E53);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
            color: white;
            font-size: 1.5rem;
            box-shadow: 0 5px 20px rgba(255, 107, 107, 0.4);
            animation: floatIcon 3s ease-in-out infinite;
        }

        .community-members {
            color: #666;
            margin: 1rem 0;
            font-size: 0.9rem;
        }

        /* 兴趣社区 - 帖子容器 */
        .posts-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        /* 帖子卡片 */
        .post-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border: 2px solid rgba(139, 154, 91, 0.2);
            transition: all 0.3s ease;
            cursor: pointer;
            display: flex;
            flex-direction: column;
        }

        .post-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .post-card-header {
            padding: 1rem;
            display: flex;
            align-items: center;
            gap: 0.8rem;
            border-bottom: 1px solid rgba(139, 154, 91, 0.1);
        }

        .post-author-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #FF6B6B, #FF8E53);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.1rem;
            flex-shrink: 0;
            cursor: pointer;
        }

        .post-author-info {
            flex: 1;
            min-width: 0;
        }

        .post-author-name {
            font-weight: 600;
            color: #2C3E50;
            font-size: 0.95rem;
            margin-bottom: 0.2rem;
            cursor: pointer;
        }

        .post-author-name:hover {
            color: #8B9A5B;
        }

        .post-time {
            font-size: 0.8rem;
            color: #999;
        }

        .post-card-body {
            padding: 1rem;
            flex: 1;
        }

        .post-topic {
            display: inline-block;
            padding: 0.3rem 0.8rem;
            background: rgba(139, 154, 91, 0.15);
            color: #8B9A5B;
            border-radius: 20px;
            font-size: 0.85rem;
            margin-bottom: 0.8rem;
        }

        .post-title {
            font-weight: 600;
            color: #2C3E50;
            font-size: 1rem;
            margin-bottom: 0.5rem;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .post-content-preview {
            color: #666;
            font-size: 0.9rem;
            line-height: 1.6;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .post-card-footer {
            padding: 0.8rem 1rem;
            border-top: 1px solid rgba(139, 154, 91, 0.1);
            display: flex;
            gap: 1.5rem;
        }

        .post-action {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            color: #999;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .post-action:hover {
            color: #8B9A5B;
        }

        .post-action.active {
            color: #FF6B6B;
        }

        .post-action i {
            font-size: 1rem;
        }

        /* 帖子详情样式 */
        .post-detail-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid rgba(139, 154, 91, 0.2);
        }

        .post-detail-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #FF6B6B, #FF8E53);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.3rem;
            cursor: pointer;
        }

        .post-detail-info {
            flex: 1;
        }

        .post-detail-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
            padding-top: 1rem;
            border-top: 1px solid rgba(139, 154, 91, 0.2);
        }

        .comment-section {
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 2px solid rgba(139, 154, 91, 0.2);
        }

        .comment-input-area {
            display: flex;
            gap: 0.8rem;
            margin-bottom: 1.5rem;
        }

        .comment-input-area textarea {
            flex: 1;
            min-height: 80px;
            padding: 0.8rem;
            border: 2px solid rgba(139, 154, 91, 0.3);
            border-radius: 10px;
            resize: vertical;
        }

        .comment-item {
            padding: 1rem;
            background: rgba(139, 154, 91, 0.05);
            border-radius: 10px;
            margin-bottom: 1rem;
        }

        .comment-header {
            display: flex;
            align-items: center;
            gap: 0.8rem;
            margin-bottom: 0.5rem;
        }

        .comment-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: linear-gradient(135deg, #a29bfe, #fd79a8);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .comment-author {
            font-weight: 600;
            color: #2C3E50;
            font-size: 0.9rem;
        }

        .comment-time {
            color: #999;
            font-size: 0.8rem;
        }

        .comment-content {
            color: #666;
            line-height: 1.6;
            margin-left: 43px;
        }

        /* 演示版本提示 */
        .demo-notice {
            background: #fff3cd;
            color: #856404;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid #ffeaa7;
            font-size: 0.9rem;
        }

        .demo-notice strong {
            display: block;
            margin-bottom: 5px;
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 1rem;
                padding: 1rem;
            }
            
            .nav-links {
                flex-wrap: wrap;
                justify-content: center;
                gap: 0.5rem;
            }
            
            .welcome-section {
                grid-template-columns: 1fr;
            }
            
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .mood-container {
                grid-template-columns: 1fr;
            }
            
            .chat-container {
                grid-template-columns: 1fr;
                height: auto;
            }
            
            .chat-sidebar {
                order: 2;
            }
            
            .chat-main {
                order: 1;
                height: 400px;
            }
            
            .study-grid,
            .island-features,
            .communities-grid {
                grid-template-columns: 1fr;
            }
            
            .class-controls {
                flex-direction: column;
            }
            
            .points-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            .page-header h1 {
                font-size: 2rem;
            }
            
            .overview-grid {
                grid-template-columns: 1fr;
            }
            
            .mood-options {
                grid-template-columns: 1fr;
            }
        }
// 在现有代码中的适当位置添加以下内容：

// 全局错误处理 - 忽略CORS错误
window.addEventListener('error', function(e) {
    // 忽略CORS错误
    if (e.message && (e.message.includes('CORS') || e.message.includes('Access-Control-Allow-Origin'))) {
        console.log('忽略CORS策略错误');
        return;
    }
    console.error('全局错误:', e);
});

// 捕获未处理的Promise拒绝
window.addEventListener('unhandledrejection', function(e) {
    if (e.reason && e.reason.message && 
        (e.reason.message.includes('CORS') || e.reason.message.includes('Access-Control-Allow-Origin'))) {
        e.preventDefault();
        console.log('忽略CORS相关的Promise拒绝');
        return;
    }
});
    </style>
</head>
<body>
    <!-- 插画风格背景 -->
    <div class="illustration-background">
        <!-- 天空层 -->
        <div class="sky-layer">
            <div class="cloud cloud1"></div>
            <div class="cloud cloud2"></div>
            <div class="cloud cloud3"></div>
            <div class="bird" style="top: 15%; animation-delay: 0s;"></div>
            <div class="bird" style="top: 25%; animation-delay: 5s;"></div>
            <div class="bird" style="top: 35%; animation-delay: 10s;"></div>
        </div>
        
        <!-- 草地层 -->
        <div class="grass-layer">
            <!-- 动态生成草地 -->
        </div>
        
        <!-- 树木 -->
        <div class="tree tree-left">
            <div class="tree-crown"></div>
            <div class="tree-trunk"></div>
        </div>
        <div class="tree tree-right">
            <div class="tree-crown"></div>
            <div class="tree-trunk"></div>
        </div>
    </div>
    
    <!-- 应用容器 -->
    <div class="app-container">
        <!-- 顶部导航 -->
        <header class="header">
            <div class="logo">
                <div class="logo-icon">心</div>
                <div class="logo-text">心屿学院</div>
            </div>
            
            <nav class="nav-links">
                <a href="#" class="nav-link active" data-page="dashboard">学院大厅</a>
                <a href="#" class="nav-link" data-page="study-room">自习室</a>
                <a href="#" class="nav-link" data-page="mental-island">心理小岛</a>
                <a href="#" class="nav-link" data-page="mood-tracker">情绪追踪</a>
                <a href="#" class="nav-link" data-page="student-chat">同学交流</a>
                <a href="#" class="nav-link" data-page="interest-community">兴趣社区</a>
            </nav>
            
            <div class="house-badge">
                <div class="house-icon" style="background: #740001;">G</div>
                <span>格兰芬多</span>
            </div>
            
            <div class="user-actions">
                <div class="role-switcher" id="role-switcher">
                    <button class="role-button" id="current-role-btn">
                        <i class="fas fa-user-graduate"></i>
                        <span id="current-role-text">学生端</span>
                        <i class="fas fa-chevron-down"></i>
                    </button>
                    <div class="role-dropdown" id="role-dropdown">
                        <div class="role-option" data-role="student">
                            <i class="fas fa-user-graduate"></i>
                            <span>学生端</span>
                        </div>
                        <div class="role-option" data-role="parent">
                            <i class="fas fa-user-friends"></i>
                            <span>家长端</span>
                        </div>
                        <div class="role-option" data-role="teacher">
                            <i class="fas fa-chalkboard-teacher"></i>
                            <span>教师端</span>
                        </div>
                        <div class="role-option" data-role="admin">
                            <i class="fas fa-user-shield"></i>
                            <span>管理员</span>
                        </div>
                    </div>
                </div>
                <div class="notification-icon">
                    <i class="fas fa-bell"></i>
                    <div class="notification-badge">3</div>
                </div>
                <div class="settings-icon">
                    <i class="fas fa-cog"></i>
                </div>
                <div class="user-avatar" id="user-avatar" style="cursor: pointer;" title="点击设置个人信息">
                    <span id="user-avatar-icon">👤</span>
                </div>
            </div>
        </header>
        
        <!-- 学院大厅页面 -->
        <div id="dashboard" class="page-container active">
            <!-- 学院积分板 -->
            <section class="house-points">
                <div class="points-header">
                    <i class="fas fa-trophy"></i>
                    <span>学院杯积分榜</span>
                </div>
                <div class="points-grid">
                    <div class="house-card gryffindor leading">
                        <div class="house-name">格兰芬多</div>
                        <div class="house-points-value">342</div>
                        <div class="points-remaining">领先 15 分</div>
                    </div>
                    <div class="house-card slytherin">
                        <div class="house-name">斯莱特林</div>
                        <div class="house-points-value">327</div>
                        <div class="points-remaining">落后 15 分</div>
                    </div>
                    <div class="house-card ravenclaw">
                        <div class="house-name">拉文克劳</div>
                        <div class="house-points-value">298</div>
                        <div class="points-remaining">落后 44 分</div>
                    </div>
                    <div class="house-card hufflepuff">
                        <div class="house-name">赫奇帕奇</div>
                        <div class="house-points-value">275</div>
                        <div class="points-remaining">落后 67 分</div>
                    </div>
                </div>
            </section>
            
            <!-- 欢迎区域 -->
            <section class="welcome-section">
                <div class="welcome-card">
                    <div class="welcome-avatar">
                        <i class="fas fa-hat-wizard"></i>
                    </div>
                    <div class="welcome-text">
                        <h2 id="welcome-user">欢迎来到心屿学院！</h2>
                        <p id="current-date">今天是星期三，2023年10月18日</p>
                        <p class="motivation-text">"每一个小小的进步，都是对自己的温柔呵护。慢慢来，你已经很棒了 🌸"</p>
                    </div>
                </div>
                
                <div class="today-overview">
                    <div class="overview-title">
                        <i class="fas fa-calendar-day"></i>
                        <span>今日概览</span>
                    </div>
                    <div class="overview-grid">
                        <div class="overview-item">
                            <div class="overview-value">2</div>
                            <div class="overview-label">今日课程</div>
                        </div>
                        <div class="overview-item">
                            <div class="overview-value">3</div>
                            <div class="overview-label">待完成作业</div>
                        </div>
                        <div class="overview-item">
                            <div class="overview-value" id="focus-time">45</div>
                            <div class="overview-label">分钟专注</div>
                        </div>
                        <div class="overview-item">
                            <div class="overview-value">+10</div>
                            <div class="overview-label">学院积分</div>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- AI工具组件 -->
            <section class="ai-tools-section">
                <h2 style="font-family: 'Comfortaa', cursive; color: #2C3E50; margin-bottom: 0.5rem;">
                    <i class="fas fa-robot"></i> AI学习助手
                </h2>
                <p style="color: #666; margin-bottom: 1rem;">让AI成为你的学习伙伴，随时为你提供帮助和鼓励 🌟</p>
                <div class="ai-tools-grid">
                    <div class="ai-tool-card" id="ai-homework-helper">
                        <div class="ai-tool-icon">📝</div>
                        <h3 style="font-family: 'Comfortaa', cursive; color: #2C3E50; margin-bottom: 0.5rem;">作业助手</h3>
                        <p style="color: #666; font-size: 0.9rem;">帮你解答学习问题</p>
                    </div>
                    <div class="ai-tool-card" id="ai-mood-companion">
                        <div class="ai-tool-icon">💬</div>
                        <h3 style="font-family: 'Comfortaa', cursive; color: #2C3E50; margin-bottom: 0.5rem;">心情陪伴</h3>
                        <p style="color: #666; font-size: 0.9rem;">倾听你的心声</p>
                    </div>
                    <div class="ai-tool-card" id="ai-study-plan">
                        <div class="ai-tool-icon">📚</div>
                        <h3 style="font-family: 'Comfortaa', cursive; color: #2C3E50; margin-bottom: 0.5rem;">学习计划</h3>
                        <p style="color: #666; font-size: 0.9rem;">制定专属学习计划</p>
                    </div>
                    <div class="ai-tool-card" id="ai-encouragement">
                        <div class="ai-tool-icon">✨</div>
                        <h3 style="font-family: 'Comfortaa', cursive; color: #2C3E50; margin-bottom: 0.5rem;">每日鼓励</h3>
                        <p style="color: #666; font-size: 0.9rem;">每天给你温暖的鼓励</p>
                    </div>
                </div>
            </section>
            
            <!-- 主要内容区域 -->
            <main class="main-content">
                <!-- 直播课堂区域 -->
                <section class="live-class-section">
                    <div class="live-class-card">
                        <div class="card-header">
                            <div class="card-title">
                                <i class="fas fa-chalkboard-teacher"></i>
                                <span>心理健康课堂</span>
                            </div>
                            <div class="live-status">直播中</div>
                        </div>
                        
                        <div class="class-info">
                            <div class="class-icon">
                                <i class="fas fa-heart"></i>
                            </div>
                            <div class="class-details">
                                <div class="class-name">情绪管理与自我关怀</div>
                                <div class="class-teacher">
                                    <i class="fas fa-user-graduate"></i>
                                    <span>王心理老师</span>
                                </div>
                                <div class="class-time">
                                    <i class="far fa-clock"></i>
                                    <span>14:00 - 15:30 (剩余 25 分钟)</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="video-container">
                            <div class="video-placeholder">
                                <div class="video-icon">
                                    <i class="fas fa-video"></i>
                                </div>
                                <h3>心理健康课堂直播</h3>
                                <p>情绪管理与自我关怀 - 王心理老师</p>
                                <button class="btn btn-primary" onclick="startDemoVideo()">
                                    <i class="fas fa-play"></i> 开始演示
                                </button>
                            </div>
                        </div>
                        
                        <div class="class-controls">
                            <button class="btn btn-primary" id="join-class">
                                <i class="fas fa-play-circle"></i>
                                <span>进入课堂</span>
                            </button>
                            <button class="btn btn-ai" id="ask-question">
                                <i class="fas fa-robot"></i>
                                <span>AI学习助手</span>
                            </button>
                            <button class="btn btn-outline" id="class-notes">
                                <i class="fas fa-question-circle"></i>
                                <span>课堂笔记</span>
                            </button>
                        </div>
                    </div>
                </section>
                
                <!-- 其他功能区域可以在这里添加 -->
            </main>
        </div>
        
        <!-- 自习室页面 -->
        <div id="study-room" class="page-container">
            <section class="page-header">
                <h1><i class="fas fa-book"></i> 温馨自习室</h1>
                <p>在这里，每一次专注都是对自己的温柔呵护 🌸</p>
            </section>
            
            <div class="study-grid">
                <div class="study-card">
                    <div class="study-icon">
                        <i class="fas fa-clock"></i>
                    </div>
                    <h3>专注时光</h3>
                    <p>给自己25分钟的温柔时光，慢慢来，不着急</p>
                    <button class="btn btn-primary" id="start-timer">
                        <i class="fas fa-play"></i> 开始专注时光
                    </button>
                </div>
                
                <div class="study-card">
                    <div class="study-icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <h3>组队学习</h3>
                    <p>和朋友们一起学习，互相陪伴，共同成长</p>
                    <button class="btn btn-outline" id="view-teams">
                        <i class="fas fa-user-friends"></i> 查看学习小组
                    </button>
                </div>
                
                <div class="study-card">
                    <div class="study-icon">
                        <i class="fas fa-tasks"></i>
                    </div>
                    <h3>学习任务</h3>
                    <p>记录你的学习计划，一步一步完成</p>
                    <button class="btn btn-outline" id="view-tasks">
                        <i class="fas fa-list"></i> 查看任务
                    </button>
                </div>
                
                <div class="study-card">
                    <div class="study-icon">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <h3>学习统计</h3>
                    <p>看看自己的进步，每一小步都值得庆祝</p>
                    <button class="btn btn-outline" id="view-stats">
                        <i class="fas fa-chart-bar"></i> 查看统计
                    </button>
                </div>
            </div>

            <!-- 组队学习区域 -->
            <div class="team-study-section" id="team-study-section" style="display: none;">
                <h2 style="font-family: 'Comfortaa', cursive; color: #2C3E50; margin-bottom: 1rem;">
                    <i class="fas fa-users"></i> 学习小组
                </h2>
                <p style="color: #666; margin-bottom: 1.5rem;">找到志同道合的学习伙伴，一起努力，互相鼓励 💪</p>
                <button class="btn btn-primary" id="create-team" style="margin-bottom: 1.5rem;">
                    <i class="fas fa-plus"></i> 创建学习小组
                </button>
                <div class="team-list">
                    <div class="team-card">
                        <h3 style="font-family: 'Comfortaa', cursive; color: #2C3E50; margin-bottom: 0.5rem;">
                            <i class="fas fa-heart"></i> 温暖学习小组
                        </h3>
                        <p style="color: #666; font-size: 0.9rem; margin-bottom: 0.5rem;">一起学习，互相鼓励</p>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 1rem;">
                            <div class="team-members">
                                <div class="team-member-avatar">A</div>
                                <div class="team-member-avatar">B</div>
                                <div class="team-member-avatar">C</div>
                                <div class="team-member-avatar" style="background: rgba(139, 154, 91, 0.3); color: #666;">+2</div>
                            </div>
                            <button class="btn btn-outline" style="padding: 0.5rem 1rem; font-size: 0.9rem;">加入</button>
                        </div>
                    </div>
                    <div class="team-card">
                        <h3 style="font-family: 'Comfortaa', cursive; color: #2C3E50; margin-bottom: 0.5rem;">
                            <i class="fas fa-star"></i> 星光学习小组
                        </h3>
                        <p style="color: #666; font-size: 0.9rem; margin-bottom: 0.5rem;">每天进步一点点</p>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 1rem;">
                            <div class="team-members">
                                <div class="team-member-avatar">D</div>
                                <div class="team-member-avatar">E</div>
                                <div class="team-member-avatar" style="background: rgba(139, 154, 91, 0.3); color: #666;">+3</div>
                            </div>
                            <button class="btn btn-outline" style="padding: 0.5rem 1rem; font-size: 0.9rem;">加入</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 全屏倒计时页面 -->
        <div class="timer-fullscreen" id="timer-fullscreen">
            <button class="timer-close-btn" id="timer-close-btn">
                <i class="fas fa-times"></i>
            </button>
            <div class="timer-display">
                <div class="timer-time" id="timer-time">25:00</div>
                <div class="timer-label" id="timer-label">专注时光进行中...</div>
                <div class="timer-progress">
                    <div class="timer-progress-bar" id="timer-progress-bar" style="width: 100%;"></div>
                </div>
                <div class="timer-encouragement" id="timer-encouragement">
                    你正在做一件很棒的事情，坚持下去，你比自己想象的更强大 💪
                </div>
            </div>
        </div>

        <!-- 心理小岛页面 -->
        <div id="mental-island" class="page-container">
            <section class="page-header">
                <h1><i class="fas fa-heart"></i> 心理小岛</h1>
                <p>这里是你的安全港湾，累了就来这里休息一下 🌸</p>
            </section>
            
            <!-- 每日文章推送 -->
            <div class="daily-article-card" style="background: rgba(255, 255, 255, 0.95); border-radius: 20px; padding: 2rem; margin-bottom: 2rem; box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15); border: 2px solid rgba(139, 154, 91, 0.2);">
                <h2 style="font-family: 'Comfortaa', cursive; color: #2C3E50; margin-bottom: 1rem;">
                    <i class="fas fa-book-open"></i> 今日暖心文章
                </h2>
                <div id="daily-article-preview" style="color: #666; line-height: 1.8;">
                    <!-- 文章预览将通过JavaScript加载 -->
                </div>
                <button class="btn btn-primary" id="read-daily-article" style="margin-top: 1rem;">
                    <i class="fas fa-book-reader"></i> 阅读全文
                </button>
            </div>

            <div class="island-features">
                <div class="feature-card">
                    <div class="feature-icon" style="background: #ffeaa7;">
                        <i class="fas fa-wind" style="color: #e17055;"></i>
                    </div>
                    <h3>呼吸练习</h3>
                    <p>慢慢呼吸，让心情平静下来</p>
                    <div style="display: flex; gap: 0.5rem; justify-content: center; flex-wrap: wrap;">
                        <button class="btn btn-primary" id="breathing-exercise-btn">呼吸训练</button>
                        <button class="btn btn-outline" id="mindfulness-exercise-btn">正念练习</button>
                    </div>
                </div>
                
                <div class="feature-card">
                    <div class="feature-icon" style="background: #a29bfe;">
                        <i class="fas fa-book-medical" style="color: white;"></i>
                    </div>
                    <h3>心理知识</h3>
                    <p>了解自己，学会关爱自己</p>
                    <button class="btn btn-primary" id="knowledge-library-btn">探索知识库</button>
                </div>
                
                <div class="feature-card">
                    <div class="feature-icon" style="background: #fd79a8;">
                        <i class="fas fa-hands-helping" style="color: white;"></i>
                    </div>
                    <h3>专业支持</h3>
                    <p>专业的心理老师在这里陪伴你</p>
                    <button class="btn btn-primary" id="professional-support-btn">寻求帮助</button>
                </div>
                
                <div class="feature-card">
                    <div class="feature-icon" style="background: #74b9ff;">
                        <i class="fas fa-tree" style="color: white;"></i>
                    </div>
                    <h3>匿名树洞</h3>
                    <p>安全地倾诉你的心声</p>
                    <button class="btn btn-primary" id="anonymous-tree-btn">进入树洞</button>
                </div>
                
                <div class="feature-card">
                    <div class="feature-icon" style="background: #55efc4;">
                        <i class="fas fa-user-friends" style="color: white;"></i>
                    </div>
                    <h3>同伴支持</h3>
                    <p>与有相似经历的伙伴互相支持</p>
                    <button class="btn btn-primary" id="peer-support-btn">寻找同伴</button>
                </div>
                
                <div class="feature-card">
                    <div class="feature-icon" style="background: #ff9ff3;">
                        <i class="fas fa-book" style="color: white;"></i>
                    </div>
                    <h3>心理图书馆</h3>
                    <p>海量心理学书籍，助你成长</p>
                    <button class="btn btn-primary" id="library-btn">进入图书馆</button>
                </div>
            </div>
        </div>

        <!-- 呼吸训练模态框 -->
        <div class="breathing-modal" id="breathing-modal">
            <div class="breathing-container" style="position: relative; z-index: 1;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; position: relative; z-index: 2;">
                    <h2 style="font-family: 'Comfortaa', cursive; color: #2C3E50;">
                        <i class="fas fa-wind"></i> 呼吸训练
                    </h2>
                    <button class="timer-close-btn" id="close-breathing-modal" style="position: relative; top: 0; right: 0;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <p style="color: #666; text-align: center; margin-bottom: 1.5rem; position: relative; z-index: 2;">
                    跟随圆圈的节奏，慢慢呼吸，让心情平静下来 🌸
                </p>
                
                <!-- 音乐控制 -->
                <div class="music-control" id="music-control" style="position: relative; z-index: 2;">
                    <i class="fas fa-music"></i>
                    <span id="music-status">开启冥想音乐</span>
                    <i class="fas fa-volume-up" id="music-icon"></i>
                </div>
                <audio id="meditation-music" loop preload="auto" volume="0.3">
                    <!-- 冥想音乐：白噪音+轻音乐混合 -->
                    <!-- 实际应用中可以使用真实的冥想音乐URL -->
                </audio>
                
                <div style="position: relative; z-index: 2;">
                    <div class="breathing-circle" id="breathing-circle">
                        <div id="breathing-text" style="font-size: 1.8rem; font-weight: 600;">准备开始</div>
                    </div>
                    <div class="breathing-instruction" id="breathing-instruction" style="font-size: 1.3rem; margin-top: 1.5rem;">点击开始，跟随节奏呼吸</div>
                    <div class="breathing-controls">
                        <button class="btn btn-primary" id="start-breathing">开始</button>
                        <button class="btn btn-outline" id="pause-breathing" style="display: none;">暂停</button>
                        <button class="btn btn-outline" id="stop-breathing" style="display: none;">停止</button>
                    </div>
                </div>
                <div style="margin-top: 2rem; padding: 1.5rem; background: rgba(255, 107, 107, 0.1); border-radius: 15px;">
                    <h4 style="color: #2C3E50; margin-bottom: 1rem; font-family: 'Comfortaa', cursive;">
                        <i class="fas fa-video"></i> 呼吸训练视频
                    </h4>
                    <div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; border-radius: 10px;">
                        <iframe style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;" 
                                src="https://www.youtube.com/embed/tybOi4hjZFQ" 
                                frameborder="0" 
                                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                                allowfullscreen></iframe>
                    </div>
                    <p style="color: #666; font-size: 0.9rem; margin-top: 1rem;">
                        提示：可以观看视频学习正确的呼吸方法，也可以跟随上面的圆圈进行练习
                    </p>
                </div>
            </div>
        </div>

        <!-- 正念练习模态框 -->
        <div class="mindfulness-modal" id="mindfulness-modal">
            <div class="mindfulness-container">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h2 style="font-family: 'Comfortaa', cursive; color: #2C3E50;">
                        <i class="fas fa-leaf"></i> 正念练习
                    </h2>
                    <button class="timer-close-btn" id="close-mindfulness-modal" style="position: relative; top: 0; right: 0;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div id="mindfulness-content">
                    <!-- 正念练习内容将通过JavaScript动态加载 -->
                </div>
            </div>
        </div>

        <!-- 心理学知识库模态框 -->
        <div class="knowledge-modal" id="knowledge-modal">
            <div class="knowledge-container">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h2 style="font-family: 'Comfortaa', cursive; color: #2C3E50;">
                        <i class="fas fa-book-medical"></i> 心理学知识库
                    </h2>
                    <button class="timer-close-btn" id="close-knowledge-modal" style="position: relative; top: 0; right: 0;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="knowledge-grid" id="knowledge-grid">
                    <!-- 知识卡片将通过JavaScript动态加载 -->
                </div>
            </div>
        </div>

        <!-- 每日文章模态框 -->
        <div class="daily-article-modal" id="daily-article-modal">
            <div class="daily-article-container">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h2 style="font-family: 'Comfortaa', cursive; color: #2C3E50;">
                        <i class="fas fa-book-open"></i> 今日暖心文章
                    </h2>
                    <button class="timer-close-btn" id="close-daily-article-modal" style="position: relative; top: 0; right: 0;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="daily-article-content" id="daily-article-full-content">
                    <!-- 文章内容将通过JavaScript加载 -->
                </div>
            </div>
        </div>

        <!-- 个人信息设置模态框 -->
        <div class="profile-modal" id="profile-modal">
            <div class="profile-container" style="max-height: 85vh; overflow-y: auto;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; position: sticky; top: 0; background: white; z-index: 10; padding-bottom: 1rem;">
                    <h2 style="font-family: 'Comfortaa', cursive; color: #2C3E50;">
                        <i class="fas fa-user-circle"></i> 个人信息与设置
                    </h2>
                    <button class="timer-close-btn" id="close-profile-modal" style="position: relative; top: 0; right: 0;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <!-- 个人信息部分 -->
                <div style="border-bottom: 2px solid #eee; padding-bottom: 1.5rem; margin-bottom: 1.5rem;">
                    <h3 style="color: #2C3E50; margin-bottom: 1rem; font-size: 1.1rem;">
                        <i class="fas fa-user"></i> 个人信息
                    </h3>
                    <div class="profile-form-group">
                        <label>选择头像</label>
                        <div class="profile-avatar-selector" id="avatar-selector">
                            <!-- 头像选项将通过JavaScript生成 -->
                        </div>
                    </div>
                    <div class="profile-form-group">
                        <label for="profile-username">昵称</label>
                        <input type="text" id="profile-username" placeholder="请输入你的昵称" maxlength="20">
                    </div>
                    <div class="profile-form-group">
                        <label for="profile-chat-id">我的交流号</label>
                        <input type="text" id="profile-chat-id" readonly style="background: #f5f5f5;">
                        <small style="color: #666; font-size: 0.85rem; margin-top: 0.3rem; display: block;">
                            这是你的唯一交流号，好友可以通过这个号码添加你
                        </small>
                    </div>
                    <div class="profile-form-group">
                        <label for="profile-bio">个人简介（可选）</label>
                        <input type="text" id="profile-bio" placeholder="介绍一下自己吧~" maxlength="50">
                    </div>
                </div>
                
                <!-- 通知设置部分 -->
                <div style="border-bottom: 2px solid #eee; padding-bottom: 1.5rem; margin-bottom: 1.5rem;">
                    <h3 style="color: #2C3E50; margin-bottom: 1rem; font-size: 1.1rem;">
                        <i class="fas fa-bell"></i> 通知设置
                    </h3>
                    <div class="setting-item" style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: rgba(139, 154, 91, 0.05); border-radius: 10px; margin-bottom: 0.8rem;">
                        <div>
                            <div style="font-weight: 600; color: #2C3E50; margin-bottom: 0.3rem;">消息通知</div>
                            <div style="font-size: 0.85rem; color: #666;">接收好友和群聊消息通知</div>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="msg-notification" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="setting-item" style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: rgba(139, 154, 91, 0.05); border-radius: 10px; margin-bottom: 0.8rem;">
                        <div>
                            <div style="font-weight: 600; color: #2C3E50; margin-bottom: 0.3rem;">情绪提醒</div>
                            <div style="font-size: 0.85rem; color: #666;">提醒每日记录情绪</div>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="mood-reminder" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="setting-item" style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: rgba(139, 154, 91, 0.05); border-radius: 10px; margin-bottom: 0.8rem;">
                        <div>
                            <div style="font-weight: 600; color: #2C3E50; margin-bottom: 0.3rem;">学习提醒</div>
                            <div style="font-size: 0.85rem; color: #666;">学习小组活动提醒</div>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="study-reminder" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="setting-item" style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: rgba(139, 154, 91, 0.05); border-radius: 10px;">
                        <div>
                            <div style="font-weight: 600; color: #2C3E50; margin-bottom: 0.3rem;">声音提示</div>
                            <div style="font-size: 0.85rem; color: #666;">消息到达时播放提示音</div>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="sound-notification" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
                
                <!-- 隐私设置部分 -->
                <div style="border-bottom: 2px solid #eee; padding-bottom: 1.5rem; margin-bottom: 1.5rem;">
                    <h3 style="color: #2C3E50; margin-bottom: 1rem; font-size: 1.1rem;">
                        <i class="fas fa-shield-alt"></i> 隐私设置
                    </h3>
                    <div class="setting-item" style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: rgba(139, 154, 91, 0.05); border-radius: 10px; margin-bottom: 0.8rem;">
                        <div>
                            <div style="font-weight: 600; color: #2C3E50; margin-bottom: 0.3rem;">允许陌生人添加</div>
                            <div style="font-size: 0.85rem; color: #666;">其他用户可以通过交流号添加你</div>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="allow-stranger" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="setting-item" style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: rgba(139, 154, 91, 0.05); border-radius: 10px; margin-bottom: 0.8rem;">
                        <div>
                            <div style="font-weight: 600; color: #2C3E50; margin-bottom: 0.3rem;">显示在线状态</div>
                            <div style="font-size: 0.85rem; color: #666;">让好友看到你的在线状态</div>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="show-online-status" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="setting-item" style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: rgba(139, 154, 91, 0.05); border-radius: 10px;">
                        <div>
                            <div style="font-weight: 600; color: #2C3E50; margin-bottom: 0.3rem;">情绪记录可见性</div>
                            <div style="font-size: 0.85rem; color: #666;">仅自己和心理老师可见</div>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="mood-privacy" checked disabled>
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
                
                <!-- 学习偏好设置 -->
                <div style="border-bottom: 2px solid #eee; padding-bottom: 1.5rem; margin-bottom: 1.5rem;">
                    <h3 style="color: #2C3E50; margin-bottom: 1rem; font-size: 1.1rem;">
                        <i class="fas fa-graduation-cap"></i> 学习偏好
                    </h3>
                    <div class="profile-form-group">
                        <label for="study-goal">每日学习目标（小时）</label>
                        <input type="number" id="study-goal" min="1" max="12" value="2" style="width: 100%; padding: 0.8rem; border: 2px solid rgba(139, 154, 91, 0.3); border-radius: 10px;">
                    </div>
                    <div class="profile-form-group">
                        <label for="focus-time">专注时长（分钟）</label>
                        <select id="focus-time" style="width: 100%; padding: 0.8rem; border: 2px solid rgba(139, 154, 91, 0.3); border-radius: 10px;">
                            <option value="25">25分钟（番茄工作法）</option>
                            <option value="45">45分钟</option>
                            <option value="60" selected>60分钟</option>
                            <option value="90">90分钟</option>
                        </select>
                    </div>
                    <div class="profile-form-group">
                        <label for="rest-time">休息时长（分钟）</label>
                        <select id="rest-time" style="width: 100%; padding: 0.8rem; border: 2px solid rgba(139, 154, 91, 0.3); border-radius: 10px;">
                            <option value="5">5分钟</option>
                            <option value="10">10分钟</option>
                            <option value="15" selected>15分钟</option>
                            <option value="20">20分钟</option>
                        </select>
                    </div>
                </div>
                
                <!-- 主题设置 -->
                <div style="border-bottom: 2px solid #eee; padding-bottom: 1.5rem; margin-bottom: 1.5rem;">
                    <h3 style="color: #2C3E50; margin-bottom: 1rem; font-size: 1.1rem;">
                        <i class="fas fa-palette"></i> 主题设置
                    </h3>
                    <div class="profile-form-group">
                        <label>选择主题色</label>
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-top: 1rem;">
                            <div class="theme-option" data-theme="default" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); height: 60px; border-radius: 10px; cursor: pointer; border: 3px solid #667eea; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600;">
                                <i class="fas fa-check"></i>
                            </div>
                            <div class="theme-option" data-theme="green" style="background: linear-gradient(135deg, #56ab2f 0%, #a8e063 100%); height: 60px; border-radius: 10px; cursor: pointer; border: 3px solid transparent;"></div>
                            <div class="theme-option" data-theme="pink" style="background: linear-gradient(135deg, #ff6b9d 0%, #ffc371 100%); height: 60px; border-radius: 10px; cursor: pointer; border: 3px solid transparent;"></div>
                            <div class="theme-option" data-theme="blue" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); height: 60px; border-radius: 10px; cursor: pointer; border: 3px solid transparent;"></div>
                        </div>
                    </div>
                </div>
                
                <!-- 账号管理 -->
                <div style="padding-bottom: 1.5rem;">
                    <h3 style="color: #2C3E50; margin-bottom: 1rem; font-size: 1.1rem;">
                        <i class="fas fa-cog"></i> 账号管理
                    </h3>
                    <button class="btn btn-outline" id="clear-data-btn" style="width: 100%; margin-bottom: 0.8rem;">
                        <i class="fas fa-trash-alt"></i> 清除本地数据
                    </button>
                    <button class="btn btn-outline" id="export-data-btn" style="width: 100%; margin-bottom: 0.8rem;">
                        <i class="fas fa-download"></i> 导出我的数据
                    </button>
                    <button class="btn btn-outline" id="logout-btn" style="width: 100%;">
                        <i class="fas fa-sign-out-alt"></i> 退出登录
                    </button>
                </div>
                
                <button class="btn btn-primary" id="save-profile" style="width: 100%; padding: 1rem; font-size: 1.1rem; margin-top: 1rem;">
                    <i class="fas fa-save"></i> 保存所有设置
                </button>
            </div>
        </div>
        
        <!-- 消息通知中心 -->
        <div class="library-modal" id="notification-center-modal">
            <div class="library-container" style="max-width: 700px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h2 style="font-family: 'Comfortaa', cursive; color: #2C3E50;">
                        <i class="fas fa-bell"></i> 消息通知中心
                    </h2>
                    <button class="timer-close-btn" id="close-notification-center">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div style="display: flex; gap: 0.8rem; margin-bottom: 1.5rem; border-bottom: 2px solid #eee; padding-bottom: 1rem;">
                    <button class="btn btn-primary notification-tab active" data-tab="all" style="flex: 1;">
                        全部 <span id="all-count" class="notification-badge">0</span>
                    </button>
                    <button class="btn btn-outline notification-tab" data-tab="system" style="flex: 1;">
                        系统
                    </button>
                    <button class="btn btn-outline notification-tab" data-tab="friend" style="flex: 1;">
                        好友
                    </button>
                    <button class="btn btn-outline notification-tab" data-tab="study" style="flex: 1;">
                        学习
                    </button>
                </div>
                
                <div id="notifications-list" style="max-height: 500px; overflow-y: auto;">
                    <!-- 通知列表将通过JavaScript动态生成 -->
                </div>
                
                <div style="text-align: center; margin-top: 1rem;">
                    <button class="btn btn-outline" id="clear-all-notifications">
                        <i class="fas fa-check-double"></i> 全部标记为已读
                    </button>
                </div>
            </div>
        </div>

        <!-- 专业支持预约模态框 -->
        <div class="appointment-modal" id="appointment-modal">
            <div class="appointment-container">
                <h2 style="font-family: 'Comfortaa', cursive; color: #2C3E50; margin-bottom: 1rem; text-align: center;">
                    <i class="fas fa-heart"></i> 预约专业支持
                </h2>
                <p style="color: #666; text-align: center; margin-bottom: 2rem;">
                    选择适合你的预约方式，我们随时在这里陪伴你 🌸
                </p>
                <div class="appointment-buttons">
                    <button class="btn btn-primary" id="free-appointment" style="padding: 1.5rem; flex-direction: column; gap: 0.5rem;">
                        <i class="fas fa-gift" style="font-size: 2rem;"></i>
                        <span style="font-size: 1.1rem;">免费预约</span>
                        <span style="font-size: 0.9rem; opacity: 0.9;">每周限时免费咨询</span>
                    </button>
                    <button class="btn btn-ai" id="paid-appointment" style="padding: 1.5rem; flex-direction: column; gap: 0.5rem;">
                        <i class="fas fa-star" style="font-size: 2rem;"></i>
                        <span style="font-size: 1.1rem;">付费预约</span>
                        <span style="font-size: 0.9rem; opacity: 0.9;">专业一对一咨询</span>
                    </button>
                </div>
                <button class="btn btn-outline" id="close-appointment-modal" style="width: 100%; margin-top: 1rem;">
                    <i class="fas fa-times"></i> 取消
                </button>
            </div>
        </div>

        <!-- 匿名树洞模态框 -->
        <div class="tree-hole-modal" id="tree-hole-modal">
            <div class="tree-hole-container">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h2 style="font-family: 'Comfortaa', cursive; color: #2C3E50;">
                        <i class="fas fa-tree"></i> 匿名树洞
                    </h2>
                    <button class="timer-close-btn" id="close-tree-hole-modal">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="tree-hole-notice">
                    <i class="fas fa-shield-alt"></i>
                    <p>这是一个完全匿名的安全空间，你可以放心倾诉。所有内容都是匿名的，无人知道你是谁。</p>
                </div>
                
                <div class="tree-hole-tabs">
                    <button class="tree-hole-tab active" data-tab="post">
                        <i class="fas fa-pen"></i> 倾诉
                    </button>
                    <button class="tree-hole-tab" data-tab="view">
                        <i class="fas fa-comments"></i> 树洞墙
                    </button>
                </div>
                
                <!-- 倾诉界面 -->
                <div class="tree-hole-tab-content active" id="tree-hole-post">
                    <div class="tree-hole-post-form">
                        <label for="tree-hole-category">选择类型（可选）</label>
                        <select id="tree-hole-category" class="form-input">
                            <option value="">不选择</option>
                            <option value="学业压力">学业压力</option>
                            <option value="人际关系">人际关系</option>
                            <option value="家庭问题">家庭问题</option>
                            <option value="情感困扰">情感困扰</option>
                            <option value="自我认知">自我认知</option>
                            <option value="其他">其他</option>
                        </select>
                        
                        <label for="tree-hole-content" style="margin-top: 1rem;">说出你的心里话</label>
                        <textarea id="tree-hole-content" class="tree-hole-textarea" placeholder="在这里，你可以说出任何心里话，无需担心被评判...&#10;&#10;你的感受是真实的，值得被看见和理解。" maxlength="500"></textarea>
                        <div class="char-count"><span id="tree-hole-char-count">0</span>/500</div>
                        
                        <button class="btn btn-primary" id="submit-tree-hole" style="width: 100%; margin-top: 1rem;">
                            <i class="fas fa-paper-plane"></i> 匿名发送
                        </button>
                    </div>
                </div>
                
                <!-- 树洞墙界面 -->
                <div class="tree-hole-tab-content" id="tree-hole-view">
                    <div class="tree-hole-filter">
                        <label>筛选类型：</label>
                        <select id="tree-hole-filter" class="form-input" style="flex: 1;">
                            <option value="all">全部</option>
                            <option value="学业压力">学业压力</option>
                            <option value="人际关系">人际关系</option>
                            <option value="家庭问题">家庭问题</option>
                            <option value="情感困扰">情感困扰</option>
                            <option value="自我认知">自我认知</option>
                            <option value="其他">其他</option>
                        </select>
                    </div>
                    
                    <div class="tree-hole-posts" id="tree-hole-posts">
                        <!-- 树洞内容将通过JavaScript动态加载 -->
                    </div>
                </div>
            </div>
        </div>

        <!-- 同伴支持模态框 -->
        <div class="peer-support-modal" id="peer-support-modal">
            <div class="peer-support-container">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h2 style="font-family: 'Comfortaa', cursive; color: #2C3E50;">
                        <i class="fas fa-user-friends"></i> 同伴支持系统
                    </h2>
                    <button class="timer-close-btn" id="close-peer-support-modal">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="peer-support-notice">
                    <i class="fas fa-heart"></i>
                    <p>我们会根据你的经历和需求，为你匹配有相似经历的伙伴。你们可以互相支持、理解和鼓励。</p>
                </div>
                
                <div class="peer-support-tabs">
                    <button class="peer-support-tab active" data-tab="match">
                        <i class="fas fa-search"></i> 寻找同伴
                    </button>
                    <button class="peer-support-tab" data-tab="my-peers">
                        <i class="fas fa-users"></i> 我的同伴
                    </button>
                </div>
                
                <!-- 匹配界面 -->
                <div class="peer-support-tab-content active" id="peer-match">
                    <div class="peer-match-form">
                        <label for="peer-concern">你目前主要关心的话题</label>
                        <select id="peer-concern" class="form-input" multiple size="5">
                            <option value="学业压力">学业压力</option>
                            <option value="人际关系">人际关系</option>
                            <option value="家庭问题">家庭问题</option>
                            <option value="情感困扰">情感困扰</option>
                            <option value="自我认知">自我认知</option>
                            <option value="焦虑情绪">焦虑情绪</option>
                            <option value="抑郁情绪">抑郁情绪</option>
                            <option value="拖延问题">拖延问题</option>
                        </select>
                        <small style="color: #666; display: block; margin-top: 0.5rem;">
                            按住 Ctrl 或 Cmd 可多选
                        </small>
                        
                        <label for="peer-about" style="margin-top: 1rem;">简单介绍自己（可选，匿名展示）</label>
                        <textarea id="peer-about" class="tree-hole-textarea" placeholder="例如：我是一名高二学生，最近在学习上遇到了一些困难..." maxlength="200"></textarea>
                        <div class="char-count"><span id="peer-about-char-count">0</span>/200</div>
                        
                        <button class="btn btn-primary" id="find-peer-match" style="width: 100%; margin-top: 1rem;">
                            <i class="fas fa-magic"></i> 开始匹配
                        </button>
                    </div>
                    
                    <div class="peer-match-results" id="peer-match-results" style="display: none;">
                        <h3 style="color: #2C3E50; margin-bottom: 1rem;">
                            <i class="fas fa-star"></i> 为你找到的同伴
                        </h3>
                        <div id="peer-matches-list">
                            <!-- 匹配结果将通过JavaScript动态加载 -->
                        </div>
                    </div>
                </div>
                
                <!-- 我的同伴界面 -->
                <div class="peer-support-tab-content" id="peer-my-peers">
                    <div id="my-peers-list">
                        <!-- 我的同伴列表将通过JavaScript动态加载 -->
                    </div>
                </div>
            </div>
        </div>

        <!-- 图书馆模态框 -->
        <div class="library-modal" id="library-modal">
            <div class="library-container">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h2 style="font-family: 'Comfortaa', cursive; color: #2C3E50;">
                        <i class="fas fa-book"></i> 心理图书馆
                    </h2>
                    <button class="timer-close-btn" id="close-library-modal">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <!-- 用户积分显示 -->
                <div class="library-points-display">
                    <i class="fas fa-coins"></i>
                    <span>我的积分: <strong id="user-points">100</strong></span>
                </div>
                
                <!-- 推荐图书轮播海报 -->
                <div class="library-banner-container">
                    <div class="library-banner-slider" id="library-banner-slider">
                        <!-- 海报将通过JavaScript动态生成 -->
                    </div>
                    <button class="library-banner-prev" id="banner-prev">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <button class="library-banner-next" id="banner-next">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                    <div class="library-banner-dots" id="banner-dots">
                        <!-- 指示点将通过JavaScript动态生成 -->
                    </div>
                </div>
                
                <!-- 图书分类标签 -->
                <div class="library-tabs">
                    <button class="library-tab active" data-category="all">
                        <i class="fas fa-th"></i> 全部
                    </button>
                    <button class="library-tab" data-category="emotion">
                        <i class="fas fa-heart"></i> 情绪管理
                    </button>
                    <button class="library-tab" data-category="growth">
                        <i class="fas fa-seedling"></i> 成长发展
                    </button>
                    <button class="library-tab" data-category="relationship">
                        <i class="fas fa-users"></i> 人际关系
                    </button>
                    <button class="library-tab" data-category="learning">
                        <i class="fas fa-graduation-cap"></i> 学习方法
                    </button>
                </div>
                
                <!-- 图书列表 -->
                <div class="library-books-grid" id="library-books-grid">
                    <!-- 图书卡片将通过JavaScript动态生成 -->
                </div>
            </div>
        </div>

        <!-- 图书详情模态框 -->
        <div class="book-detail-modal" id="book-detail-modal">
            <div class="book-detail-container">
                <button class="timer-close-btn" id="close-book-detail">
                    <i class="fas fa-times"></i>
                </button>
                <div id="book-detail-content">
                    <!-- 图书详情将通过JavaScript动态生成 -->
                </div>
            </div>
        </div>

        <!-- 情绪追踪页面 -->
        <div id="mood-tracker" class="page-container">
            <section class="page-header">
                <h1><i class="fas fa-chart-pie"></i> 情绪追踪</h1>
                <p>记录你的心情，了解自己的情绪变化，这是关爱自己的第一步 💕</p>
            </section>
            
            <div class="mood-container">
                <div class="mood-selector">
                    <h3>今天的心情如何？</h3>
                    <p style="color: #666; font-size: 0.9rem; margin-bottom: 1rem;">无论心情如何，都值得被记录和关心 🌸</p>
                    <div class="mood-options">
                        <div class="mood-option" data-mood="happy" data-score="5">
                            <i class="fas fa-laugh-beam"></i>
                            <span>开心</span>
                        </div>
                        <div class="mood-option" data-mood="calm" data-score="4">
                            <i class="fas fa-smile"></i>
                            <span>平静</span>
                        </div>
                        <div class="mood-option" data-mood="sad" data-score="2">
                            <i class="fas fa-sad-tear"></i>
                            <span>难过</span>
                        </div>
                        <div class="mood-option" data-mood="anxious" data-score="2">
                            <i class="fas fa-flushed"></i>
                            <span>焦虑</span>
                        </div>
                        <div class="mood-option" data-mood="angry" data-score="1">
                            <i class="fas fa-angry"></i>
                            <span>生气</span>
                        </div>
                    </div>
                    
                    <div style="margin-top: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.5rem; color: #2C3E50; font-weight: 600;">
                            <i class="fas fa-pen"></i> 记录今天的心情（可选）
                        </label>
                        <textarea id="mood-note" placeholder="写下你的感受、发生了什么事情..." style="width: 100%; min-height: 100px; padding: 0.8rem; border: 2px solid rgba(139, 154, 91, 0.3); border-radius: 10px; font-size: 0.95rem; resize: vertical;" maxlength="500"></textarea>
                        <div style="text-align: right; color: #999; font-size: 0.85rem; margin-top: 0.3rem;">
                            <span id="mood-note-count">0</span>/500
                        </div>
                    </div>
                    
                    <button class="btn btn-primary" id="save-mood-btn" style="width: 100%; margin-top: 1rem; display: none;">
                        <i class="fas fa-save"></i> 保存今天的心情
                    </button>
                </div>
                
                <div class="mood-history">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3>心情记录</h3>
                        <button class="btn btn-outline" id="view-weekly-report-btn" style="padding: 0.5rem 1rem; font-size: 0.9rem;">
                            <i class="fas fa-chart-line"></i> 周报表
                        </button>
                    </div>
                    <div class="mood-records-list" id="mood-records-list">
                        <p style="text-align: center; color: #999; padding: 2rem;">还没有心情记录，选择一个心情开始记录吧 💝</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 周报表模态框 -->
        <div class="library-modal" id="weekly-report-modal">
            <div class="library-container" style="max-width: 900px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h2 style="font-family: 'Comfortaa', cursive; color: #2C3E50;">
                        <i class="fas fa-chart-line"></i> 本周情绪分析报告
                    </h2>
                    <button class="timer-close-btn" id="close-weekly-report-modal">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div id="weekly-report-content">
                    <!-- 周报表内容将通过JavaScript动态生成 -->
                </div>
            </div>
        </div>

        <!-- 同学交流页面 -->
        <div id="student-chat" class="page-container">
            <section class="page-header">
                <h1><i class="fas fa-comments"></i> 同学交流</h1>
                <p>和同学们分享学习心得，互相鼓励，一起成长 🌟</p>
            </section>
            
            <div class="chat-container">
                <div class="chat-sidebar">
                    <div class="chat-header-actions">
                        <button class="btn btn-primary" id="add-friend-btn" style="flex: 1; padding: 0.6rem;">
                            <i class="fas fa-user-plus"></i> 添加好友
                        </button>
                        <button class="btn btn-outline" id="create-group-btn" style="flex: 1; padding: 0.6rem;">
                            <i class="fas fa-users"></i> 创建群聊
                        </button>
                    </div>
                    
                    <div style="margin-top: 1rem;">
                        <h3 style="font-family: 'Comfortaa', cursive; color: #2C3E50; margin-bottom: 0.5rem; font-size: 1rem;">
                            <i class="fas fa-user-friends"></i> 我的好友
                        </h3>
                        <div class="friend-list" id="friend-list">
                            <!-- 好友列表将通过JavaScript动态加载 -->
                        </div>
                    </div>
                    
                    <div style="margin-top: 1.5rem;">
                        <h3 style="font-family: 'Comfortaa', cursive; color: #2C3E50; margin-bottom: 0.5rem; font-size: 1rem;">
                            <i class="fas fa-users"></i> 我的群聊
                        </h3>
                        <div class="group-list" id="group-list">
                            <!-- 群聊列表将通过JavaScript动态加载 -->
                        </div>
                    </div>
                </div>
                
                <div class="chat-main">
                    <div class="chat-messages" id="chat-messages">
                        <div class="message system">
                            <p>选择一个好友或群聊开始对话 💬</p>
                        </div>
                    </div>
                    
                    <div class="chat-input">
                        <div class="file-upload-btn" id="file-upload-btn" title="发送文件">
                            <i class="fas fa-paperclip"></i>
                        </div>
                        <input type="text" id="chat-message-input" autocomplete="off" placeholder="输入消息...">
                        <button class="btn btn-primary" id="send-message-btn">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 添加好友模态框 -->
        <div class="appointment-modal" id="add-friend-modal">
            <div class="appointment-container">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h2 style="font-family: 'Comfortaa', cursive; color: #2C3E50;">添加好友</h2>
                    <button class="timer-close-btn" id="close-add-friend-modal" style="position: relative; top: 0; right: 0;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="profile-form-group">
                    <label>我的交流号</label>
                    <input type="text" id="my-chat-id" readonly value="XY123456" style="background: #f5f5f5;">
                    <button class="btn btn-outline" id="copy-chat-id" style="width: 100%; margin-top: 0.5rem;">
                        <i class="fas fa-copy"></i> 复制交流号
                    </button>
                </div>
                <div class="profile-form-group">
                    <label>输入好友交流号</label>
                    <input type="text" id="friend-chat-id" placeholder="请输入好友的交流号">
                </div>
                <button class="btn btn-primary" id="search-friend-btn" style="width: 100%;">
                    <i class="fas fa-search"></i> 搜索并添加
                </button>
            </div>
        </div>
        
        <!-- 创建群聊模态框 -->
        <div class="appointment-modal" id="create-group-modal">
            <div class="appointment-container" style="max-width: 600px; max-height: 80vh; overflow-y: auto;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; position: sticky; top: 0; background: white; z-index: 10; padding-bottom: 1rem;">
                    <h2 style="font-family: 'Comfortaa', cursive; color: #2C3E50;">
                        <i class="fas fa-users"></i> 创建群聊
                    </h2>
                    <button class="timer-close-btn" id="close-create-group-modal" style="position: relative; top: 0; right: 0;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="profile-form-group">
                    <label for="group-name-input">群聊名称</label>
                    <input type="text" id="group-name-input" placeholder="给群聊起个名字吧~" maxlength="30">
                </div>
                
                <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; margin-bottom: 0.8rem; font-weight: 600; color: #2C3E50;">
                        <i class="fas fa-user-plus"></i> 选择群成员（至少选择1人）
                    </label>
                    <div style="background: rgba(139, 154, 91, 0.05); border-radius: 10px; padding: 1rem; margin-bottom: 1rem;">
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                            <input type="text" id="search-friend-input" placeholder="搜索好友..." style="flex: 1; padding: 0.5rem; border: 1px solid #ddd; border-radius: 5px;">
                            <button class="btn btn-outline" id="select-all-friends-btn" style="padding: 0.5rem 1rem; font-size: 0.9rem;">
                                全选
                            </button>
                        </div>
                        <div style="font-size: 0.85rem; color: #666;">
                            已选择 <span id="selected-count" style="color: #FF6B6B; font-weight: 600;">0</span> 人
                        </div>
                    </div>
                    
                    <div id="friends-selector-list" style="max-height: 300px; overflow-y: auto;">
                        <!-- 好友列表将通过JavaScript动态生成 -->
                    </div>
                </div>
                
                <button class="btn btn-primary" id="confirm-create-group-btn" style="width: 100%;">
                    <i class="fas fa-check"></i> 创建群聊
                </button>
            </div>
        </div>
        
        <!-- 消息通知中心模态框 -->
        <div class="appointment-modal" id="notification-center-modal">
            <div class="appointment-container" style="max-width: 600px; max-height: 80vh; overflow-y: auto;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h2 style="font-family: 'Comfortaa', cursive; color: #2C3E50;">
                        <i class="fas fa-bell"></i> 消息通知
                    </h2>
                    <button class="timer-close-btn" id="close-notification-center" style="position: relative; top: 0; right: 0;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div id="notification-list">
                    <!-- 通知列表将通过JavaScript动态生成 -->
                </div>
            </div>
        </div>

        <!-- 学习小组自习界面 -->
        <div class="study-session-container" id="study-session-container">
            <div class="study-session-header">
                <div>
                    <h2 style="font-family: 'Comfortaa', cursive; color: #2C3E50; margin-bottom: 0.5rem;">
                        <i class="fas fa-users"></i> 学习小组自习
                    </h2>
                    <div class="study-members-display" id="study-members-display">
                        <!-- 成员头像将通过JavaScript动态加载 -->
                    </div>
                </div>
                <div style="display: flex; align-items: center; gap: 1.5rem;">
                    <div class="study-timer-display" id="study-timer-display">00:00:00</div>
                    <button class="btn btn-outline" id="exit-study-session">
                        <i class="fas fa-sign-out-alt"></i> 退出自习
                    </button>
                </div>
            </div>
            
            <div class="study-session-main">
                <div class="study-content-area">
                    <div class="healing-image-carousel" id="healing-carousel">
                        <!-- 图片轮播将通过JavaScript加载 -->
                    </div>
                    <div style="text-align: center; padding: 2rem;">
                        <h3 style="font-family: 'Comfortaa', cursive; color: #2C3E50; margin-bottom: 1rem;">
                            专注学习，共同进步 💪
                        </h3>
                        <p style="color: #666; line-height: 1.8;">
                            和小组伙伴一起学习，互相监督，共同成长。记住，每学习1小时会休息15分钟，这是为了让你更好地保持专注。
                        </p>
                    </div>
                    
                    <!-- 摄像头监督区域 -->
                    <div class="camera-supervision">
                        <h4 style="font-family: 'Comfortaa', cursive; color: #2C3E50; margin-bottom: 1rem; text-align: center;">
                            <i class="fas fa-video"></i> 摄像头监督
                        </h4>
                        <p style="color: #666; text-align: center; margin-bottom: 1rem; font-size: 0.9rem;">
                            开启摄像头可以帮助你保持专注，监督自己的学习状态 📹
                        </p>
                        <div class="camera-preview" id="camera-preview">
                            <div id="camera-placeholder">
                                <i class="fas fa-video-slash" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                                <p>摄像头未开启</p>
                            </div>
                            <video id="camera-video" autoplay playsinline style="display: none;"></video>
                        </div>
                        <div class="camera-controls">
                            <button class="btn btn-primary" id="start-camera-btn">
                                <i class="fas fa-video"></i> 开启摄像头
                            </button>
                            <button class="btn btn-outline" id="stop-camera-btn" style="display: none;">
                                <i class="fas fa-video-slash"></i> 关闭摄像头
                            </button>
                        </div>
                        <p style="color: #999; font-size: 0.85rem; text-align: center; margin-top: 1rem;">
                            <i class="fas fa-lock"></i> 隐私保护：摄像头画面仅在本地显示，不会上传或保存
                        </p>
                    </div>
                </div>
                
                <div class="study-sidebar">
                    <div class="study-controls">
                        <div class="music-control" id="study-music-control">
                            <i class="fas fa-music"></i>
                            <span id="study-music-status">开启轻音乐</span>
                            <i class="fas fa-volume-up" id="study-music-icon"></i>
                        </div>
                        <div class="study-status" id="study-status">
                            <div style="font-weight: 600; color: #2C3E50; margin-bottom: 0.5rem;">学习状态</div>
                            <div id="study-status-text">准备开始</div>
                        </div>
                    </div>
                    
                    <div class="study-chat-area" id="study-chat-area">
                        <h4 style="font-family: 'Comfortaa', cursive; color: #2C3E50; margin-bottom: 0.5rem;">
                            <i class="fas fa-comments"></i> 小组交流
                        </h4>
                        <div class="study-chat-messages" id="study-chat-messages">
                            <div class="study-chat-disabled" id="study-chat-disabled">
                                学习期间无法交流，休息时间可以和小组成员聊天 💬
                            </div>
                        </div>
                        <div class="chat-input" id="study-chat-input" style="display: none;">
                            <input type="text" id="study-chat-message" placeholder="输入消息...">
                            <button class="btn btn-primary" id="send-study-message">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 兴趣社区页面 -->
        <div id="interest-community" class="page-container">
            <section class="page-header">
                <h1><i class="fas fa-users"></i> 兴趣社区</h1>
                <p>分享你的生活，发现有趣的灵魂 💫</p>
            </section>
            
            <!-- 功能按钮 -->
            <div style="margin-bottom: 1.5rem; text-align: center; display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                <button class="btn btn-primary" id="create-post-btn" style="padding: 0.8rem 2rem; font-size: 1rem;">
                    <i class="fas fa-plus-circle"></i> 发布动态
                </button>
                <button class="btn btn-outline" id="create-group-btn-community" style="padding: 0.8rem 2rem; font-size: 1rem;">
                    <i class="fas fa-users"></i> 创建兴趣小组
                </button>
            </div>
            
            <!-- 兴趣小组区域 -->
            <div style="background: rgba(255, 255, 255, 0.95); border-radius: 20px; padding: 2rem; margin-bottom: 2rem; box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15); border: 2px solid rgba(139, 154, 91, 0.2);">
                <h2 style="font-family: 'Comfortaa', cursive; color: #2C3E50; margin-bottom: 1rem;">
                    <i class="fas fa-users"></i> 兴趣小组
                </h2>
                <p style="color: #666; margin-bottom: 1.5rem;">加入志同道合的小组，一起分享兴趣爱好 🌟</p>
                <div class="posts-container" id="interest-groups-container">
                    <!-- 兴趣小组将通过JavaScript动态加载 -->
                </div>
            </div>
            
            <!-- 动态帖子区域 -->
            <div style="background: rgba(255, 255, 255, 0.95); border-radius: 20px; padding: 2rem; box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15); border: 2px solid rgba(139, 154, 91, 0.2);">
                <h2 style="font-family: 'Comfortaa', cursive; color: #2C3E50; margin-bottom: 1rem;">
                    <i class="fas fa-newspaper"></i> 社区动态
                </h2>
                <div class="posts-container" id="posts-container">
                    <!-- 帖子将通过JavaScript动态加载 -->
                </div>
            </div>
        </div>
        
        <!-- 发帖模态框 -->
        <div class="appointment-modal" id="create-post-modal">
            <div class="appointment-container" style="max-width: 600px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h2 style="font-family: 'Comfortaa', cursive; color: #2C3E50;">
                        <i class="fas fa-pen"></i> 发布动态
                    </h2>
                    <button class="timer-close-btn" id="close-create-post-modal" style="position: relative; top: 0; right: 0;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="profile-form-group">
                    <label>标题</label>
                    <input type="text" id="post-title" placeholder="给你的动态起个标题吧~" maxlength="50">
                </div>
                <div class="profile-form-group">
                    <label>内容</label>
                    <textarea id="post-content" placeholder="分享你的想法、心情或有趣的事..." style="min-height: 150px; resize: vertical;" maxlength="500"></textarea>
                </div>
                <div class="profile-form-group">
                    <label>选择话题</label>
                    <select id="post-topic" style="width: 100%; padding: 0.8rem; border: 2px solid rgba(139, 154, 91, 0.3); border-radius: 10px; font-size: 1rem;">
                        <option value="学习分享">📚 学习分享</option>
                        <option value="心情日记">💭 心情日记</option>
                        <option value="兴趣爱好">🎨 兴趣爱好</option>
                        <option value="生活日常">🌸 生活日常</option>
                        <option value="求助互助">🤝 求助互助</option>
                    </select>
                </div>
                <button class="btn btn-primary" id="publish-post-btn" style="width: 100%; margin-top: 1rem;">
                    <i class="fas fa-paper-plane"></i> 发布
                </button>
            </div>
        </div>
        
        <!-- 帖子详情模态框 -->
        <div class="appointment-modal" id="post-detail-modal">
            <div class="appointment-container" style="max-width: 700px; max-height: 85vh; overflow-y: auto;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h2 style="font-family: 'Comfortaa', cursive; color: #2C3E50;">
                        <i class="fas fa-file-alt"></i> 动态详情
                    </h2>
                    <button class="timer-close-btn" id="close-post-detail-modal" style="position: relative; top: 0; right: 0;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div id="post-detail-content">
                    <!-- 帖子详情将通过JavaScript加载 -->
                </div>
            </div>
        </div>
        
        <!-- 用户资料模态框 -->
        <div class="appointment-modal" id="user-profile-modal">
            <div class="appointment-container" style="max-width: 500px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h2 style="font-family: 'Comfortaa', cursive; color: #2C3E50;">
                        <i class="fas fa-user"></i> 用户资料
                    </h2>
                    <button class="timer-close-btn" id="close-user-profile-modal" style="position: relative; top: 0; right: 0;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div id="user-profile-content">
                    <!-- 用户资料将通过JavaScript加载 -->
                </div>
            </div>
        </div>
        
        <!-- 创建兴趣小组模态框 -->
        <div class="appointment-modal" id="create-interest-group-modal">
            <div class="appointment-container" style="max-width: 600px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h2 style="font-family: 'Comfortaa', cursive; color: #2C3E50;">
                        <i class="fas fa-users"></i> 创建兴趣小组
                    </h2>
                    <button class="timer-close-btn" id="close-create-group-modal" style="position: relative; top: 0; right: 0;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="profile-form-group">
                    <label>小组名称</label>
                    <input type="text" id="group-name" placeholder="给你的兴趣小组起个名字~" maxlength="30">
                </div>
                <div class="profile-form-group">
                    <label>小组简介</label>
                    <textarea id="group-description" placeholder="介绍一下这个小组的主题和目标..." style="min-height: 100px; resize: vertical;" maxlength="200"></textarea>
                </div>
                <div class="profile-form-group">
                    <label>选择类别</label>
                    <select id="group-category" style="width: 100%; padding: 0.8rem; border: 2px solid rgba(139, 154, 91, 0.3); border-radius: 10px; font-size: 1rem;">
                        <option value="学习交流">📚 学习交流</option>
                        <option value="艺术创作">🎨 艺术创作</option>
                        <option value="运动健身">⚽ 运动健身</option>
                        <option value="音乐舞蹈">🎵 音乐舞蹈</option>
                        <option value="阅读写作">📖 阅读写作</option>
                        <option value="科技编程">💻 科技编程</option>
                        <option value="其他">🌟 其他</option>
                    </select>
                </div>
                <button class="btn btn-primary" id="create-group-submit-btn" style="width: 100%; margin-top: 1rem;">
                    <i class="fas fa-check"></i> 创建小组
                </button>
            </div>
        </div>
        
        <!-- 家长端页面 -->
        <div id="parent-dashboard" class="page-container" style="display: none;">
            <section class="page-header">
                <h1><i class="fas fa-user-friends"></i> 家长中心</h1>
                <p>关注孩子成长，助力健康发展 💝</p>
            </section>

            <div class="parent-dashboard-grid">
                <!-- 成长报告 -->
                <div class="parent-card">
                    <div class="parent-card-header">
                        <h3><i class="fas fa-chart-line"></i> 成长报告</h3>
                        <span class="update-time">最后更新：今天</span>
                    </div>
                    <div class="parent-card-content">
                        <div class="report-summary">
                            <div class="report-item">
                                <div class="report-label">学习时长</div>
                                <div class="report-value">45分钟 <span class="trend up">↑ 15%</span></div>
                            </div>
                            <div class="report-item">
                                <div class="report-label">情绪状态</div>
                                <div class="report-value">良好 <span class="emoji">😊</span></div>
                            </div>
                            <div class="report-item">
                                <div class="report-label">社交互动</div>
                                <div class="report-value">活跃 <span class="trend up">↑</span></div>
                            </div>
                        </div>
                        <button class="btn btn-primary" id="view-full-report">
                            <i class="fas fa-file-alt"></i> 查看完整报告
                        </button>
                    </div>
                </div>

                <!-- 亲子沟通指导 -->
                <div class="parent-card">
                    <div class="parent-card-header">
                        <h3><i class="fas fa-comments"></i> 亲子沟通指导</h3>
                    </div>
                    <div class="parent-card-content">
                        <div class="communication-tips">
                            <div class="tip-item">
                                <i class="fas fa-lightbulb"></i>
                                <div>
                                    <h4>本周建议</h4>
                                    <p>多倾听孩子的想法，给予肯定和鼓励</p>
                                </div>
                            </div>
                            <div class="tip-item">
                                <i class="fas fa-heart"></i>
                                <div>
                                    <h4>推荐活动</h4>
                                    <p>周末户外运动，促进亲子关系</p>
                                </div>
                            </div>
                        </div>
                        <button class="btn btn-outline" id="more-communication-tips">
                            <i class="fas fa-book"></i> 更多技巧
                        </button>
                    </div>
                </div>

                <!-- 安全监控 -->
                <div class="parent-card">
                    <div class="parent-card-header">
                        <h3><i class="fas fa-shield-alt"></i> 安全监控</h3>
                    </div>
                    <div class="parent-card-content">
                        <div class="safety-settings">
                            <div class="setting-item">
                                <div class="setting-info">
                                    <i class="fas fa-clock"></i>
                                    <span>每日使用时长</span>
                                </div>
                                <div class="setting-value">2小时</div>
                            </div>
                            <div class="setting-item">
                                <div class="setting-info">
                                    <i class="fas fa-filter"></i>
                                    <span>内容过滤</span>
                                </div>
                                <div class="setting-value">已开启</div>
                            </div>
                            <div class="setting-item">
                                <div class="setting-info">
                                    <i class="fas fa-bell"></i>
                                    <span>异常提醒</span>
                                </div>
                                <div class="setting-value">已开启</div>
                            </div>
                        </div>
                        <button class="btn btn-outline" id="safety-settings-btn">
                            <i class="fas fa-cog"></i> 设置
                        </button>
                    </div>
                </div>

                <!-- 专家咨询 -->
                <div class="parent-card">
                    <div class="parent-card-header">
                        <h3><i class="fas fa-user-md"></i> 专家咨询</h3>
                    </div>
                    <div class="parent-card-content">
                        <p style="color: #666; margin-bottom: 1rem;">与专业心理咨询师交流，获取个性化建议</p>
                        <button class="btn btn-primary" id="parent-consult-btn">
                            <i class="fas fa-phone"></i> 预约咨询
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 教师端页面 -->
        <div id="teacher-dashboard" class="page-container" style="display: none;">
            <section class="page-header">
                <h1><i class="fas fa-chalkboard-teacher"></i> 教师工作台</h1>
                <p>用心呵护每一位学生的成长 🌱</p>
            </section>

            <div class="teacher-dashboard-grid">
                <!-- 班级管理 -->
                <div class="teacher-card full-width">
                    <div class="teacher-card-header">
                        <h3><i class="fas fa-users"></i> 我的班级</h3>
                        <button class="btn btn-primary btn-sm" id="create-class-btn">
                            <i class="fas fa-plus"></i> 创建班级
                        </button>
                    </div>
                    <div class="teacher-card-content">
                        <div class="class-list" id="teacher-class-list">
                            <!-- 班级列表将通过JavaScript生成 -->
                        </div>
                    </div>
                </div>

                <!-- 团体辅导 -->
                <div class="teacher-card">
                    <div class="teacher-card-header">
                        <h3><i class="fas fa-project-diagram"></i> 团体辅导</h3>
                    </div>
                    <div class="teacher-card-content">
                        <div class="guidance-stats">
                            <div class="stat-item">
                                <div class="stat-number">3</div>
                                <div class="stat-label">进行中</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-number">12</div>
                                <div class="stat-label">已完成</div>
                            </div>
                        </div>
                        <button class="btn btn-primary" id="start-group-guidance-btn">
                            <i class="fas fa-play"></i> 开始辅导
                        </button>
                    </div>
                </div>

                <!-- 学情分析 -->
                <div class="teacher-card">
                    <div class="teacher-card-header">
                        <h3><i class="fas fa-chart-pie"></i> 学情分析</h3>
                    </div>
                    <div class="teacher-card-content">
                        <div class="analysis-preview">
                            <canvas id="class-mood-chart" width="200" height="150"></canvas>
                        </div>
                        <button class="btn btn-outline" id="detailed-analysis-btn">
                            <i class="fas fa-chart-bar"></i> 详细分析
                        </button>
                    </div>
                </div>

                <!-- 学生动态 -->
                <div class="teacher-card full-width">
                    <div class="teacher-card-header">
                        <h3><i class="fas fa-bell"></i> 学生动态</h3>
                    </div>
                    <div class="teacher-card-content">
                        <div class="student-activities" id="student-activities">
                            <!-- 学生动态将通过JavaScript生成 -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 管理员端页面 -->
        <div id="admin-dashboard" class="page-container" style="display: none;">
            <section class="page-header">
                <h1><i class="fas fa-user-shield"></i> 管理员控制台</h1>
                <p>系统管理与数据监控 🛡️</p>
            </section>

            <div class="admin-dashboard-grid">
                <!-- 系统概览 -->
                <div class="admin-card">
                    <div class="admin-card-header">
                        <h3><i class="fas fa-tachometer-alt"></i> 系统概览</h3>
                    </div>
                    <div class="admin-card-content">
                        <div class="admin-stats">
                            <div class="admin-stat-item">
                                <i class="fas fa-users"></i>
                                <div>
                                    <div class="stat-number">1,234</div>
                                    <div class="stat-label">总用户数</div>
                                </div>
                            </div>
                            <div class="admin-stat-item">
                                <i class="fas fa-user-graduate"></i>
                                <div>
                                    <div class="stat-number">856</div>
                                    <div class="stat-label">学生</div>
                                </div>
                            </div>
                            <div class="admin-stat-item">
                                <i class="fas fa-user-friends"></i>
                                <div>
                                    <div class="stat-number">325</div>
                                    <div class="stat-label">家长</div>
                                </div>
                            </div>
                            <div class="admin-stat-item">
                                <i class="fas fa-chalkboard-teacher"></i>
                                <div>
                                    <div class="stat-number">53</div>
                                    <div class="stat-label">教师</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 用户管理 -->
                <div class="admin-card">
                    <div class="admin-card-header">
                        <h3><i class="fas fa-users-cog"></i> 用户管理</h3>
                    </div>
                    <div class="admin-card-content">
                        <button class="btn btn-outline full-width mb-1" id="manage-users-btn">
                            <i class="fas fa-list"></i> 查看用户列表
                        </button>
                        <button class="btn btn-outline full-width mb-1" id="manage-roles-btn">
                            <i class="fas fa-user-tag"></i> 角色权限管理
                        </button>
                        <button class="btn btn-outline full-width" id="audit-log-btn">
                            <i class="fas fa-history"></i> 操作日志
                        </button>
                    </div>
                </div>

                <!-- 内容管理 -->
                <div class="admin-card">
                    <div class="admin-card-header">
                        <h3><i class="fas fa-file-alt"></i> 内容管理</h3>
                    </div>
                    <div class="admin-card-content">
                        <button class="btn btn-outline full-width mb-1" id="manage-posts-btn">
                            <i class="fas fa-comments"></i> 帖子审核
                        </button>
                        <button class="btn btn-outline full-width mb-1" id="manage-treehole-btn">
                            <i class="fas fa-tree"></i> 树洞监控
                        </button>
                        <button class="btn btn-outline full-width" id="manage-resources-btn">
                            <i class="fas fa-book"></i> 资源管理
                        </button>
                    </div>
                </div>

                <!-- 系统设置 -->
                <div class="admin-card">
                    <div class="admin-card-header">
                        <h3><i class="fas fa-cog"></i> 系统设置</h3>
                    </div>
                    <div class="admin-card-content">
                        <button class="btn btn-outline full-width mb-1" id="system-config-btn">
                            <i class="fas fa-sliders-h"></i> 系统配置
                        </button>
                        <button class="btn btn-outline full-width mb-1" id="backup-btn">
                            <i class="fas fa-database"></i> 数据备份
                        </button>
                        <button class="btn btn-outline full-width" id="security-settings-btn">
                            <i class="fas fa-lock"></i> 安全设置
                        </button>
                    </div>
                </div>

                <!-- 数据统计 -->
                <div class="admin-card full-width">
                    <div class="admin-card-header">
                        <h3><i class="fas fa-chart-line"></i> 数据统计</h3>
                    </div>
                    <div class="admin-card-content">
                        <div class="data-charts">
                            <div class="chart-container">
                                <h4>用户活跃度</h4>
                                <canvas id="user-activity-chart" width="300" height="200"></canvas>
                            </div>
                            <div class="chart-container">
                                <h4>功能使用情况</h4>
                                <canvas id="feature-usage-chart" width="300" height="200"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 页脚 -->
        <footer class="footer">
            <p>心屿学院 © 2023 | 青少年心理健康学习平台 | 如需支持，请访问心理小岛</p>
        </footer>
    </div>
    
    <!-- 老板键 -->
    <div class="boss-key" id="boss-key">
        <i class="fas fa-magic"></i>
    </div>
    
    <!-- 登录/注册模态框 -->
    <div class="auth-modal" id="auth-modal">
        <div class="auth-container">
            <div class="auth-header">
                心屿学院
            </div>
            <div class="auth-tabs">
                <div class="auth-tab active" data-tab="login">登录</div>
                <div class="auth-tab" data-tab="register">注册</div>
            </div>
            
            <div class="auth-form">
                <form id="login-form">
                    <div class="form-group">
                        <label class="form-label" for="username">手机号</label>
                        <input type="tel" id="username" name="username" autocomplete="tel" class="form-input" placeholder="请输入手机号" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="password">密码</label>
                        <input type="password" id="password" name="password" autocomplete="current-password" class="form-input" placeholder="请输入密码" required>
                    </div>
                    <button type="submit" class="form-submit">进入学院</button>
                </form>
                
                <form id="register-form" style="display: none;">
                    <div class="demo-notice">
                        <strong>演示版本说明</strong>
                        这是一个演示版本，验证码功能已模拟。在实际项目中，验证码应由后端发送到手机。
                        <br><strong>测试验证码：123456</strong>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="reg-phone">手机号</label>
                        <input type="tel" id="reg-phone" name="reg-phone" autocomplete="tel" class="form-input" placeholder="请输入手机号" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="reg-username">用户名</label>
                        <input type="text" id="reg-username" name="reg-username" autocomplete="username" class="form-input" placeholder="请设置用户名" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="reg-code">验证码</label>
                        <div class="code-input-group">
                            <input type="text" id="reg-code" name="reg-code" class="form-input" placeholder="请输入验证码" required maxlength="6">
                            <button type="button" class="btn-code" id="send-code">发送验证码</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="reg-password">密码</label>
                        <input type="password" id="reg-password" name="reg-password" autocomplete="new-password" class="form-input" placeholder="请设置密码（6-20位）" required minlength="6" maxlength="20">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="reg-confirm">确认密码</label>
                        <input type="password" id="reg-confirm" name="reg-confirm" autocomplete="new-password" class="form-input" placeholder="请再次输入密码" required minlength="6" maxlength="20">
                    </div>
                    <button type="submit" class="form-submit">加入学院</button>
                </form>
                
                <div class="form-footer">
                    <p>忘记密码？<a href="#" id="forgot-password">点击找回</a></p>
                </div>
            </div>
        </div>
    </div>

    <!-- 霍格沃茨分院测试模态框 -->
    <div class="sorting-modal" id="sorting-modal">
        <div class="sorting-container">
            <div class="sorting-header">
                <h2><i class="fas fa-hat-wizard"></i> 霍格沃茨分院仪式</h2>
                <p>让分院帽为你寻找最适合的学院</p>
            </div>
            
            <div class="sorting-content" id="sorting-content">
                <!-- 欢迎界面 -->
                <div class="sorting-welcome" id="sorting-welcome">
                    <div class="sorting-hat-animation">🎩</div>
                    <h3>欢迎来到霍格沃茨心屿学院！</h3>
                    <p>在开始你的魔法学习之旅前，让分院帽为你选择最适合的学院。</p>
                    <div class="houses-preview">
                        <div class="house-preview" style="border-color: #7D1F1F;">
                            <div class="house-icon" style="background: #7D1F1F;">🦁</div>
                            <span>格兰芬多</span>
                        </div>
                        <div class="house-preview" style="border-color: #1F7D1F;">
                            <div class="house-icon" style="background: #1F7D1F;">🦡</div>
                            <span>赫奇帕奇</span>
                        </div>
                        <div class="house-preview" style="border-color: #1F1F7D;">
                            <div class="house-icon" style="background: #1F1F7D;">🦅</div>
                            <span>拉文克劳</span>
                        </div>
                        <div class="house-preview" style="border-color: #1F7D4F;">
                            <div class="house-icon" style="background: #1F7D4F;">🐍</div>
                            <span>斯莱特林</span>
                        </div>
                    </div>
                    <button class="btn btn-primary sorting-start-btn" id="sorting-start-btn">
                        <i class="fas fa-magic"></i> 开始分院测试
                    </button>
                </div>
                
                <!-- 测试问题界面 -->
                <div class="sorting-quiz" id="sorting-quiz" style="display: none;">
                    <div class="question-progress">
                        <div class="progress-bar">
                            <div class="progress-fill" id="sorting-progress"></div>
                        </div>
                        <span class="progress-text" id="sorting-progress-text">问题 1/8</span>
                    </div>
                    
                    <div class="question-content">
                        <h3 class="question-title" id="question-title"></h3>
                        <div class="question-options" id="question-options"></div>
                    </div>
                    
                    <div class="sorting-navigation">
                        <button class="btn btn-outline" id="sorting-prev-btn" style="display: none;">
                            <i class="fas fa-arrow-left"></i> 上一题
                        </button>
                    </div>
                </div>
                
                <!-- 结果界面 -->
                <div class="sorting-result" id="sorting-result" style="display: none;">
                    <div class="result-hat-animation">🎩✨</div>
                    <h3>分院帽的决定是...</h3>
                    <div class="result-house" id="result-house"></div>
                    <p class="result-description" id="result-description"></p>
                    <button class="btn btn-primary" id="sorting-complete-btn">
                        <i class="fas fa-check"></i> 进入学院
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 视频演示功能
        function startDemoVideo() {
            console.log('开始视频演示');
            const videoContainer = document.querySelector('.video-container');
            
            if (videoContainer) {
                videoContainer.innerHTML = 
                    '<div style="padding: 50px; text-align: center; background: #000; color: white; border-radius: 10px;">' +
                    '<i class="fas fa-play-circle" style="font-size: 60px; margin-bottom: 20px; color: #4CAF50;"></i>' +
                    '<h3>🎥 心理健康课堂演示</h3>' +
                    '<p>情绪管理与自我关怀 - 王心理老师</p>' +
                    '<p><small>在实际版本中，这里会播放实时课程视频</small></p>' +
                    '<button class="btn btn-primary" onclick="location.reload()" style="margin-top: 20px;">' +
                    '<i class="fas fa-redo"></i> 重新开始' +
                    '</button>' +
                    '</div>';
            }
        }

        // 全局错误处理
        window.addEventListener('error', function(e) {
            // 忽略CORS错误
            if (e.message && (e.message.includes('CORS') || e.message.includes('Access-Control-Allow-Origin'))) {
                console.log('忽略CORS策略错误');
                return;
            }
            console.error('全局错误:', e);
        });

        // 捕获未处理的Promise拒绝
        window.addEventListener('unhandledrejection', function(e) {
            if (e.reason && e.reason.message && 
                (e.reason.message.includes('CORS') || e.reason.message.includes('Access-Control-Allow-Origin'))) {
                e.preventDefault();
                console.log('忽略CORS相关的Promise拒绝');
                return;
            }
        });

        // 等待页面完全加载
        document.addEventListener('DOMContentLoaded', function() {
            console.log('心屿学院页面开始初始化...');

            // 生成动态草地
            function generateGrass() {
                const grassLayer = document.querySelector('.grass-layer');
                if (!grassLayer) return;
                
                // 清除现有草地
                const existingGrass = grassLayer.querySelectorAll('.grass-blade');
                existingGrass.forEach(blade => blade.remove());
                
                // 生成新的草地叶片
                for (let i = 0; i < 50; i++) {
                    const blade = document.createElement('div');
                    blade.className = 'grass-blade';
                    const left = Math.random() * 100;
                    const height = 20 + Math.random() * 40;
                    const delay = Math.random() * 3;
                    
                    blade.style.left = left + '%';
                    blade.style.height = height + 'px';
                    blade.style.animationDelay = delay + 's';
                    blade.style.animationDuration = (2 + Math.random() * 2) + 's';
                    
                    grassLayer.appendChild(blade);
                }
            }

            // 初始化草地
            generateGrass();

            // 添加小动物装饰元素
            function addCuteAnimals() {
                const animals = ['🐱', '🐶', '🐰', '🐻', '🦊', '🐼', '🐨', '🐯', '🦁', '🐸'];
                const illustrationBg = document.querySelector('.illustration-background');
                
                if (!illustrationBg) return;
                
                // 清除现有动物
                const existingAnimals = illustrationBg.querySelectorAll('.cute-animal');
                existingAnimals.forEach(animal => animal.remove());
                
                // 添加随机小动物
                for (let i = 0; i < 8; i++) {
                    const animal = document.createElement('div');
                    animal.className = 'cute-animal';
                    animal.textContent = animals[Math.floor(Math.random() * animals.length)];
                    
                    const left = 10 + Math.random() * 80;
                    const top = 20 + Math.random() * 60;
                    const delay = Math.random() * 6;
                    const duration = 4 + Math.random() * 4;
                    
                    animal.style.left = left + '%';
                    animal.style.top = top + '%';
                    animal.style.animationDelay = delay + 's';
                    animal.style.animationDuration = duration + 's';
                    
                    illustrationBg.appendChild(animal);
                }
            }

            // 初始化小动物
            addCuteAnimals();

            // AI工具功能
            document.getElementById('ai-homework-helper').addEventListener('click', function() {
                showNotification('AI作业助手功能开发中，敬请期待 📝', 'info');
            });

            document.getElementById('ai-mood-companion').addEventListener('click', function() {
                showNotification('AI心情陪伴功能开发中，敬请期待 💬', 'info');
            });

            document.getElementById('ai-study-plan').addEventListener('click', function() {
                showNotification('AI学习计划功能开发中，敬请期待 📚', 'info');
            });

            document.getElementById('ai-encouragement').addEventListener('click', function() {
                const dailyEncouragement = [
                    '今天也要加油哦！你比自己想象的更强大 💪',
                    '每一天都是新的开始，相信自己 🌟',
                    '你已经做得很好了，继续坚持下去 ✨',
                    '不要忘记，你身边有很多人在支持你 💕',
                    '慢慢来，不着急，你已经很棒了 🌸'
                ];
                const randomMsg = dailyEncouragement[Math.floor(Math.random() * dailyEncouragement.length)];
                showNotification(randomMsg, 'success');
            });

            // 视差滚动效果
            let lastScrollTop = 0;
            window.addEventListener('scroll', function() {
                const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                const illustrationBg = document.querySelector('.illustration-background');
                
                if (illustrationBg) {
                    // 背景层视差效果
                    const skyLayer = illustrationBg.querySelector('.sky-layer');
                    const grassLayer = illustrationBg.querySelector('.grass-layer');
                    const trees = illustrationBg.querySelectorAll('.tree');
                    const clouds = illustrationBg.querySelectorAll('.cloud');
                    const birds = illustrationBg.querySelectorAll('.bird');
                    
                    if (skyLayer) {
                        skyLayer.style.transform = `translateY(${scrollTop * 0.3}px)`;
                    }
                    
                    if (grassLayer) {
                        grassLayer.style.transform = `translateY(${scrollTop * 0.5}px)`;
                    }
                    
                    trees.forEach((tree, index) => {
                        const speed = 0.4 + (index * 0.1);
                        tree.style.transform = `translateY(${scrollTop * speed}px)`;
                    });
                    
                    clouds.forEach((cloud, index) => {
                        const speed = 0.2 + (index * 0.05);
                        cloud.style.transform = `translateX(${scrollTop * speed}px)`;
                    });
                    
                    birds.forEach((bird, index) => {
                        const speed = 0.15 + (index * 0.05);
                        bird.style.transform = `translateX(${scrollTop * speed}px)`;
                    });
                }
                
                lastScrollTop = scrollTop;
            });

            // 验证码相关变量
            let verificationCode = '123456'; // 固定验证码，方便测试
            let codeTimer = null;
            let countdown = 60;

            // 用户管理系统 - 已连接真实API
            class UserManager {
                constructor() {
                    this.currentUser = null;
                    this.token = localStorage.getItem('heartland_token');
                }
                
                async login(phone, password) {
                    try {
                        const result = await api.login(phone, password);
                        
                        if (result.success) {
                            this.currentUser = result.data.user;
                            this.token = result.data.token;
                            api.setToken(this.token);
                            localStorage.setItem('heartland_token', this.token);
                            localStorage.setItem('heartland_user', JSON.stringify(result.data.user));
                            this.updateUI();
                            return true;
                        }
                        
                        showNotification('登录失败: ' + (result.message || '未知错误'), 'error');
                        return false;
                    } catch (error) {
                        console.error('登录失败:', error);
                        showNotification('登录失败: ' + (error.message || '网络错误'), 'error');
                        return false;
                    }
                }
                
                async register(phone, username, password, verificationCode) {
                    try {
                        const result = await api.register({
                            phone,
                            username,
                            password,
                            verificationCode: verificationCode || '123456'
                        });
                        
                        if (result.success) {
                            this.currentUser = result.data.user;
                            this.token = result.data.token;
                            api.setToken(this.token);
                            localStorage.setItem('heartland_token', this.token);
                            localStorage.setItem('heartland_user', JSON.stringify(result.data.user));
                            this.updateUI();
                            return { success: true, message: result.message };
                        }
                        
                        return { success: false, message: result.message || '注册失败' };
                    } catch (error) {
                        console.error('注册失败:', error);
                        return { success: false, message: error.message || '注册失败，请稍后重试' };
                    }
                }
                
                async checkLoginStatus() {
                    if (!this.token) {
                        return false;
                    }
                    
                    try {
                        const result = await api.verifyToken();
                        if (result.success) {
                            this.currentUser = result.data.user;
                            localStorage.setItem('heartland_user', JSON.stringify(result.data.user));
                            this.updateUI();
                            return true;
                        }
                    } catch (error) {
                        console.error('验证登录状态失败:', error);
                        this.logout();
                    }
                    
                    return false;
                }
                
                logout() {
                    this.currentUser = null;
                    this.token = null;
                    api.setToken(null);
                    localStorage.removeItem('heartland_token');
                    localStorage.removeItem('heartland_user');
                    window.location.reload();
                }
                
                getRandomHouse() {
                    const houses = ['gryffindor', 'slytherin', 'ravenclaw', 'hufflepuff'];
                    return houses[Math.floor(Math.random() * houses.length)];
                }
                
                updateUI() {
                    if (this.currentUser) {
                        // 获取用户信息
                        const userProfile = this.getUserProfile();
                        const username = userProfile.username || this.currentUser.username || '朋友';
                        const avatar = userProfile.avatar || this.currentUser.avatar || '👤';
                        
                        // 更新欢迎语（带治愈话语）
                        const welcomeMessages = [
                            `欢迎回来，${username}！今天也要好好照顾自己哦 🌸`,
                            `${username}，很高兴见到你！你比想象中更坚强 💪`,
                            `你好，${username}！慢慢来，你已经很棒了 ✨`,
                            `${username}，欢迎回来！每一步都是成长 🌟`,
                            `你好，${username}！今天也要给自己一些温柔 💕`
                        ];
                        const randomWelcome = welcomeMessages[Math.floor(Math.random() * welcomeMessages.length)];
                        
                        const welcomeElement = document.getElementById('welcome-user');
                        if (welcomeElement) {
                            welcomeElement.textContent = randomWelcome;
                        }
                        
                        const focusTimeElement = document.getElementById('focus-time');
                        if (focusTimeElement) {
                            focusTimeElement.textContent = Math.floor((this.currentUser.focus_time || 0) / 60);
                        }
                        
                        // 更新头像
                        const avatarIcon = document.getElementById('user-avatar-icon');
                        if (avatarIcon) {
                            avatarIcon.textContent = avatar;
                        }
                        
                        // 更新学院徽章
                        const houseBadge = document.querySelector('.house-badge');
                        if (houseBadge) {
                            const houseIcon = houseBadge.querySelector('.house-icon');
                            const houseName = houseBadge.querySelector('span');
                            
                            if (houseIcon && houseName) {
                                const house = this.currentUser.house || 'gryffindor';
                                houseIcon.textContent = house.charAt(0).toUpperCase();
                                houseIcon.style.background = this.getHouseColor(house);
                                houseName.textContent = this.getHouseName(house);
                            }
                        }
                        
                        const authModal = document.getElementById('auth-modal');
                        if (authModal) {
                            authModal.style.display = 'none';
                        }
                    }
                }

                getUserProfile() {
                    const profile = localStorage.getItem('user_profile');
                    if (profile) {
                        return JSON.parse(profile);
                    }
                    return { username: this.currentUser?.username, avatar: '👤' };
                }

                saveUserProfile(profile) {
                    localStorage.setItem('user_profile', JSON.stringify(profile));
                    if (this.currentUser) {
                        this.currentUser.username = profile.username;
                        this.updateUI();
                    }
                }
                
                getHouseColor(house) {
                    const colors = {
                        gryffindor: '#740001',
                        slytherin: '#1A472A',
                        ravenclaw: '#0E1A40',
                        hufflepuff: '#FFDB00',
                        none: '#999999'
                    };
                    return colors[house] || '#740001';
                }
                
                getHouseName(house) {
                    const names = {
                        gryffindor: '格兰芬多',
                        slytherin: '斯莱特林',
                        ravenclaw: '拉文克劳',
                        hufflepuff: '赫奇帕奇',
                        none: '未分院'
                    };
                    return names[house] || '格兰芬多';
                }
            }

            // 创建管理器实例
            const userManager = new UserManager();
            
            // 页面加载时检查登录状态
            window.addEventListener('DOMContentLoaded', async function() {
                if (userManager.token) {
                    const isLoggedIn = await userManager.checkLoginStatus();
                    if (!isLoggedIn) {
                        // 如果token无效，显示登录界面
                        document.getElementById('auth-modal').style.display = 'flex';
                    } else {
                        // 如果已登录，隐藏登录界面
                        document.getElementById('auth-modal').style.display = 'none';
                    }
                } else {
                    // 如果没有token，显示登录界面
                    document.getElementById('auth-modal').style.display = 'flex';
                }
            });

            // 页面切换功能
            document.querySelectorAll('.nav-link').forEach(function(link) {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // 移除所有活跃状态
                    document.querySelectorAll('.nav-link').forEach(function(el) {
                        el.classList.remove('active');
                    });
                    document.querySelectorAll('.page-container').forEach(function(page) {
                        page.classList.remove('active');
                    });
                    
                    // 添加当前活跃状态
                    this.classList.add('active');
                    const pageId = this.getAttribute('data-page');
                    document.getElementById(pageId).classList.add('active');
                });
            });
            
            // 登录/注册模态框切换
            document.querySelectorAll('.auth-tab').forEach(function(tab) {
                tab.addEventListener('click', function() {
                    // 移除所有active类
                    document.querySelectorAll('.auth-tab').forEach(function(t) {
                        t.classList.remove('active');
                    });
                    // 给当前点击的标签添加active类
                    this.classList.add('active');
                    
                    // 切换表单显示
                    if (this.getAttribute('data-tab') === 'login') {
                        document.getElementById('login-form').style.display = 'block';
                        document.getElementById('register-form').style.display = 'none';
                    } else {
                        document.getElementById('login-form').style.display = 'none';
                        document.getElementById('register-form').style.display = 'block';
                    }
                });
            });
            
            // 登录表单提交
            document.getElementById('login-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                const phone = document.getElementById('username').value; // 现在是手机号
                const password = document.getElementById('password').value;
                
                if (phone && password) {
                    // 模拟登录成功
                    const success = await userManager.login(phone, password);
                    if (success) {
                        showNotification('登录成功！', 'success');
                        // 关闭登录模态框
                        document.getElementById('auth-modal').style.display = 'none';
                        // 检查用户是否已经分院
                        if (!userManager.currentUser.house || userManager.currentUser.house === 'none') {
                            // 如果未分院，显示分院测试
                            setTimeout(() => {
                                showSortingHat();
                            }, 1000);
                        }
                    }
                } else {
                    showNotification('请输入手机号和密码', 'error');
                }
            });
            
            // 发送验证码功能
            document.getElementById('send-code').addEventListener('click', function() {
                const phoneInput = document.getElementById('reg-phone');
                const phone = phoneInput.value.trim();
                
                // 手机号验证
                if (!phone) {
                    showNotification('请输入手机号', 'error');
                    return;
                }
                
                if (!/^1[3-9]\d{9}$/.test(phone)) {
                    showNotification('请输入正确的手机号', 'error');
                    return;
                }
                
                // 禁用按钮并开始倒计时
                this.disabled = true;
                this.textContent = '重新发送(' + countdown + ')';
                
                // 模拟发送验证码
                showNotification('验证码已发送（演示版），验证码：123456', 'success');
                
                // 开始倒计时
                codeTimer = setInterval(function() {
                    countdown--;
                    document.getElementById('send-code').textContent = '重新发送(' + countdown + ')';
                    
                    if (countdown <= 0) {
                        clearInterval(codeTimer);
                        document.getElementById('send-code').disabled = false;
                        document.getElementById('send-code').textContent = '发送验证码';
                        countdown = 60;
                    }
                }, 1000);
            });

            // 注册表单提交
            document.getElementById('register-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const phone = document.getElementById('reg-phone').value.trim();
                const username = document.getElementById('reg-username').value.trim();
                const code = document.getElementById('reg-code').value.trim();
                const password = document.getElementById('reg-password').value;
                const confirm = document.getElementById('reg-confirm').value;
                
                // 前端验证
                if (!phone || !/^1[3-9]\d{9}$/.test(phone)) {
                    showNotification('请输入正确的手机号', 'error');
                    return;
                }
                
                if (!username) {
                    showNotification('请输入用户名', 'error');
                    return;
                }
                
                if (!code || !/^\d{6}$/.test(code)) {
                    showNotification('请输入6位验证码', 'error');
                    return;
                }
                
                if (code !== verificationCode) {
                    showNotification('验证码错误，请使用测试验证码：123456', 'error');
                    return;
                }
                
                if (!password || password.length < 6) {
                    showNotification('密码长度至少6位', 'error');
                    return;
                }
                
                if (password !== confirm) {
                    showNotification('两次输入的密码不一致', 'error');
                    return;
                }
                
                // 调用注册接口
                const result = await userManager.register(phone, username, password);
                if (result.success) {
                    showNotification('注册成功！欢迎加入心屿学院', 'success');
                    // 清空表单
                    this.reset();
                    // 关闭登录模态框
                    document.getElementById('auth-modal').style.display = 'none';
                    // 显示分院测试
                    setTimeout(() => {
                        showSortingHat();
                    }, 1000);
                } else {
                    showNotification(result.message, 'error');
                }
            });
            
            // 忘记密码
            document.getElementById('forgot-password').addEventListener('click', function(e) {
                e.preventDefault();
                alert('密码重置功能即将推出，请联系管理员获取帮助。');
            });
            
            // 初始显示登录表单
            document.getElementById('login-form').style.display = 'block';
            document.getElementById('register-form').style.display = 'none';

            // 更新日期显示
            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('current-date').textContent = '今天是' + now.toLocaleDateString('zh-CN', options);

            // ============ 情绪追踪系统 ============
            
            // 情绪数据管理
            class MoodTracker {
                constructor() {
                    this.moods = this.loadMoods();
                    this.selectedMood = null;
                    this.moodConfig = {
                        happy: { name: '开心', icon: 'fa-laugh-beam', color: '#FFD93D' },
                        calm: { name: '平静', icon: 'fa-smile', color: '#6BCB77' },
                        sad: { name: '难过', icon: 'fa-sad-tear', color: '#4D96FF' },
                        anxious: { name: '焦虑', icon: 'fa-flushed', color: '#FF6B9D' },
                        angry: { name: '生气', icon: 'fa-angry', color: '#FF6B6B' }
                    };
                }
                
                loadMoods() {
                    const stored = localStorage.getItem('mood_records');
                    return stored ? JSON.parse(stored) : [];
                }
                
                saveMoods() {
                    localStorage.setItem('mood_records', JSON.stringify(this.moods));
                }
                
                addMood(mood, score, note) {
                    const record = {
                        id: Date.now(),
                        mood: mood,
                        score: parseInt(score),
                        note: note,
                        date: new Date().toISOString(),
                        dateStr: new Date().toLocaleDateString('zh-CN')
                    };
                    
                    // 检查今天是否已经记录
                    const today = new Date().toLocaleDateString('zh-CN');
                    const todayIndex = this.moods.findIndex(m => m.dateStr === today);
                    
                    if (todayIndex >= 0) {
                        // 更新今天的记录
                        this.moods[todayIndex] = record;
                    } else {
                        // 添加新记录
                        this.moods.unshift(record);
                    }
                    
                    this.saveMoods();
                    this.checkLowMoodAlert();
                    return record;
                }
                
                getMoodsByWeek() {
                    const now = new Date();
                    const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                    
                    return this.moods.filter(m => {
                        const moodDate = new Date(m.date);
                        return moodDate >= weekAgo && moodDate <= now;
                    });
                }
                
                getAverageScore(moods) {
                    if (moods.length === 0) return 0;
                    const sum = moods.reduce((acc, m) => acc + m.score, 0);
                    return (sum / moods.length).toFixed(1);
                }
                
                checkLowMoodAlert() {
                    const weekMoods = this.getMoodsByWeek();
                    if (weekMoods.length < 3) return; // 至少需要3天的数据
                    
                    const avgScore = parseFloat(this.getAverageScore(weekMoods));
                    
                    // 如果平均分低于2.5（情绪低落）
                    if (avgScore < 2.5) {
                        this.sendAlertToTeacher();
                    }
                }
                
                sendAlertToTeacher() {
                    const username = userManager.getUserProfile().username || '同学';
                    const alertData = {
                        studentName: username,
                        alertTime: new Date().toLocaleString('zh-CN'),
                        weekAverage: this.getAverageScore(this.getMoodsByWeek()),
                        message: `${username}近期情绪持续低落，建议心理老师关注并进行心理咨询。`
                    };
                    
                    // 保存预警记录
                    let alerts = JSON.parse(localStorage.getItem('mood_alerts') || '[]');
                    alerts.unshift(alertData);
                    localStorage.setItem('mood_alerts', JSON.stringify(alerts));
                    
                    // 显示通知
                    showNotification('已向心理老师发送关注提醒', 'info');
                    console.log('情绪预警:', alertData);
                }
            }
            
            const moodTracker = new MoodTracker();
            
            // 情绪选择功能
            let selectedMoodData = null;
            
            document.querySelectorAll('.mood-option').forEach(function(option) {
                option.addEventListener('click', function() {
                    // 移除其他选项的选中状态
                    document.querySelectorAll('.mood-option').forEach(function(opt) {
                        opt.classList.remove('selected');
                    });
                    
                    // 设置当前选项为选中状态
                    this.classList.add('selected');
                    
                    selectedMoodData = {
                        mood: this.getAttribute('data-mood'),
                        score: this.getAttribute('data-score')
                    };
                    
                    // 显示保存按钮
                    document.getElementById('save-mood-btn').style.display = 'block';
                });
            });
            
            // 心情笔记字数统计
            document.getElementById('mood-note').addEventListener('input', function() {
                document.getElementById('mood-note-count').textContent = this.value.length;
            });
            
            // 保存心情记录
            document.getElementById('save-mood-btn').addEventListener('click', function() {
                if (!selectedMoodData) {
                    showNotification('请先选择一个心情', 'error');
                    return;
                }
                
                const note = document.getElementById('mood-note').value.trim();
                const record = moodTracker.addMood(selectedMoodData.mood, selectedMoodData.score, note);
                
                const moodName = moodTracker.moodConfig[selectedMoodData.mood].name;
                showNotification('今天的心情已记录: ' + moodName + ' 💝', 'success');
                
                // 重置表单
                document.querySelectorAll('.mood-option').forEach(opt => opt.classList.remove('selected'));
                document.getElementById('mood-note').value = '';
                document.getElementById('mood-note-count').textContent = '0';
                document.getElementById('save-mood-btn').style.display = 'none';
                selectedMoodData = null;
                
                // 刷新记录列表
                renderMoodRecords();
            });
            
            // 渲染心情记录列表
            function renderMoodRecords() {
                const container = document.getElementById('mood-records-list');
                const moods = moodTracker.moods.slice(0, 10); // 只显示最近10条
                
                if (moods.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #999; padding: 2rem;">还没有心情记录，选择一个心情开始记录吧 💝</p>';
                    return;
                }
                
                container.innerHTML = moods.map(record => {
                    const config = moodTracker.moodConfig[record.mood];
                    return `
                        <div class="mood-record-item">
                            <div class="mood-record-header">
                                <div class="mood-record-mood">
                                    <i class="fas ${config.icon}" style="color: ${config.color}"></i>
                                    <span>${config.name}</span>
                                </div>
                                <div class="mood-record-date">${record.dateStr}</div>
                            </div>
                            ${record.note ? `<div class="mood-record-note">${record.note}</div>` : ''}
                        </div>
                    `;
                }).join('');
            }
            
            // 查看周报表
            document.getElementById('view-weekly-report-btn').addEventListener('click', function() {
                generateWeeklyReport();
                document.getElementById('weekly-report-modal').classList.add('active');
            });
            
            // 关闭周报表
            document.getElementById('close-weekly-report-modal').addEventListener('click', function() {
                document.getElementById('weekly-report-modal').classList.remove('active');
            });
            
            // 点击背景关闭周报表
            document.getElementById('weekly-report-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    this.classList.remove('active');
                }
            });
            
            // 生成周报表
            function generateWeeklyReport() {
                const weekMoods = moodTracker.getMoodsByWeek();
                const container = document.getElementById('weekly-report-content');
                
                if (weekMoods.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #999; padding: 2rem;">本周还没有情绪记录</p>';
                    return;
                }
                
                // 计算统计数据
                const avgScore = moodTracker.getAverageScore(weekMoods);
                const moodCounts = {};
                weekMoods.forEach(m => {
                    moodCounts[m.mood] = (moodCounts[m.mood] || 0) + 1;
                });
                
                // 找出最常见的情绪
                const mostCommonMood = Object.keys(moodCounts).reduce((a, b) => 
                    moodCounts[a] > moodCounts[b] ? a : b
                );
                
                // 生成每日数据（最近7天）
                const dailyData = [];
                for (let i = 6; i >= 0; i--) {
                    const date = new Date();
                    date.setDate(date.getDate() - i);
                    const dateStr = date.toLocaleDateString('zh-CN');
                    const dayMood = weekMoods.find(m => m.dateStr === dateStr);
                    dailyData.push({
                        date: dateStr,
                        day: ['周日', '周一', '周二', '周三', '周四', '周五', '周六'][date.getDay()],
                        score: dayMood ? dayMood.score : 0,
                        mood: dayMood ? dayMood.mood : null
                    });
                }
                
                // 生成图表
                const maxScore = 5;
                const chartHTML = dailyData.map(day => {
                    const height = (day.score / maxScore) * 100;
                    const config = day.mood ? moodTracker.moodConfig[day.mood] : null;
                    return `
                        <div class="mood-bar" style="height: ${height}%; background: ${config ? config.color : '#ddd'};">
                            ${day.score > 0 ? `<div class="mood-bar-value">${day.score}</div>` : ''}
                            <div class="mood-bar-label">${day.day}</div>
                        </div>
                    `;
                }).join('');
                
                // 生成分析和建议
                const analysis = generateMoodAnalysis(avgScore, mostCommonMood, weekMoods);
                
                container.innerHTML = `
                    <div class="weekly-report-chart">
                        <h4 style="color: #2C3E50; margin-bottom: 1rem;">
                            <i class="fas fa-chart-bar"></i> 本周情绪变化趋势
                        </h4>
                        <div class="mood-bar-chart">
                            ${chartHTML}
                        </div>
                        <div style="text-align: center; color: #666; margin-top: 2rem;">
                            <p>本周平均情绪分数: <strong style="color: #FF6B6B; font-size: 1.5rem;">${avgScore}</strong> / 5.0</p>
                            <p style="margin-top: 0.5rem;">记录天数: ${weekMoods.length} 天</p>
                        </div>
                    </div>
                    
                    ${analysis}
                `;
            }
            
            // 生成情绪分析和建议
            function generateMoodAnalysis(avgScore, mostCommonMood, weekMoods) {
                const score = parseFloat(avgScore);
                const moodName = moodTracker.moodConfig[mostCommonMood].name;
                
                let analysisText = '';
                let suggestions = [];
                let alertHTML = '';
                
                if (score >= 4) {
                    analysisText = `太棒了！本周你的整体情绪状态非常好，平均分达到了${avgScore}分。你最常感到${moodName}，这说明你正处在一个积极向上的状态中。继续保持这种良好的心态，你会发现生活充满阳光！`;
                    suggestions = [
                        '继续保持规律的作息和健康的生活习惯',
                        '可以尝试记录让你开心的事情，建立"快乐清单"',
                        '分享你的快乐给身边的朋友，传递正能量',
                        '适当挑战自己，尝试新的兴趣爱好'
                    ];
                } else if (score >= 3) {
                    analysisText = `本周你的情绪状态比较平稳，平均分为${avgScore}分。你最常感到${moodName}，整体来说还不错。虽然可能会有一些小波动，但你都处理得很好。继续加油！`;
                    suggestions = [
                        '保持现有的良好习惯，注意劳逸结合',
                        '遇到压力时，可以尝试深呼吸或短暂休息',
                        '多与朋友交流，分享你的感受',
                        '每天给自己一些放松的时间，做喜欢的事'
                    ];
                } else if (score >= 2) {
                    analysisText = `本周你的情绪有些低落，平均分为${avgScore}分。你经常感到${moodName}，这可能意味着你最近遇到了一些困扰。请记住，情绪的波动是正常的，重要的是学会调节和寻求帮助。`;
                    suggestions = [
                        '尝试与信任的朋友或家人倾诉你的感受',
                        '保证充足的睡眠，适当运动有助于改善心情',
                        '可以尝试写日记，记录并理解自己的情绪',
                        '如果持续感到困扰，建议寻求心理老师的帮助',
                        '给自己一些积极的心理暗示，相信困难会过去'
                    ];
                    
                    if (weekMoods.length >= 3) {
                        alertHTML = `
                            <div class="alert-warning">
                                <h4><i class="fas fa-exclamation-triangle"></i> 温馨提醒</h4>
                                <p>我们注意到你最近的情绪持续偏低。已经向你的心理老师发送了关注提醒，老师会在合适的时间找你聊聊。请记住，寻求帮助是勇敢的表现，我们都在这里支持你！💝</p>
                            </div>
                        `;
                    }
                } else {
                    analysisText = `本周你的情绪状态需要特别关注，平均分为${avgScore}分。你经常感到${moodName}，这表明你可能正在经历一些困难时期。请不要独自承受，我们都愿意帮助你。`;
                    suggestions = [
                        '请尽快与心理老师预约咨询，专业的帮助很重要',
                        '与家人或信任的朋友分享你的感受',
                        '保持规律作息，即使心情不好也要照顾好自己',
                        '避免独处太久，多参与集体活动',
                        '记住：这只是暂时的困难，你值得被关心和帮助'
                    ];
                    
                    alertHTML = `
                        <div class="alert-warning">
                            <h4><i class="fas fa-heart"></i> 重要提醒</h4>
                            <p>你最近的情绪状态让我们很担心。我们已经通知了你的心理老师，老师会主动联系你。请记住，你不是一个人在面对困难，我们都在这里陪伴和支持你。如果感到特别难受，请随时寻求帮助！</p>
                            <p style="margin-top: 1rem; font-weight: 600;">24小时心理援助热线: 400-161-9995</p>
                        </div>
                    `;
                }
                
                return `
                    ${alertHTML}
                    
                    <div class="analysis-section">
                        <h4><i class="fas fa-brain"></i> 情绪分析</h4>
                        <p>${analysisText}</p>
                    </div>
                    
                    <div class="analysis-section">
                        <h4><i class="fas fa-lightbulb"></i> 给你的建议</h4>
                        <ul class="suggestion-list">
                            ${suggestions.map(s => `<li><i class="fas fa-check-circle"></i><span>${s}</span></li>`).join('')}
                        </ul>
                    </div>
                `;
            }
            
            // 初始化情绪记录列表
            renderMoodRecords();
            
            // ============ 情绪追踪系统结束 ============

            // 同学交流系统
            let currentChat = null; // 当前聊天对象（好友或群聊）
            let friends = JSON.parse(localStorage.getItem('friends') || '[]');
            let groups = JSON.parse(localStorage.getItem('groups') || '[]');
            let chatId = localStorage.getItem('chat_id') || 'XY' + Math.floor(100000 + Math.random() * 900000);

            // 初始化交流号
            if (!localStorage.getItem('chat_id')) {
                localStorage.setItem('chat_id', chatId);
            }
            document.getElementById('my-chat-id').value = chatId;

            // 加载好友和群聊列表
            function loadFriendsList() {
                const friendList = document.getElementById('friend-list');
                friendList.innerHTML = '';
                
                if (friends.length === 0) {
                    friendList.innerHTML = '<p style="color: #999; text-align: center; padding: 2rem;">还没有好友，快去添加吧~</p>';
                    return;
                }
                
                friends.forEach(friend => {
                    const item = document.createElement('div');
                    item.className = 'friend-item';
                    item.innerHTML = `
                        <div class="friend-avatar">${friend.avatar || '👤'}</div>
                        <div class="friend-info">
                            <div class="friend-name">${friend.name}</div>
                            <div class="friend-status">${friend.status || '在线'}</div>
                        </div>
                    `;
                    item.addEventListener('click', function() {
                        openChat('friend', friend);
                    });
                    friendList.appendChild(item);
                });
            }

            function loadGroupsList() {
                const groupList = document.getElementById('group-list');
                groupList.innerHTML = '';
                
                if (groups.length === 0) {
                    groupList.innerHTML = '<p style="color: #999; text-align: center; padding: 2rem;">还没有群聊，快去创建吧~</p>';
                    return;
                }
                
                groups.forEach(group => {
                    const item = document.createElement('div');
                    item.className = 'group-item';
                    item.innerHTML = `
                        <div class="group-avatar">${group.icon || '👥'}</div>
                        <div class="group-info">
                            <div class="group-name">${group.name}</div>
                            <div class="group-members">${group.members || 0} 位成员</div>
                        </div>
                    `;
                    item.addEventListener('click', function() {
                        openChat('group', group);
                    });
                    groupList.appendChild(item);
                });
            }

            function openChat(type, target) {
                currentChat = { type, target };
                const messages = document.getElementById('chat-messages');
                messages.innerHTML = `
                    <div class="message system">
                        <p>开始与 ${target.name} 的对话 💬</p>
                    </div>
                `;
            }

            // 添加好友
            document.getElementById('add-friend-btn').addEventListener('click', function() {
                document.getElementById('add-friend-modal').classList.add('active');
            });

            document.getElementById('close-add-friend-modal').addEventListener('click', function() {
                document.getElementById('add-friend-modal').classList.remove('active');
            });

            document.getElementById('copy-chat-id').addEventListener('click', function() {
                const chatId = document.getElementById('my-chat-id').value;
                navigator.clipboard.writeText(chatId).then(function() {
                    showNotification('交流号已复制到剪贴板', 'success');
                });
            });

            document.getElementById('search-friend-btn').addEventListener('click', function() {
                const friendChatId = document.getElementById('friend-chat-id').value.trim();
                if (!friendChatId) {
                    showNotification('请输入好友的交流号', 'error');
                    return;
                }
                
                // 模拟搜索好友
                const mockFriend = {
                    id: friendChatId,
                    name: '新朋友',
                    avatar: '👤',
                    status: '在线',
                    chatId: friendChatId
                };
                
                // 检查是否已是好友
                if (friends.find(f => f.chatId === friendChatId)) {
                    showNotification('该用户已经是你的好友了', 'info');
                    return;
                }
                
                friends.push(mockFriend);
                localStorage.setItem('friends', JSON.stringify(friends));
                loadFriendsList();
                showNotification('好友添加成功！', 'success');
                document.getElementById('add-friend-modal').classList.remove('active');
                document.getElementById('friend-chat-id').value = '';
            });

            // ============ 创建群聊功能（微信风格） ============
            let selectedGroupMembers = [];
            
            // 打开创建群聊界面
            document.getElementById('create-group-btn').addEventListener('click', function() {
                selectedGroupMembers = [];
                renderFriendsSelector();
                document.getElementById('create-group-modal').classList.add('active');
            });
            
            // 关闭创建群聊界面
            document.getElementById('close-create-group-modal').addEventListener('click', function() {
                document.getElementById('create-group-modal').classList.remove('active');
                selectedGroupMembers = [];
            });
            
            // 渲染好友选择列表
            function renderFriendsSelector() {
                const container = document.getElementById('friends-selector-list');
                const searchInput = document.getElementById('search-friend-input');
                const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
                
                if (friends.length === 0) {
                    container.innerHTML = '<div style="text-align: center; color: #999; padding: 2rem;">还没有好友，快去添加好友吧~</div>';
                    return;
                }
                
                const filteredFriends = friends.filter(f => 
                    !searchTerm || f.name.toLowerCase().includes(searchTerm) || f.chatId.toLowerCase().includes(searchTerm)
                );
                
                container.innerHTML = filteredFriends.map(friend => {
                    const isSelected = selectedGroupMembers.some(m => m.chatId === friend.chatId);
                    return `
                        <div class="friend-selector-item" data-friend-id="${friend.chatId}" style="display: flex; align-items: center; gap: 1rem; padding: 0.8rem; border: 2px solid ${isSelected ? '#FF6B6B' : '#eee'}; border-radius: 10px; margin-bottom: 0.8rem; cursor: pointer; transition: all 0.3s ease; background: ${isSelected ? 'rgba(255, 107, 107, 0.05)' : 'white'};">
                            <div style="width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #667eea, #764ba2); display: flex; align-items: center; justify-content: center; font-size: 1.2rem; color: white;">
                                ${friend.avatar}
                            </div>
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: #2C3E50;">${friend.name}</div>
                                <div style="font-size: 0.85rem; color: #999;">交流号: ${friend.chatId}</div>
                            </div>
                            <div style="width: 24px; height: 24px; border: 2px solid ${isSelected ? '#FF6B6B' : '#ddd'}; border-radius: 50%; display: flex; align-items: center; justify-content: center; background: ${isSelected ? '#FF6B6B' : 'white'};">
                                ${isSelected ? '<i class="fas fa-check" style="color: white; font-size: 0.8rem;"></i>' : ''}
                            </div>
                        </div>
                    `;
                }).join('');
                
                // 添加点击事件
                container.querySelectorAll('.friend-selector-item').forEach(item => {
                    item.addEventListener('click', function() {
                        const friendId = this.getAttribute('data-friend-id');
                        toggleFriendSelection(friendId);
                    });
                });
                
                // 更新已选择数量
                document.getElementById('selected-count').textContent = selectedGroupMembers.length;
            }
            
            // 切换好友选择状态
            function toggleFriendSelection(friendId) {
                const friend = friends.find(f => f.chatId === friendId);
                if (!friend) return;
                
                const index = selectedGroupMembers.findIndex(m => m.chatId === friendId);
                if (index >= 0) {
                    selectedGroupMembers.splice(index, 1);
                } else {
                    selectedGroupMembers.push(friend);
                }
                
                renderFriendsSelector();
            }
            
            // 搜索好友
            document.getElementById('search-friend-input')?.addEventListener('input', function() {
                renderFriendsSelector();
            });
            
            // 全选好友
            document.getElementById('select-all-friends-btn')?.addEventListener('click', function() {
                if (selectedGroupMembers.length === friends.length) {
                    selectedGroupMembers = [];
                } else {
                    selectedGroupMembers = [...friends];
                }
                renderFriendsSelector();
                this.textContent = selectedGroupMembers.length === friends.length ? '取消全选' : '全选';
            });
            
            // 确认创建群聊
            document.getElementById('confirm-create-group-btn').addEventListener('click', function() {
                if (selectedGroupMembers.length === 0) {
                    showNotification('请至少选择1位好友', 'error');
                    return;
                }
                
                // 获取群名称
                const groupNameInput = document.getElementById('group-name-input').value.trim();
                let groupName = groupNameInput;
                
                // 如果没有输入群名称，自动生成
                if (!groupName) {
                    const memberNames = selectedGroupMembers.slice(0, 3).map(m => m.name).join('、');
                    const currentUserName = userManager.getUserProfile().username || '我';
                    groupName = currentUserName + '、' + memberNames;
                    if (selectedGroupMembers.length > 3) {
                        groupName += '...';
                    }
                }
                
                // 创建群聊对象
                const newGroup = {
                    id: 'group_' + Date.now(),
                    name: groupName,
                    icon: '👥',
                    members: selectedGroupMembers.length + 1, // +1 包括自己
                    memberList: [
                        {
                            chatId: userManager.getUserProfile().chatId || 'XY' + Date.now(),
                            name: userManager.getUserProfile().username || '我',
                            avatar: userManager.getUserProfile().avatar || '👤',
                            isAdmin: true
                        },
                        ...selectedGroupMembers.map(m => ({
                            chatId: m.chatId,
                            name: m.name,
                            avatar: m.avatar,
                            isAdmin: false
                        }))
                    ],
                    admin: userManager.getUserProfile().username || '我',
                    createTime: new Date().toLocaleString('zh-CN')
                };
                
                groups.push(newGroup);
                localStorage.setItem('groups', JSON.stringify(groups));
                loadGroupsList();
                
                // 关闭模态框
                document.getElementById('create-group-modal').classList.remove('active');
                document.getElementById('group-name-input').value = '';
                selectedGroupMembers = [];
                
                showNotification(`群聊"${groupName}"创建成功！共${newGroup.members}人`, 'success');
            });
            // ============ 创建群聊功能结束 ============

            // 发送消息
            document.getElementById('send-message-btn').addEventListener('click', function() {
                sendMessage();
            });

            document.getElementById('chat-message-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });

            function sendMessage() {
                const input = document.getElementById('chat-message-input');
                const message = input.value.trim();
                if (!message || !currentChat) {
                    if (!currentChat) {
                        showNotification('请先选择一个好友或群聊', 'info');
                    }
                    return;
                }
                
                const messages = document.getElementById('chat-messages');
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message';
                messageDiv.innerHTML = `
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.3rem;">
                        <strong>${userManager.getUserProfile().username || '我'}</strong>
                        <span style="font-size: 0.8rem; color: #999;">${new Date().toLocaleTimeString()}</span>
                    </div>
                    <p>${message}</p>
                `;
                messages.appendChild(messageDiv);
                messages.scrollTop = messages.scrollHeight;
                input.value = '';
                
                // 检查是否包含组队学习邀请关键词
                if (message.includes('组队学习') || message.includes('一起学习')) {
                    setTimeout(function() {
                        const replyDiv = document.createElement('div');
                        replyDiv.className = 'message';
                        replyDiv.style.background = '#e3f2fd';
                        replyDiv.innerHTML = `
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.3rem;">
                                <strong>${currentChat.target.name}</strong>
                                <span style="font-size: 0.8rem; color: #999;">${new Date().toLocaleTimeString()}</span>
                            </div>
                            <p>好的！一起学习吧 💪</p>
                            <button class="btn btn-primary" style="margin-top: 0.5rem; padding: 0.5rem 1rem; font-size: 0.9rem;" onclick="acceptStudyInvite()">
                                <i class="fas fa-check"></i> 接受邀请
                            </button>
                        `;
                        messages.appendChild(replyDiv);
                        messages.scrollTop = messages.scrollHeight;
                    }, 1000);
                }
            }

            // 接受组队学习邀请
            window.acceptStudyInvite = function() {
                const team = {
                    id: 'team_' + Date.now(),
                    name: '学习小组',
                    members: [
                        {
                            name: userManager.getUserProfile().username || '我',
                            avatar: userManager.getUserProfile().avatar || '👤'
                        },
                        {
                            name: currentChat.target.name,
                            avatar: currentChat.target.avatar || '👤'
                        }
                    ]
                };
                startStudySession(team);
            };

            // 文件上传
            document.getElementById('file-upload-btn').addEventListener('click', function() {
                if (!currentChat) {
                    showNotification('请先选择一个好友或群聊', 'info');
                    return;
                }
                const input = document.createElement('input');
                input.type = 'file';
                input.onchange = function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        showNotification(`文件 "${file.name}" 已选择，发送功能开发中`, 'info');
                        // 这里可以添加实际的文件发送逻辑
                    }
                };
                input.click();
            });

            // 初始化好友和群聊列表
            loadFriendsList();
            loadGroupsList();

            // 全屏倒计时功能
            let timerInterval;
            let timerRunning = false;
            let timerMinutes = 25;
            let timeLeft = 0;
            let totalTime = 0;

            const timerFullscreen = document.getElementById('timer-fullscreen');
            const timerTime = document.getElementById('timer-time');
            const timerLabel = document.getElementById('timer-label');
            const timerProgressBar = document.getElementById('timer-progress-bar');
            const timerEncouragement = document.getElementById('timer-encouragement');
            const timerCloseBtn = document.getElementById('timer-close-btn');

            // 鼓励语列表
            const encouragements = [
                '你正在做一件很棒的事情，坚持下去，你比自己想象的更强大 💪',
                '每一分钟的努力都是值得的，你已经很棒了 ✨',
                '慢慢来，不着急，你已经做得很好了 🌸',
                '专注的时光是最珍贵的，你正在创造美好的未来 🌟',
                '相信自己，你比想象中更坚强，继续加油 💕',
                '每一次专注都是对自己的温柔，你已经很棒了 🌈',
                '坚持下去，美好的事情正在发生 🌻',
                '你正在成长，每一步都值得庆祝 🎉'
            ];

            document.getElementById('start-timer').addEventListener('click', function() {
                if (!timerRunning) {
                    // 进入全屏倒计时模式
                    timerFullscreen.classList.add('active');
                    document.body.style.overflow = 'hidden'; // 禁止滚动
                    startTimer();
                }
            });

            // 关闭倒计时
            timerCloseBtn.addEventListener('click', function() {
                if (timerRunning) {
                    if (confirm('确定要退出专注时光吗？')) {
                        stopTimer();
                    }
                } else {
                    stopTimer();
                }
            });

            function startTimer() {
                timeLeft = timerMinutes * 60;
                totalTime = timeLeft;
                timerRunning = true;
                updateTimerDisplay();
                
                // 随机选择鼓励语
                const randomEncouragement = encouragements[Math.floor(Math.random() * encouragements.length)];
                timerEncouragement.textContent = randomEncouragement;
                
                timerInterval = setInterval(function() {
                    timeLeft--;
                    updateTimerDisplay();
                    
                    if (timeLeft <= 0) {
                        clearInterval(timerInterval);
                        timerRunning = false;
                        timerLabel.textContent = '专注时光完成！你太棒了！🎉';
                        timerEncouragement.textContent = '恭喜你完成了这次专注时光！休息一下，给自己一个拥抱吧 💕';
                        
                        // 播放完成提示（可以添加声音）
                        showNotification('专注时光完成！你太棒了！', 'success');
                        
                        // 3秒后自动关闭
                        setTimeout(function() {
                            stopTimer();
                        }, 3000);
                    }
                }, 1000);
            }

            function updateTimerDisplay() {
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                timerTime.textContent = 
                    (minutes < 10 ? '0' : '') + minutes + ':' + 
                    (seconds < 10 ? '0' : '') + seconds;
                
                // 更新进度条
                const progress = (timeLeft / totalTime) * 100;
                timerProgressBar.style.width = progress + '%';
                
                // 更新标签
                if (timeLeft > 0) {
                    const remainingMinutes = Math.floor(timeLeft / 60);
                    timerLabel.textContent = `还有 ${remainingMinutes} 分钟，继续加油！`;
                }
            }

            function stopTimer() {
                clearInterval(timerInterval);
                timerRunning = false;
                timerFullscreen.classList.remove('active');
                document.body.style.overflow = ''; // 恢复滚动
                timeLeft = 0;
            }

            // 组队学习功能
            let studyTeams = JSON.parse(localStorage.getItem('study_teams') || '[]');

            document.getElementById('view-teams').addEventListener('click', function() {
                const teamSection = document.getElementById('team-study-section');
                if (teamSection.style.display === 'none') {
                    teamSection.style.display = 'block';
                    this.innerHTML = '<i class="fas fa-eye-slash"></i> 隐藏学习小组';
                    loadStudyTeams();
                } else {
                    teamSection.style.display = 'none';
                    this.innerHTML = '<i class="fas fa-user-friends"></i> 查看学习小组';
                }
            });

            document.getElementById('create-team').addEventListener('click', function() {
                const teamName = prompt('请输入学习小组名称：');
                if (teamName) {
                    const newTeam = {
                        id: 'team_' + Date.now(),
                        name: teamName,
                        members: [{
                            name: userManager.getUserProfile().username || '我',
                            avatar: userManager.getUserProfile().avatar || '👤'
                        }],
                        creator: userManager.currentUser?.username || '我'
                    };
                    studyTeams.push(newTeam);
                    localStorage.setItem('study_teams', JSON.stringify(studyTeams));
                    loadStudyTeams();
                    showNotification('学习小组 "' + teamName + '" 创建成功！', 'success');
                }
            });

            function loadStudyTeams() {
                const teamList = document.querySelector('.team-list');
                if (!teamList) return;
                
                teamList.innerHTML = '';
                studyTeams.forEach(team => {
                    const card = document.createElement('div');
                    card.className = 'team-card';
                    card.innerHTML = `
                        <h3 style="font-family: 'Comfortaa', cursive; color: #2C3E50; margin-bottom: 0.5rem;">
                            <i class="fas fa-heart"></i> ${team.name}
                        </h3>
                        <p style="color: #666; font-size: 0.9rem; margin-bottom: 0.5rem;">一起学习，互相鼓励</p>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 1rem;">
                            <div class="team-members">
                                ${team.members.map((m, i) => 
                                    `<div class="team-member-avatar" style="background: linear-gradient(135deg, #FF6B6B, #FF8E53);">${m.avatar}</div>`
                                ).join('')}
                            </div>
                            <button class="btn btn-outline join-team-btn" data-team-id="${team.id}" style="padding: 0.5rem 1rem; font-size: 0.9rem;">加入</button>
                        </div>
                    `;
                    teamList.appendChild(card);
                });
                
                // 添加加入按钮事件
                document.querySelectorAll('.join-team-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const teamId = this.getAttribute('data-team-id');
                        joinStudyTeam(teamId);
                    });
                });
            }

            function joinStudyTeam(teamId) {
                const team = studyTeams.find(t => t.id === teamId);
                if (!team) return;
                
                const userProfile = userManager.getUserProfile();
                const isMember = team.members.find(m => m.name === (userProfile.username || '我'));
                
                if (!isMember) {
                    team.members.push({
                        name: userProfile.username || '我',
                        avatar: userProfile.avatar || '👤'
                    });
                    localStorage.setItem('study_teams', JSON.stringify(studyTeams));
                    loadStudyTeams();
                }
                
                // 进入学习小组自习界面
                startStudySession(team);
            }

            // 学习小组自习功能
            let studySessionInterval;
            let studyTime = 0; // 总学习时间（秒）
            let isStudying = false;
            let isResting = false;
            const STUDY_DURATION = 3600; // 1小时 = 3600秒
            const REST_DURATION = 900; // 15分钟 = 900秒
            let studyWhiteNoise = null;

            function startStudySession(team) {
                const container = document.getElementById('study-session-container');
                container.classList.add('active');
                document.body.style.overflow = 'hidden';
                
                // 重置滚动位置到顶部
                container.scrollTop = 0;
                
                // 显示成员
                displayStudyMembers(team.members);
                
                // 初始化图片轮播
                initHealingCarousel();
                
                // 开始计时
                isStudying = true;
                studyTime = 0;
                updateStudyStatus('studying', '正在学习中...');
                startStudyTimer();
            }

            function displayStudyMembers(members) {
                const display = document.getElementById('study-members-display');
                display.innerHTML = '';
                members.forEach(member => {
                    const avatar = document.createElement('div');
                    avatar.className = 'study-member-avatar';
                    avatar.textContent = member.avatar || '👤';
                    avatar.title = member.name;
                    display.appendChild(avatar);
                });
            }

            function initHealingCarousel() {
                const carousel = document.getElementById('healing-carousel');
                
                // 治愈图片（使用渐变和描述性背景，实际应用中可替换为真实图片URL）
                const healingImages = [
                    {
                        // 夜晚露营场景 - 温暖篝火
                        gradient: 'linear-gradient(135deg, rgba(30, 30, 60, 0.4), rgba(224, 176, 64, 0.3))',
                        color: '#1E1E3C',
                        accent: '#E0B040',
                        emoji: '🏕️',
                        text: '温暖的篝火，陪伴的夜晚'
                    },
                    {
                        // 白天徒步场景 - 金色草地
                        gradient: 'linear-gradient(135deg, rgba(80, 160, 208, 0.3), rgba(224, 176, 64, 0.4))',
                        color: '#50A0D0',
                        accent: '#E0B040',
                        emoji: '🌲',
                        text: '金色的草地，温暖的阳光'
                    },
                    {
                        // 狐狸和鸟的场景 - 日出日落
                        gradient: 'linear-gradient(135deg, rgba(255, 200, 100, 0.4), rgba(139, 154, 91, 0.3))',
                        color: '#FFC864',
                        accent: '#8B9A5B',
                        emoji: '🦊',
                        text: '宁静的自然，温暖的陪伴'
                    }
                ];
                
                carousel.innerHTML = '';
                healingImages.forEach((img, index) => {
                    const imgDiv = document.createElement('div');
                    imgDiv.className = 'carousel-image' + (index === 0 ? ' active' : '');
                    imgDiv.style.background = `${img.gradient}, radial-gradient(circle at center, ${img.accent}40 0%, ${img.color}80 100%)`;
                    imgDiv.style.backgroundSize = 'cover';
                    imgDiv.style.backgroundPosition = 'center';
                    imgDiv.style.display = 'flex';
                    imgDiv.style.alignItems = 'center';
                    imgDiv.style.justifyContent = 'center';
                    imgDiv.style.flexDirection = 'column';
                    imgDiv.style.color = 'white';
                    imgDiv.style.fontSize = '3rem';
                    imgDiv.innerHTML = `
                        <div style="font-size: 5rem; margin-bottom: 1rem; text-shadow: 0 4px 10px rgba(0,0,0,0.3);">${img.emoji}</div>
                        <div style="font-size: 1.5rem; font-family: 'Comfortaa', cursive; text-shadow: 0 2px 8px rgba(0,0,0,0.3);">${img.text}</div>
                    `;
                    carousel.appendChild(imgDiv);
                });
                
                // 自动轮播（每5秒切换）
                let currentIndex = 0;
                setInterval(function() {
                    const images = carousel.querySelectorAll('.carousel-image');
                    if (images.length > 0) {
                        images[currentIndex].classList.remove('active');
                        currentIndex = (currentIndex + 1) % images.length;
                        images[currentIndex].classList.add('active');
                    }
                }, 5000);
            }

            function startStudyTimer() {
                studySessionInterval = setInterval(function() {
                    if (isStudying) {
                        studyTime++;
                        updateStudyTimer();
                        
                        // 检查是否需要休息（学习1小时后）
                        if (studyTime >= STUDY_DURATION) {
                            startRest();
                        }
                    } else if (isResting) {
                        studyTime++;
                        updateStudyTimer();
                        
                        // 检查休息是否结束（休息15分钟后）
                        const restDuration = studyTime - restStartTime;
                        if (restDuration >= REST_DURATION) {
                            startStudy();
                        }
                    }
                }, 1000);
            }

            function updateStudyTimer() {
                const hours = Math.floor(studyTime / 3600);
                const minutes = Math.floor((studyTime % 3600) / 60);
                const seconds = studyTime % 60;
                document.getElementById('study-timer-display').textContent = 
                    `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            }

            let restStartTime = 0;

            function startRest() {
                isStudying = false;
                isResting = true;
                restStartTime = studyTime; // 记录休息开始时间
                updateStudyStatus('resting', `休息时间（剩余 ${Math.ceil((REST_DURATION) / 60)} 分钟）`);
                enableStudyChat();
                showNotification('学习时间结束，现在是休息时间！可以和小组成员交流了 💬', 'success');
                
                // 更新休息倒计时
                let restCountdown = REST_DURATION;
                const restTimer = setInterval(function() {
                    restCountdown--;
                    const minutes = Math.ceil(restCountdown / 60);
                    updateStudyStatus('resting', `休息时间（剩余 ${minutes} 分钟）`);
                    if (restCountdown <= 0) {
                        clearInterval(restTimer);
                    }
                }, 1000);
            }

            function startStudy() {
                isStudying = true;
                isResting = false;
                studyTime = 0; // 重新开始计时
                restStartTime = 0;
                updateStudyStatus('studying', '正在学习中...');
                disableStudyChat();
                showNotification('休息结束，继续学习！', 'info');
            }

            function updateStudyStatus(status, text) {
                const statusDiv = document.getElementById('study-status');
                statusDiv.className = 'study-status ' + status;
                document.getElementById('study-status-text').textContent = text;
            }

            function enableStudyChat() {
                document.getElementById('study-chat-disabled').style.display = 'none';
                document.getElementById('study-chat-input').style.display = 'flex';
            }

            function disableStudyChat() {
                document.getElementById('study-chat-disabled').style.display = 'block';
                document.getElementById('study-chat-input').style.display = 'none';
            }

            // 白噪音控制
            document.getElementById('study-music-control').addEventListener('click', function() {
                let musicEnabled = this.classList.contains('active');
                musicEnabled = !musicEnabled;
                
                if (musicEnabled) {
                    // 创建轻音乐（使用多个正弦波模拟和弦）
                    try {
                        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                        const gainNode = audioContext.createGain();
                        gainNode.gain.value = 0.08;
                        
                        // 创建和弦：C大调的和弦进行
                        const frequencies = [261.63, 329.63, 392.00]; // C, E, G
                        const oscillators = [];
                        
                        frequencies.forEach(freq => {
                            const osc = audioContext.createOscillator();
                            osc.type = 'sine';
                            osc.frequency.value = freq;
                            osc.connect(gainNode);
                            osc.start();
                            oscillators.push(osc);
                        });
                        
                        gainNode.connect(audioContext.destination);
                        studyWhiteNoise = { context: audioContext, oscillators: oscillators, gain: gainNode };
                    } catch (e) {
                        console.log('轻音乐创建失败:', e);
                    }
                    
                    this.classList.add('active');
                    document.getElementById('study-music-status').textContent = '关闭轻音乐';
                    document.getElementById('study-music-icon').className = 'fas fa-volume-up';
                } else {
                    if (studyWhiteNoise) {
                        if (studyWhiteNoise.oscillators) {
                            studyWhiteNoise.oscillators.forEach(osc => osc.stop());
                        }
                        if (studyWhiteNoise.node) {
                            studyWhiteNoise.node.disconnect();
                        }
                        studyWhiteNoise.context.close();
                        studyWhiteNoise = null;
                    }
                    this.classList.remove('active');
                    document.getElementById('study-music-status').textContent = '开启轻音乐';
                    document.getElementById('study-music-icon').className = 'fas fa-volume-mute';
                }
            });

            // 退出自习
            document.getElementById('exit-study-session').addEventListener('click', function() {
                if (confirm('确定要退出学习小组自习吗？')) {
                    clearInterval(studySessionInterval);
                    if (studyWhiteNoise) {
                        studyWhiteNoise.node.disconnect();
                        studyWhiteNoise.context.close();
                        studyWhiteNoise = null;
                    }
                    // 关闭摄像头
                    stopCamera();
                    document.getElementById('study-session-container').classList.remove('active');
                    document.body.style.overflow = '';
                    isStudying = false;
                    isResting = false;
                    studyTime = 0;
                }
            });

            // ============ 摄像头监督功能 ============
            let cameraStream = null;
            
            // 开启摄像头
            document.getElementById('start-camera-btn').addEventListener('click', async function() {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        video: { 
                            width: { ideal: 640 },
                            height: { ideal: 480 }
                        } 
                    });
                    
                    cameraStream = stream;
                    const video = document.getElementById('camera-video');
                    video.srcObject = stream;
                    
                    // 显示视频，隐藏占位符
                    document.getElementById('camera-placeholder').style.display = 'none';
                    video.style.display = 'block';
                    
                    // 切换按钮
                    document.getElementById('start-camera-btn').style.display = 'none';
                    document.getElementById('stop-camera-btn').style.display = 'inline-flex';
                    
                    showNotification('摄像头已开启，开始监督学习状态 📹', 'success');
                } catch (error) {
                    console.error('摄像头开启失败:', error);
                    if (error.name === 'NotAllowedError') {
                        showNotification('摄像头权限被拒绝，请在浏览器设置中允许访问摄像头', 'error');
                    } else if (error.name === 'NotFoundError') {
                        showNotification('未检测到摄像头设备', 'error');
                    } else {
                        showNotification('摄像头开启失败: ' + error.message, 'error');
                    }
                }
            });
            
            // 关闭摄像头
            document.getElementById('stop-camera-btn').addEventListener('click', function() {
                stopCamera();
                showNotification('摄像头已关闭', 'info');
            });
            
            function stopCamera() {
                if (cameraStream) {
                    cameraStream.getTracks().forEach(track => track.stop());
                    cameraStream = null;
                    
                    const video = document.getElementById('camera-video');
                    video.srcObject = null;
                    video.style.display = 'none';
                    
                    document.getElementById('camera-placeholder').style.display = 'flex';
                    document.getElementById('start-camera-btn').style.display = 'inline-flex';
                    document.getElementById('stop-camera-btn').style.display = 'none';
                }
            }
            // ============ 摄像头监督功能结束 ============

            // 发送学习小组消息
            document.getElementById('send-study-message').addEventListener('click', function() {
                sendStudyMessage();
            });

            document.getElementById('study-chat-message').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendStudyMessage();
                }
            });

            function sendStudyMessage() {
                if (!isResting) {
                    showNotification('学习期间无法交流，请等待休息时间', 'info');
                    return;
                }
                
                const input = document.getElementById('study-chat-message');
                const message = input.value.trim();
                if (!message) return;
                
                const messages = document.getElementById('study-chat-messages');
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message';
                messageDiv.innerHTML = `
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.3rem;">
                        <strong>${userManager.getUserProfile().username || '我'}</strong>
                        <span style="font-size: 0.8rem; color: #999;">${new Date().toLocaleTimeString()}</span>
                    </div>
                    <p>${message}</p>
                `;
                messages.appendChild(messageDiv);
                messages.scrollTop = messages.scrollHeight;
                input.value = '';
            }

            // 发送组队自习邀请（在聊天中）
            function sendStudyInvite(friendId) {
                if (!currentChat) return;
                
                const inviteMessage = {
                    type: 'study_invite',
                    from: userManager.getUserProfile().username || '我',
                    teamId: 'team_' + Date.now(),
                    message: '邀请你一起组队学习！'
                };
                
                showNotification('组队学习邀请已发送', 'success');
                // 在实际应用中，这里会通过WebSocket或API发送邀请
            }

            // 专业支持预约功能
            document.getElementById('professional-support-btn').addEventListener('click', function() {
                document.getElementById('appointment-modal').classList.add('active');
            });

            document.getElementById('close-appointment-modal').addEventListener('click', function() {
                document.getElementById('appointment-modal').classList.remove('active');
            });

            document.getElementById('free-appointment').addEventListener('click', function() {
                showNotification('免费预约功能开发中，敬请期待 🌸', 'info');
                // 这里可以添加实际的预约逻辑
            });

            document.getElementById('paid-appointment').addEventListener('click', function() {
                showNotification('付费预约功能开发中，敬请期待 🌟', 'info');
                // 这里可以添加实际的预约逻辑
            });

            // 点击模态框外部关闭
            document.getElementById('appointment-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    this.classList.remove('active');
                }
            });

            // 通知功能
            function showNotification(message, type) {
                if (!type) type = 'info';
                // 创建通知元素
                const notification = document.createElement('div');
                notification.className = 'notification notification-' + type;
                
                // 根据类型选择图标
                let icon = 'info-circle';
                if (type === 'success') icon = 'check-circle';
                if (type === 'error') icon = 'exclamation-circle';
                
                notification.innerHTML = 
                    '<div class="notification-content">' +
                    '<i class="fas fa-' + icon + '"></i>' +
                    '<span>' + message + '</span>' +
                    '</div>';
                
                // 根据类型设置背景色
                let backgroundColor = '#2196F3'; // info - 蓝色
                if (type === 'success') backgroundColor = '#4CAF50'; // success - 绿色
                if (type === 'error') backgroundColor = '#f44336'; // error - 红色
                
                // 添加样式
                notification.style.cssText = 
                    'position: fixed;' +
                    'top: 20px;' +
                    'right: 20px;' +
                    'background: ' + backgroundColor + ';' +
                    'color: white;' +
                    'padding: 1rem 1.5rem;' +
                    'border-radius: 8px;' +
                    'box-shadow: 0 5px 15px rgba(0,0,0,0.2);' +
                    'z-index: 10000;' +
                    'animation: slideIn 0.3s ease;';
                
                document.body.appendChild(notification);
                
                // 3秒后移除
                setTimeout(function() {
                    notification.style.animation = 'slideOut 0.3s ease';
                    setTimeout(function() {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 300);
                }, 3000);
            }

            // 添加通知动画
            const style = document.createElement('style');
            style.textContent = 
                '@keyframes slideIn {' +
                '  from { transform: translateX(100%); opacity: 0; }' +
                '  to { transform: translateX(0); opacity: 1; }' +
                '}' +
                '@keyframes slideOut {' +
                '  from { transform: translateX(0); opacity: 1; }' +
                '  to { transform: translateX(100%); opacity: 0; }' +
                '}';
            document.head.appendChild(style);

            // 老板键功能
            document.getElementById('boss-key').addEventListener('click', function() {
                const appContainer = document.querySelector('.app-container');
                
                if (appContainer.style.display !== 'none') {
                    appContainer.style.display = 'none';
                    this.innerHTML = '<i class="fas fa-eye"></i>';
                    showNotification('已隐藏界面，再次点击恢复显示', 'info');
                } else {
                    appContainer.style.display = 'block';
                    this.innerHTML = '<i class="fas fa-magic"></i>';
                    showNotification('欢迎回来！', 'success');
                }
            });

            // 社区加入功能
            document.querySelectorAll('.community-card .btn').forEach(function(button) {
                button.addEventListener('click', function() {
                    const communityName = this.closest('.community-card').querySelector('h3').textContent;
                    if (this.textContent === '加入社区') {
                        this.textContent = '已加入';
                        this.classList.remove('btn-outline');
                        this.classList.add('btn-primary');
                        showNotification('已加入 ' + communityName, 'success');
                    } else {
                        this.textContent = '加入社区';
                        this.classList.remove('btn-primary');
                        this.classList.add('btn-outline');
                        showNotification('已退出 ' + communityName, 'info');
                    }
                });
            });

            // 个人信息设置功能
            document.getElementById('user-avatar').addEventListener('click', function() {
                if (userManager.currentUser) {
                    openProfileModal();
                } else {
                    showNotification('请先登录', 'info');
                    // 显示登录界面
                    document.getElementById('auth-modal').style.display = 'flex';
                }
            });

            // 设置按钮点击事件
            document.querySelector('.settings-icon').addEventListener('click', function() {
                if (userManager.currentUser) {
                    openProfileModal();
                } else {
                    showNotification('请先登录', 'info');
                    // 显示登录界面
                    document.getElementById('auth-modal').style.display = 'flex';
                }
            });

            function openProfileModal() {
                const profile = userManager.getUserProfile();
                document.getElementById('profile-username').value = profile.username || '';
                document.getElementById('profile-bio').value = profile.bio || '';
                document.getElementById('profile-chat-id').value = chatId;
                
                // 生成头像选择器
                const avatars = ['👤', '🐱', '🐶', '🐰', '🐻', '🦊', '🐼', '🐨', '🐯', '🦁', '🐸', '🐷', '🐮', '🐵', '🐧', '🦄', '🐝', '🦋', '🌻', '🌸', '⭐', '🌟', '💫', '✨', '🎈', '🎀', '🎁', '🎂', '🍀', '🌙'];
                const avatarSelector = document.getElementById('avatar-selector');
                avatarSelector.innerHTML = '';
                
                avatars.forEach((avatar, index) => {
                    const option = document.createElement('div');
                    option.className = 'avatar-option';
                    if (profile.avatar === avatar) {
                        option.classList.add('selected');
                    }
                    option.textContent = avatar;
                    option.addEventListener('click', function() {
                        document.querySelectorAll('.avatar-option').forEach(opt => opt.classList.remove('selected'));
                        this.classList.add('selected');
                    });
                    avatarSelector.appendChild(option);
                });
                
                document.getElementById('profile-modal').classList.add('active');
            }

            document.getElementById('close-profile-modal').addEventListener('click', function() {
                document.getElementById('profile-modal').classList.remove('active');
            });

            document.getElementById('save-profile').addEventListener('click', function() {
                const username = document.getElementById('profile-username').value.trim();
                const bio = document.getElementById('profile-bio').value.trim();
                const selectedAvatar = document.querySelector('.avatar-option.selected');
                const avatar = selectedAvatar ? selectedAvatar.textContent : '👤';
                
                if (!username) {
                    showNotification('请输入昵称', 'error');
                    return;
                }
                
                // 保存所有设置
                const settings = {
                    username,
                    avatar,
                    bio,
                    notifications: {
                        message: document.getElementById('msg-notification').checked,
                        mood: document.getElementById('mood-reminder').checked,
                        study: document.getElementById('study-reminder').checked,
                        sound: document.getElementById('sound-notification').checked
                    },
                    privacy: {
                        allowStranger: document.getElementById('allow-stranger').checked,
                        showOnline: document.getElementById('show-online-status').checked
                    },
                    study: {
                        goal: document.getElementById('study-goal').value,
                        focusTime: document.getElementById('focus-time').value,
                        restTime: document.getElementById('rest-time').value
                    }
                };
                
                userManager.saveUserProfile(settings);
                localStorage.setItem('user_settings', JSON.stringify(settings));
                showNotification('所有设置已保存成功！', 'success');
                document.getElementById('profile-modal').classList.remove('active');
            });
            
            // 主题切换
            document.querySelectorAll('.theme-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.theme-option').forEach(opt => {
                        opt.style.borderColor = 'transparent';
                        opt.innerHTML = '';
                    });
                    this.style.borderColor = this.style.background.match(/\#[0-9a-f]{6}/i)[0];
                    this.innerHTML = '<i class="fas fa-check" style="color: white; font-weight: 600;"></i>';
                    
                    const theme = this.getAttribute('data-theme');
                    localStorage.setItem('theme', theme);
                    showNotification('主题已切换', 'success');
                });
            });
            
            // 清除数据
            document.getElementById('clear-data-btn').addEventListener('click', function() {
                if (confirm('确定要清除所有本地数据吗？这将删除你的所有记录（不包括账号信息）')) {
                    localStorage.removeItem('mood_records');
                    localStorage.removeItem('mood_alerts');
                    localStorage.removeItem('notifications');
                    showNotification('本地数据已清除', 'success');
                }
            });
            
            // 导出数据
            document.getElementById('export-data-btn').addEventListener('click', function() {
                const data = {
                    profile: userManager.getUserProfile(),
                    moods: moodTracker.moods,
                    settings: JSON.parse(localStorage.getItem('user_settings') || '{}'),
                    exportTime: new Date().toISOString()
                };
                
                const dataStr = JSON.stringify(data, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `心屿学院数据导出_${new Date().toLocaleDateString()}.json`;
                a.click();
                URL.revokeObjectURL(url);
                
                showNotification('数据导出成功！', 'success');
            });
            
            // 退出登录
            document.getElementById('logout-btn').addEventListener('click', function() {
                if (confirm('确定要退出登录吗？')) {
                    localStorage.removeItem('current_user');
                    location.reload();
                }
            });
            
            // ============ 通知中心功能 ============
            class NotificationCenter {
                constructor() {
                    this.notifications = this.loadNotifications();
                }
                
                loadNotifications() {
                    const stored = localStorage.getItem('notifications');
                    return stored ? JSON.parse(stored) : this.getDefaultNotifications();
                }
                
                getDefaultNotifications() {
                    return [
                        {
                            id: Date.now() + 1,
                            type: 'system',
                            title: '欢迎来到心屿学院',
                            content: '感谢你加入我们！在这里，你可以记录情绪、学习心理知识、与同学交流。祝你学习愉快！',
                            time: new Date().toLocaleString('zh-CN'),
                            read: false,
                            icon: 'fa-heart'
                        },
                        {
                            id: Date.now() + 2,
                            type: 'system',
                            title: '每日情绪记录提醒',
                            content: '记得每天记录你的情绪哦，这有助于了解自己的情绪变化规律。',
                            time: new Date().toLocaleString('zh-CN'),
                            read: false,
                            icon: 'fa-smile'
                        }
                    ];
                }
                
                saveNotifications() {
                    localStorage.setItem('notifications', JSON.stringify(this.notifications));
                }
                
                addNotification(type, title, content, icon = 'fa-bell') {
                    const notification = {
                        id: Date.now(),
                        type,
                        title,
                        content,
                        time: new Date().toLocaleString('zh-CN'),
                        read: false,
                        icon
                    };
                    this.notifications.unshift(notification);
                    this.saveNotifications();
                    this.updateBadge();
                    return notification;
                }
                
                markAsRead(id) {
                    const notification = this.notifications.find(n => n.id === id);
                    if (notification) {
                        notification.read = true;
                        this.saveNotifications();
                        this.updateBadge();
                    }
                }
                
                markAllAsRead() {
                    this.notifications.forEach(n => n.read = true);
                    this.saveNotifications();
                    this.updateBadge();
                }
                
                getUnreadCount() {
                    return this.notifications.filter(n => !n.read).length;
                }
                
                updateBadge() {
                    const count = this.getUnreadCount();
                    const badge = document.getElementById('all-count');
                    if (badge) {
                        badge.textContent = count;
                        badge.style.display = count > 0 ? 'inline' : 'none';
                    }
                }
                
                renderNotifications(filter = 'all') {
                    const container = document.getElementById('notifications-list');
                    let filtered = this.notifications;
                    
                    if (filter !== 'all') {
                        filtered = this.notifications.filter(n => n.type === filter);
                    }
                    
                    if (filtered.length === 0) {
                        container.innerHTML = '<p style="text-align: center; color: #999; padding: 2rem;">暂无通知</p>';
                        return;
                    }
                    
                    container.innerHTML = filtered.map(n => `
                        <div class="notification-item ${n.read ? '' : 'unread'}" onclick="notificationCenter.markAsRead(${n.id}); notificationCenter.renderNotifications('${filter}');">
                            <div class="notification-header">
                                <div class="notification-title">
                                    <i class="fas ${n.icon}" style="color: #667eea;"></i>
                                    ${n.title}
                                    ${!n.read ? '<span style="width: 8px; height: 8px; background: #FF6B6B; border-radius: 50%; display: inline-block; margin-left: 0.5rem;"></span>' : ''}
                                </div>
                                <div class="notification-time">${n.time}</div>
                            </div>
                            <div class="notification-content">${n.content}</div>
                        </div>
                    `).join('');
                }
            }
            
            const notificationCenter = new NotificationCenter();
            notificationCenter.updateBadge();
            
            // 打开通知中心（需要在导航栏添加按钮）
            function openNotificationCenter() {
                notificationCenter.renderNotifications('all');
                document.getElementById('notification-center-modal').classList.add('active');
            }
            
            // 关闭通知中心
            document.getElementById('close-notification-center').addEventListener('click', function() {
                document.getElementById('notification-center-modal').classList.remove('active');
            });
            
            // 通知标签切换
            document.querySelectorAll('.notification-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.notification-tab').forEach(t => {
                        t.classList.remove('active');
                        t.classList.remove('btn-primary');
                        t.classList.add('btn-outline');
                    });
                    this.classList.add('active');
                    this.classList.add('btn-primary');
                    this.classList.remove('btn-outline');
                    
                    const filter = this.getAttribute('data-tab');
                    notificationCenter.renderNotifications(filter);
                });
            });
            
            // 全部标记为已读
            document.getElementById('clear-all-notifications').addEventListener('click', function() {
                notificationCenter.markAllAsRead();
                const currentTab = document.querySelector('.notification-tab.active').getAttribute('data-tab');
                notificationCenter.renderNotifications(currentTab);
                showNotification('所有通知已标记为已读', 'success');
            });
            
            // 点击背景关闭通知中心
            document.getElementById('notification-center-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    this.classList.remove('active');
                }
            });
            
            // 添加示例通知（可以在其他功能中调用）
            window.addNotification = function(type, title, content, icon) {
                notificationCenter.addNotification(type, title, content, icon);
            };
            
            // ============ 通知中心功能结束 ============

            // 呼吸训练功能
            let breathingInterval;
            let breathingState = 'idle'; // idle, in, hold, out
            let breathingCycle = 0;
            let musicEnabled = false;
            const meditationMusic = document.getElementById('meditation-music');
            let breathingTimeouts = []; // 存储所有timeout用于清理

            // 音乐控制 - 创建白噪音+轻音乐混合
            let meditationAudioContext = null;
            let meditationGainNode = null;
            let meditationOscillator = null;
            let meditationWhiteNoise = null;

            document.getElementById('music-control').addEventListener('click', function() {
                musicEnabled = !musicEnabled;
                if (musicEnabled) {
                    // 创建白噪音+轻音乐混合
                    try {
                        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                        const bufferSize = 4096;
                        
                        // 白噪音
                        const whiteNoise = audioContext.createScriptProcessor(bufferSize, 0, 1);
                        whiteNoise.onaudioprocess = function(e) {
                            const output = e.outputBuffer.getChannelData(0);
                            for (let i = 0; i < bufferSize; i++) {
                                output[i] = (Math.random() * 2 - 1) * 0.05; // 白噪音
                            }
                        };
                        
                        // 轻音乐（使用低频正弦波模拟）
                        const oscillator = audioContext.createOscillator();
                        oscillator.type = 'sine';
                        oscillator.frequency.value = 220; // A3音符
                        oscillator.start();
                        
                        // 混合音频
                        const gainNode = audioContext.createGain();
                        gainNode.gain.value = 0.15; // 降低音量
                        
                        whiteNoise.connect(gainNode);
                        oscillator.connect(gainNode);
                        gainNode.connect(audioContext.destination);
                        
                        meditationAudioContext = audioContext;
                        meditationGainNode = gainNode;
                        meditationOscillator = oscillator;
                        meditationWhiteNoise = whiteNoise;
                        
                        this.classList.add('active');
                        document.getElementById('music-status').textContent = '关闭冥想音乐';
                        document.getElementById('music-icon').className = 'fas fa-volume-up';
                    } catch (e) {
                        console.log('音频创建失败:', e);
                        // 降级方案：使用HTML5音频
                        meditationMusic.play().catch(err => console.log('音乐播放需要用户交互'));
                        this.classList.add('active');
                        document.getElementById('music-status').textContent = '关闭冥想音乐';
                        document.getElementById('music-icon').className = 'fas fa-volume-up';
                    }
                } else {
                    // 停止音频
                    if (meditationAudioContext) {
                        if (meditationWhiteNoise) meditationWhiteNoise.disconnect();
                        if (meditationOscillator) meditationOscillator.stop();
                        meditationAudioContext.close();
                        meditationAudioContext = null;
                        meditationGainNode = null;
                        meditationOscillator = null;
                        meditationWhiteNoise = null;
                    }
                    meditationMusic.pause();
                    this.classList.remove('active');
                    document.getElementById('music-status').textContent = '开启冥想音乐';
                    document.getElementById('music-icon').className = 'fas fa-volume-mute';
                }
            });

            document.getElementById('breathing-exercise-btn').addEventListener('click', function() {
                document.getElementById('breathing-modal').classList.add('active');
                resetBreathing();
            });

            document.getElementById('close-breathing-modal').addEventListener('click', function() {
                stopBreathing();
                // 停止所有音频
                if (meditationAudioContext) {
                    if (meditationWhiteNoise) meditationWhiteNoise.disconnect();
                    if (meditationOscillator) meditationOscillator.stop();
                    meditationAudioContext.close();
                    meditationAudioContext = null;
                    meditationGainNode = null;
                    meditationOscillator = null;
                    meditationWhiteNoise = null;
                }
                meditationMusic.pause();
                musicEnabled = false;
                document.getElementById('breathing-modal').classList.remove('active');
            });

            document.getElementById('start-breathing').addEventListener('click', function() {
                startBreathing();
            });

            document.getElementById('pause-breathing').addEventListener('click', function() {
                pauseBreathing();
            });

            document.getElementById('stop-breathing').addEventListener('click', function() {
                stopBreathing();
            });

            function startBreathing() {
                breathingState = 'in';
                breathingCycle = 0;
                breathingTimeouts = []; // 清空之前的timeouts
                document.getElementById('start-breathing').style.display = 'none';
                document.getElementById('pause-breathing').style.display = 'inline-flex';
                document.getElementById('stop-breathing').style.display = 'inline-flex';
                
                const circle = document.getElementById('breathing-circle');
                const text = document.getElementById('breathing-text');
                const instruction = document.getElementById('breathing-instruction');
                
                // 开始呼吸循环
                function breathingCycleFunc() {
                    // 吸气阶段（4秒）
                    circle.classList.remove('breathing-out', 'breathing-hold');
                    circle.classList.add('breathing-in');
                    text.textContent = '吸气';
                    instruction.textContent = '慢慢吸气，感受空气进入身体... 🌸';
                    
                    const timeout1 = setTimeout(function() {
                        if (breathingState === 'idle') return;
                        
                        // 屏气阶段（2秒）
                        circle.classList.remove('breathing-in');
                        circle.classList.add('breathing-hold');
                        text.textContent = '屏气';
                        instruction.textContent = '保持住，感受这一刻的宁静... ✨';
                        
                        const timeout2 = setTimeout(function() {
                            if (breathingState === 'idle') return;
                            
                            // 呼气阶段（4秒）
                            circle.classList.remove('breathing-hold');
                            circle.classList.add('breathing-out');
                            text.textContent = '呼气';
                            instruction.textContent = '慢慢呼气，让身体完全放松... 💫';
                            
                            const timeout3 = setTimeout(function() {
                                if (breathingState === 'idle') return;
                                
                                // 短暂停顿（1秒）
                                const timeout4 = setTimeout(function() {
                                    if (breathingState === 'idle') return;
                                    breathingCycleFunc(); // 继续下一个循环
                                }, 1000);
                                breathingTimeouts.push(timeout4);
                            }, 4000);
                            breathingTimeouts.push(timeout3);
                        }, 2000);
                        breathingTimeouts.push(timeout2);
                    }, 4000);
                    breathingTimeouts.push(timeout1);
                }
                
                breathingCycleFunc();
            }

            function pauseBreathing() {
                breathingState = 'idle';
                // 清除所有timeout
                breathingTimeouts.forEach(timeout => clearTimeout(timeout));
                breathingTimeouts = [];
                
                const circle = document.getElementById('breathing-circle');
                circle.classList.remove('breathing-in', 'breathing-out', 'breathing-hold');
                document.getElementById('start-breathing').style.display = 'inline-flex';
                document.getElementById('pause-breathing').style.display = 'none';
            }

            function stopBreathing() {
                breathingState = 'idle';
                // 清除所有timeout
                breathingTimeouts.forEach(timeout => clearTimeout(timeout));
                breathingTimeouts = [];
                
                const circle = document.getElementById('breathing-circle');
                circle.classList.remove('breathing-in', 'breathing-out', 'breathing-hold');
                resetBreathing();
            }

            function resetBreathing() {
                breathingState = 'idle';
                breathingCycle = 0;
                // 清除所有timeout
                breathingTimeouts.forEach(timeout => clearTimeout(timeout));
                breathingTimeouts = [];
                
                const circle = document.getElementById('breathing-circle');
                circle.classList.remove('breathing-in', 'breathing-out', 'breathing-hold');
                circle.style.transform = 'scale(1)';
                document.getElementById('breathing-text').textContent = '准备开始';
                document.getElementById('breathing-instruction').textContent = '点击开始，跟随节奏呼吸';
                document.getElementById('start-breathing').style.display = 'inline-flex';
                document.getElementById('pause-breathing').style.display = 'none';
                document.getElementById('stop-breathing').style.display = 'none';
            }

            // 正念练习功能
            const mindfulnessExercises = [
                {
                    title: '身体扫描正念练习',
                    steps: [
                        { text: '找一个安静舒适的地方，闭上眼睛', time: 0 },
                        { text: '从头部开始，慢慢感受身体的每一部分', time: 30 },
                        { text: '感受脚趾、脚掌、脚踝的放松', time: 30 },
                        { text: '感受小腿、大腿的放松', time: 30 },
                        { text: '感受腹部、胸部的放松', time: 30 },
                        { text: '感受肩膀、手臂的放松', time: 30 },
                        { text: '感受整个身体的平静与放松', time: 30 },
                        { text: '慢慢睁开眼睛，回到当下', time: 0 }
                    ]
                },
                {
                    title: '呼吸正念练习',
                    steps: [
                        { text: '坐直或躺下，闭上眼睛', time: 0 },
                        { text: '专注于你的呼吸，感受空气的流动', time: 60 },
                        { text: '当思绪飘走时，温柔地将注意力带回呼吸', time: 60 },
                        { text: '感受每一次呼吸带来的平静', time: 60 },
                        { text: '慢慢睁开眼睛，带着这份平静继续今天', time: 0 }
                    ]
                },
                {
                    title: '情绪观察正念练习',
                    steps: [
                        { text: '找一个安静的地方，闭上眼睛', time: 0 },
                        { text: '观察你现在的情绪，不要评判', time: 30 },
                        { text: '感受情绪在身体中的位置', time: 30 },
                        { text: '像观察云朵一样观察情绪，让它自然流动', time: 60 },
                        { text: '记住，情绪只是暂时的，它会过去', time: 30 },
                        { text: '慢慢睁开眼睛，带着接纳继续生活', time: 0 }
                    ]
                }
            ];

            document.getElementById('mindfulness-exercise-btn').addEventListener('click', function() {
                const exercise = mindfulnessExercises[Math.floor(Math.random() * mindfulnessExercises.length)];
                loadMindfulnessExercise(exercise);
                document.getElementById('mindfulness-modal').classList.add('active');
            });

            document.getElementById('close-mindfulness-modal').addEventListener('click', function() {
                document.getElementById('mindfulness-modal').classList.remove('active');
            });

            function loadMindfulnessExercise(exercise) {
                const content = document.getElementById('mindfulness-content');
                let html = `
                    <div style="text-align: center; margin-bottom: 2rem; position: relative; z-index: 2;">
                        <div style="font-size: 4rem; margin-bottom: 1rem;">🧘</div>
                        <h3 style="font-family: 'Comfortaa', cursive; color: #2C3E50; margin-bottom: 0.5rem; font-size: 1.8rem;">${exercise.title}</h3>
                        <p style="color: #666; line-height: 1.8;">慢慢来，不着急，给自己一些温柔的时间 🌸</p>
                    </div>
                `;
                
                html += `<div style="position: relative; z-index: 2;">`;
                exercise.steps.forEach((step, index) => {
                    html += `
                        <div class="mindfulness-step" style="position: relative; z-index: 2;">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.8rem;">
                                <div style="width: 30px; height: 30px; border-radius: 50%; background: linear-gradient(135deg, #FF6B6B, #FF8E53); color: white; display: flex; align-items: center; justify-content: center; font-weight: bold;">${index + 1}</div>
                                <h4 style="margin: 0; font-family: 'Comfortaa', cursive; color: #2C3E50;">${step.text}</h4>
                            </div>
                            ${step.time > 0 ? `<div class="mindfulness-timer" style="margin-top: 1rem;">${step.time}秒</div>` : ''}
                        </div>
                    `;
                });
                html += `</div>`;
                
                html += `
                    <button class="btn btn-primary" id="start-mindfulness" style="width: 100%; margin-top: 1.5rem; position: relative; z-index: 2;">
                        <i class="fas fa-play"></i> 开始正念练习
                    </button>
                `;
                
                content.innerHTML = html;
                
                // 添加开始按钮事件
                const startBtn = document.getElementById('start-mindfulness');
                if (startBtn) {
                    startBtn.addEventListener('click', function() {
                        startMindfulnessExercise(exercise);
                    });
                }
            }

            function startMindfulnessExercise(exercise) {
                let currentStep = 0;
                const content = document.getElementById('mindfulness-content');
                
                function showStep() {
                    if (currentStep >= exercise.steps.length) {
                        content.innerHTML = `
                            <div style="text-align: center; padding: 3rem; position: relative; z-index: 2;">
                                <div style="font-size: 5rem; margin-bottom: 1rem;">✨</div>
                                <h3 style="font-family: 'Comfortaa', cursive; color: #2C3E50; margin-bottom: 1rem; font-size: 2rem;">练习完成！</h3>
                                <p style="color: #666; margin-bottom: 1.5rem; font-size: 1.2rem; line-height: 1.8;">你做得很好！继续保持这份平静，你已经很棒了 💕</p>
                                <button class="btn btn-primary" onclick="document.getElementById('mindfulness-modal').classList.remove('active')">
                                    <i class="fas fa-check"></i> 完成
                                </button>
                            </div>
                        `;
                        return;
                    }
                    
                    const step = exercise.steps[currentStep];
                    let html = `
                        <div style="text-align: center; margin-bottom: 2rem; position: relative; z-index: 2;">
                            <div style="font-size: 3rem; margin-bottom: 1rem;">🧘</div>
                            <h3 style="font-family: 'Comfortaa', cursive; color: #2C3E50; margin-bottom: 0.5rem;">${exercise.title}</h3>
                            <p style="color: #999; font-size: 0.9rem;">步骤 ${currentStep + 1} / ${exercise.steps.length}</p>
                        </div>
                        <div class="mindfulness-step" style="position: relative; z-index: 2;">
                            <p style="font-size: 1.3rem; margin: 1.5rem 0; line-height: 1.8; color: #2C3E50; text-align: center;">${step.text}</p>
                            ${step.time > 0 ? `
                                <div style="text-align: center; margin: 2rem 0;">
                                    <div class="mindfulness-timer" id="mindfulness-timer" style="font-size: 4rem;">${step.time}</div>
                                    <p style="color: #666; margin-top: 0.5rem;">慢慢来，不着急</p>
                                </div>
                            ` : ''}
                        </div>
                        <button class="btn btn-primary" id="next-step" style="width: 100%; margin-top: 1.5rem; position: relative; z-index: 2;">
                            ${currentStep === exercise.steps.length - 1 ? '<i class="fas fa-check"></i> 完成' : '<i class="fas fa-arrow-right"></i> 下一步'}
                        </button>
                    `;
                    
                    content.innerHTML = html;
                    
                    // 倒计时
                    if (step.time > 0) {
                        let timeLeft = step.time;
                        const timer = document.getElementById('mindfulness-timer');
                        const countdown = setInterval(function() {
                            timeLeft--;
                            if (timer) {
                                timer.textContent = timeLeft;
                                if (timeLeft <= 5 && timeLeft > 0) {
                                    timer.style.color = '#FF6B6B';
                                }
                            }
                            if (timeLeft <= 0) {
                                clearInterval(countdown);
                                if (timer) timer.style.color = '#FF6B6B';
                            }
                        }, 1000);
                    }
                    
                    // 下一步按钮
                    const nextBtn = document.getElementById('next-step');
                    if (nextBtn) {
                        nextBtn.addEventListener('click', function() {
                            currentStep++;
                            showStep();
                        });
                    }
                }
                
                showStep();
            }

            // 心理学知识库
            const psychologyKnowledge = [
                { title: '什么是抑郁症', content: '抑郁症是一种常见的心理健康问题，表现为持续的情绪低落、兴趣丧失、疲劳等。重要的是，抑郁症是可以治疗的，寻求帮助是勇敢的表现。' },
                { title: '情绪管理技巧', content: '1. 深呼吸：当感到焦虑时，尝试4-7-8呼吸法（吸气4秒，屏息7秒，呼气8秒）。2. 正念冥想：专注于当下，观察情绪而不评判。3. 运动：适度的运动可以释放内啡肽，改善心情。' },
                { title: '自我关怀', content: '自我关怀意味着像对待好朋友一样对待自己。当你感到困难时，问问自己：我会对朋友说什么？然后对自己说同样温暖的话。记住，你值得被温柔对待。' },
                { title: '认知行为疗法基础', content: 'CBT帮助我们识别和改变负面思维模式。当你注意到负面想法时，问自己：这个想法有证据吗？有没有其他更积极的解释？这有助于建立更健康的思维习惯。' },
                { title: '社交支持的重要性', content: '与信任的人分享你的感受很重要。你不需要独自承受。无论是朋友、家人还是专业人士，寻求支持是力量的象征，不是弱点。' },
                { title: '睡眠与心理健康', content: '良好的睡眠对心理健康至关重要。建立规律的睡眠时间表，睡前避免屏幕，创造一个舒适的睡眠环境。如果睡眠问题持续，考虑寻求专业帮助。' },
                { title: '压力管理', content: '压力是生活的一部分，但我们可以学会管理它。尝试：1. 时间管理 2. 设定合理的目标 3. 学会说"不" 4. 定期休息 5. 培养兴趣爱好。' },
                { title: '建立日常习惯', content: '小的日常习惯可以带来大的改变。每天花5分钟写感恩日记，或者做一件让自己开心的小事。这些小小的行动会累积成积极的变化。' },
                { title: '处理负面情绪', content: '负面情绪是正常的，重要的是如何应对。允许自己感受情绪，但不要被情绪控制。尝试：1. 识别情绪 2. 接受它 3. 找到健康的表达方式 4. 寻求支持。' },
                { title: '成长型思维', content: '相信自己的能力可以通过努力和学习来发展。当遇到困难时，不要说"我做不到"，而是说"我还没学会"。这种思维方式有助于建立韧性。' }
            ];

            document.getElementById('knowledge-library-btn').addEventListener('click', function() {
                loadKnowledgeLibrary();
                document.getElementById('knowledge-modal').classList.add('active');
            });

            document.getElementById('close-knowledge-modal').addEventListener('click', function() {
                document.getElementById('knowledge-modal').classList.remove('active');
            });

            function loadKnowledgeLibrary() {
                const grid = document.getElementById('knowledge-grid');
                grid.innerHTML = '';
                
                psychologyKnowledge.forEach((knowledge, index) => {
                    const card = document.createElement('div');
                    card.className = 'knowledge-card';
                    card.innerHTML = `
                        <h4>${knowledge.title}</h4>
                        <p>${knowledge.content.substring(0, 100)}...</p>
                    `;
                    card.addEventListener('click', function() {
                        showKnowledgeDetail(knowledge);
                    });
                    grid.appendChild(card);
                });
            }

            function showKnowledgeDetail(knowledge) {
                const modal = document.createElement('div');
                modal.className = 'appointment-modal active';
                modal.innerHTML = `
                    <div class="appointment-container" style="max-width: 600px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h2 style="font-family: 'Comfortaa', cursive; color: #2C3E50;">${knowledge.title}</h2>
                            <button class="timer-close-btn" onclick="this.closest('.appointment-modal').remove()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <p style="color: #666; line-height: 1.8; font-size: 1.1rem;">${knowledge.content}</p>
                    </div>
                `;
                document.body.appendChild(modal);
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) modal.remove();
                });
            }

            // 每日文章功能
            const dailyArticles = [
                {
                    title: '每一个今天都是新的开始',
                    preview: '无论昨天发生了什么，今天都是全新的开始。你不需要完美，只需要做最好的自己...',
                    content: `
                        <h3>每一个今天都是新的开始</h3>
                        <p>无论昨天发生了什么，今天都是全新的开始。你不需要完美，只需要做最好的自己。</p>
                        <p>有时候，我们会因为过去的错误或失败而感到沮丧。但请记住，那些经历都是你成长的一部分。它们教会了你什么，让你变得更坚强、更智慧。</p>
                        <p>今天，给自己一个机会重新开始。不需要一下子改变所有事情，只需要迈出一小步。也许是整理一下房间，也许是给朋友发一条消息，也许是做一件让自己开心的小事。</p>
                        <p>每一个小小的行动都是进步。你比自己想象的更有力量。慢慢来，不着急，你已经很棒了。</p>
                        <p style="font-style: italic; color: #FF6B6B; margin-top: 2rem;">记住：每一天都是新的开始，每一刻都可以重新选择。你值得拥有美好的今天。💕</p>
                    `
                },
                {
                    title: '学会善待自己',
                    preview: '我们常常对别人很温柔，却对自己很苛刻。但请记住，你也值得被温柔对待...',
                    content: `
                        <h3>学会善待自己</h3>
                        <p>我们常常对别人很温柔，却对自己很苛刻。但请记住，你也值得被温柔对待。</p>
                        <p>当你感到困难时，问问自己：如果这是发生在朋友身上，我会对他说什么？然后，对自己说同样温暖的话。</p>
                        <p>自我关怀不是自私，而是必要的。就像飞机上的安全提示说的：先给自己戴上氧气面罩，才能帮助别人。</p>
                        <p>允许自己休息，允许自己犯错，允许自己不是完美的。这些都是人之常情，你不需要为此感到愧疚。</p>
                        <p style="font-style: italic; color: #FF6B6B; margin-top: 2rem;">今天，给自己一个拥抱，告诉自己：你已经做得很好了。🌸</p>
                    `
                },
                {
                    title: '情绪没有好坏之分',
                    preview: '我们常常认为某些情绪是"坏的"，想要摆脱它们。但情绪本身没有好坏之分...',
                    content: `
                        <h3>情绪没有好坏之分</h3>
                        <p>我们常常认为某些情绪是"坏的"，想要摆脱它们。但情绪本身没有好坏之分，它们只是信息，告诉我们内心正在发生什么。</p>
                        <p>悲伤、焦虑、愤怒——这些情绪都是正常的。它们出现时，不要试图压抑或忽视它们，而是尝试理解它们想要告诉你什么。</p>
                        <p>就像天气一样，情绪也会变化。暴风雨不会永远持续，阳光总会再次出现。重要的是，学会与情绪共处，而不是对抗它们。</p>
                        <p>当你感到难过时，允许自己感受这种情绪。给自己时间，给自己空间，给自己温柔。情绪会过去，但你的自我关怀会留下来。</p>
                        <p style="font-style: italic; color: #FF6B6B; margin-top: 2rem;">记住：你的情绪是合理的，你的感受是重要的。💫</p>
                    `
                },
                {
                    title: '小步前进的力量',
                    preview: '有时候，改变看起来太困难，目标看起来太遥远。但请记住，每一个大目标都是由小步骤组成的...',
                    content: `
                        <h3>小步前进的力量</h3>
                        <p>有时候，改变看起来太困难，目标看起来太遥远。但请记住，每一个大目标都是由小步骤组成的。</p>
                        <p>你不需要一下子改变所有事情。也许今天只是整理一下书桌，明天只是给朋友发一条消息，后天只是做10分钟的深呼吸练习。</p>
                        <p>这些看似微小的行动，累积起来就是巨大的改变。就像水滴石穿，持续的小步前进比偶尔的大步跳跃更有力量。</p>
                        <p>当你感到没有动力时，不要想着要完成所有事情。只专注于下一步，只专注于今天可以做的一件小事。</p>
                        <p style="font-style: italic; color: #FF6B6B; margin-top: 2rem;">记住：每一小步都是进步，每一小步都值得庆祝。🌟</p>
                    `
                },
                {
                    title: '你并不孤单',
                    preview: '有时候，我们会感到孤独，觉得自己是唯一在挣扎的人。但请记住，你并不孤单...',
                    content: `
                        <h3>你并不孤单</h3>
                        <p>有时候，我们会感到孤独，觉得自己是唯一在挣扎的人。但请记住，你并不孤单。</p>
                        <p>世界上有很多人正在经历类似的感受。虽然每个人的经历都是独特的，但痛苦和困难是人类共同体验的一部分。</p>
                        <p>寻求帮助不是软弱的表现，而是勇敢的选择。无论是朋友、家人还是专业人士，都有人愿意倾听和支持你。</p>
                        <p>你不需要独自承受一切。分享你的感受，寻求支持，这是照顾自己的重要方式。</p>
                        <p style="font-style: italic; color: #FF6B6B; margin-top: 2rem;">记住：有人关心你，有人愿意帮助你。你值得被支持和关爱。💕</p>
                    `
                }
            ];

            function loadDailyArticle() {
                // 根据日期选择文章（确保每天都是同一篇）
                const today = new Date();
                const dayOfYear = Math.floor((today - new Date(today.getFullYear(), 0, 0)) / 1000 / 60 / 60 / 24);
                const articleIndex = dayOfYear % dailyArticles.length;
                const article = dailyArticles[articleIndex];
                
                const preview = document.getElementById('daily-article-preview');
                if (preview) {
                    preview.innerHTML = `
                        <h3 style="font-family: 'Comfortaa', cursive; color: #2C3E50; margin-bottom: 1rem;">${article.title}</h3>
                        <p>${article.preview}</p>
                    `;
                }
                
                // 存储完整文章内容
                const fullContent = document.getElementById('daily-article-full-content');
                if (fullContent) {
                    fullContent.innerHTML = article.content;
                }
            }

            document.getElementById('read-daily-article').addEventListener('click', function() {
                document.getElementById('daily-article-modal').classList.add('active');
            });

            document.getElementById('close-daily-article-modal').addEventListener('click', function() {
                document.getElementById('daily-article-modal').classList.remove('active');
            });

            // 初始化每日文章
            loadDailyArticle();

            // 点击模态框外部关闭
            // 为所有模态框添加点击背景关闭功能
            document.querySelectorAll('.breathing-modal, .mindfulness-modal, .knowledge-modal, .daily-article-modal, .profile-modal, .appointment-modal, .tree-hole-modal, .peer-support-modal, .library-modal, .book-detail-modal').forEach(function(modal) {
                modal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        // 如果是呼吸训练模态框，需要停止呼吸训练
                        if (this.id === 'breathing-modal') {
                            stopBreathing();
                            if (meditationAudioContext) {
                                if (meditationWhiteNoise) meditationWhiteNoise.disconnect();
                                if (meditationOscillator) meditationOscillator.stop();
                                meditationAudioContext.close();
                                meditationAudioContext = null;
                                meditationGainNode = null;
                                meditationOscillator = null;
                                meditationWhiteNoise = null;
                            }
                            meditationMusic.pause();
                            musicEnabled = false;
                        }
                        // 如果是图书馆模态框，需要停止海报自动播放
                        if (this.id === 'library-modal') {
                            stopBannerAutoPlay();
                        }
                        this.classList.remove('active');
                    }
                });
            });

            // 兴趣社区系统
            let posts = JSON.parse(localStorage.getItem('community_posts') || '[]');
            let currentViewingPost = null;
            let interestGroups = JSON.parse(localStorage.getItem('interest_groups') || '[]');
            
            // 初始化示例帖子
            if (posts.length === 0) {
                posts = [
                    {
                        id: 'post_' + Date.now() + '_1',
                        author: { name: '阳光少年', avatar: '☀️', chatId: 'XY100001' },
                        title: '今天学习了新的编程知识',
                        content: '今天学习了JavaScript的异步编程，感觉打开了新世界的大门！分享给大家一些学习心得...',
                        topic: '学习分享',
                        time: '2小时前',
                        likes: 15,
                        comments: [],
                        favorites: 8,
                        likedBy: [],
                        favoritedBy: []
                    },
                    {
                        id: 'post_' + Date.now() + '_2',
                        author: { name: '心灵画师', avatar: '🎨', chatId: 'XY100002' },
                        title: '分享我的新画作',
                        content: '今天完成了一幅风景画，用了三个小时。画画真的很治愈，推荐大家也试试！',
                        topic: '兴趣爱好',
                        time: '5小时前',
                        likes: 23,
                        comments: [],
                        favorites: 12,
                        likedBy: [],
                        favoritedBy: []
                    },
                    {
                        id: 'post_' + Date.now() + '_3',
                        author: { name: '快乐小鸟', avatar: '🐦', chatId: 'XY100003' },
                        title: '今天心情特别好',
                        content: '今天天气很好，和朋友们一起去公园玩了。生活真美好！希望每天都能这么开心~',
                        topic: '心情日记',
                        time: '1天前',
                        likes: 18,
                        comments: [],
                        favorites: 5,
                        likedBy: [],
                        favoritedBy: []
                    }
                ];
                localStorage.setItem('community_posts', JSON.stringify(posts));
            }
            
            // 加载帖子列表
            function loadPosts() {
                const container = document.getElementById('posts-container');
                if (!container) return;
                
                if (posts.length === 0) {
                    container.innerHTML = '<div style="text-align: center; padding: 3rem; color: #999;">还没有动态，快来发布第一条吧！</div>';
                    return;
                }
                
                container.innerHTML = posts.map(post => `
                    <div class="post-card" data-post-id="${post.id}">
                        <div class="post-card-header">
                            <div class="post-author-avatar" data-author-id="${post.author.chatId}">${post.author.avatar}</div>
                            <div class="post-author-info">
                                <div class="post-author-name" data-author-id="${post.author.chatId}">${post.author.name}</div>
                                <div class="post-time">${post.time}</div>
                            </div>
                        </div>
                        <div class="post-card-body">
                            <div class="post-topic">${post.topic}</div>
                            <div class="post-title">${post.title}</div>
                            <div class="post-content-preview">${post.content}</div>
                        </div>
                        <div class="post-card-footer">
                            <div class="post-action post-like ${post.likedBy.includes(chatId) ? 'active' : ''}" data-post-id="${post.id}" onclick="event.stopPropagation(); toggleLike('${post.id}')">
                                <i class="fas fa-heart"></i>
                                <span>${post.likes}</span>
                            </div>
                            <div class="post-action">
                                <i class="fas fa-comment"></i>
                                <span>${post.comments.length}</span>
                            </div>
                            <div class="post-action post-favorite ${post.favoritedBy.includes(chatId) ? 'active' : ''}" data-post-id="${post.id}" onclick="event.stopPropagation(); toggleFavorite('${post.id}')">
                                <i class="fas fa-star"></i>
                                <span>${post.favorites}</span>
                            </div>
                        </div>
                    </div>
                `).join('');
                
                // 绑定点击事件
                document.querySelectorAll('.post-card').forEach(card => {
                    card.addEventListener('click', function(e) {
                        if (!e.target.closest('.post-action') && !e.target.closest('.post-author-avatar') && !e.target.closest('.post-author-name')) {
                            const postId = this.dataset.postId;
                            showPostDetail(postId);
                        }
                    });
                });
                
                // 绑定作者点击事件
                document.querySelectorAll('.post-author-avatar, .post-author-name').forEach(el => {
                    el.addEventListener('click', function(e) {
                        e.stopPropagation();
                        const authorId = this.dataset.authorId;
                        showUserProfile(authorId);
                    });
                });
            }
            
            // 点赞功能
            window.toggleLike = function(postId) {
                const post = posts.find(p => p.id === postId);
                if (!post) return;
                
                const likedIndex = post.likedBy.indexOf(chatId);
                if (likedIndex > -1) {
                    post.likedBy.splice(likedIndex, 1);
                    post.likes--;
                } else {
                    post.likedBy.push(chatId);
                    post.likes++;
                }
                
                localStorage.setItem('community_posts', JSON.stringify(posts));
                loadPosts();
                showNotification(likedIndex > -1 ? '已取消点赞' : '点赞成功！', 'success');
            };
            
            // 收藏功能
            window.toggleFavorite = function(postId) {
                const post = posts.find(p => p.id === postId);
                if (!post) return;
                
                const favIndex = post.favoritedBy.indexOf(chatId);
                if (favIndex > -1) {
                    post.favoritedBy.splice(favIndex, 1);
                    post.favorites--;
                } else {
                    post.favoritedBy.push(chatId);
                    post.favorites++;
                }
                
                localStorage.setItem('community_posts', JSON.stringify(posts));
                loadPosts();
                showNotification(favIndex > -1 ? '已取消收藏' : '收藏成功！', 'success');
            };
            
            // 显示帖子详情
            function showPostDetail(postId) {
                const post = posts.find(p => p.id === postId);
                if (!post) return;
                
                currentViewingPost = post;
                const content = document.getElementById('post-detail-content');
                
                content.innerHTML = `
                    <div class="post-detail-header">
                        <div class="post-detail-avatar" onclick="showUserProfile('${post.author.chatId}')">${post.author.avatar}</div>
                        <div class="post-detail-info">
                            <div style="font-weight: 600; color: #2C3E50; font-size: 1.1rem; margin-bottom: 0.3rem; cursor: pointer;" onclick="showUserProfile('${post.author.chatId}')">${post.author.name}</div>
                            <div style="color: #999; font-size: 0.9rem;">${post.time}</div>
                        </div>
                    </div>
                    <div class="post-topic">${post.topic}</div>
                    <h3 style="color: #2C3E50; margin: 1rem 0;">${post.title}</h3>
                    <div style="color: #666; line-height: 1.8; margin-bottom: 1.5rem;">${post.content}</div>
                    <div class="post-detail-actions">
                        <button class="btn ${post.likedBy.includes(chatId) ? 'btn-primary' : 'btn-outline'}" onclick="toggleLikeInDetail('${post.id}')">
                            <i class="fas fa-heart"></i> ${post.likedBy.includes(chatId) ? '已点赞' : '点赞'} (${post.likes})
                        </button>
                        <button class="btn ${post.favoritedBy.includes(chatId) ? 'btn-primary' : 'btn-outline'}" onclick="toggleFavoriteInDetail('${post.id}')">
                            <i class="fas fa-star"></i> ${post.favoritedBy.includes(chatId) ? '已收藏' : '收藏'} (${post.favorites})
                        </button>
                    </div>
                    <div class="comment-section">
                        <h4 style="color: #2C3E50; margin-bottom: 1rem;"><i class="fas fa-comments"></i> 评论 (${post.comments.length})</h4>
                        <div class="comment-input-area">
                            <textarea id="comment-input" placeholder="写下你的评论..."></textarea>
                            <button class="btn btn-primary" onclick="addComment('${post.id}')" style="align-self: flex-end;">
                                <i class="fas fa-paper-plane"></i> 发送
                            </button>
                        </div>
                        <div id="comments-list">
                            ${post.comments.map(comment => `
                                <div class="comment-item">
                                    <div class="comment-header">
                                        <div class="comment-avatar">${comment.avatar}</div>
                                        <div style="flex: 1;">
                                            <span class="comment-author">${comment.author}</span>
                                            <span class="comment-time" style="margin-left: 0.5rem;">${comment.time}</span>
                                        </div>
                                    </div>
                                    <div class="comment-content">${comment.content}</div>
                                </div>
                            `).join('') || '<div style="text-align: center; color: #999; padding: 2rem;">还没有评论，快来抢沙发吧！</div>'}
                        </div>
                    </div>
                `;
                
                document.getElementById('post-detail-modal').classList.add('active');
            }
            
            // 详情页点赞
            window.toggleLikeInDetail = function(postId) {
                toggleLike(postId);
                showPostDetail(postId);
            };
            
            // 详情页收藏
            window.toggleFavoriteInDetail = function(postId) {
                toggleFavorite(postId);
                showPostDetail(postId);
            };
            
            // 添加评论
            window.addComment = function(postId) {
                const input = document.getElementById('comment-input');
                const content = input.value.trim();
                
                if (!content) {
                    showNotification('请输入评论内容', 'error');
                    return;
                }
                
                const post = posts.find(p => p.id === postId);
                if (!post) return;
                
                const userProfile = userManager.getUserProfile();
                const comment = {
                    id: 'comment_' + Date.now(),
                    author: userProfile.username || '匿名用户',
                    avatar: userProfile.avatar || '👤',
                    content: content,
                    time: '刚刚'
                };
                
                post.comments.push(comment);
                localStorage.setItem('community_posts', JSON.stringify(posts));
                
                input.value = '';
                showPostDetail(postId);
                showNotification('评论成功！', 'success');
            };
            
            // 显示用户资料
            function showUserProfile(authorChatId) {
                const content = document.getElementById('user-profile-content');
                
                // 查找用户发布的所有帖子
                const userPosts = posts.filter(p => p.author.chatId === authorChatId);
                const author = userPosts.length > 0 ? userPosts[0].author : { name: '未知用户', avatar: '👤', chatId: authorChatId };
                
                content.innerHTML = `
                    <div style="text-align: center; margin-bottom: 2rem;">
                        <div style="width: 80px; height: 80px; border-radius: 50%; background: linear-gradient(135deg, #FF6B6B, #FF8E53); display: flex; align-items: center; justify-content: center; color: white; font-size: 2rem; margin: 0 auto 1rem; box-shadow: 0 5px 20px rgba(255, 107, 107, 0.3);">
                            ${author.avatar}
                        </div>
                        <h3 style="color: #2C3E50; margin-bottom: 0.5rem;">${author.name}</h3>
                        <div style="color: #999; font-size: 0.9rem; margin-bottom: 1rem;">交流号：${author.chatId}</div>
                        <div style="display: flex; gap: 1rem; justify-content: center; margin-bottom: 1.5rem;">
                            <button class="btn btn-primary" onclick="sendFriendRequest('${author.chatId}', '${author.name}')">
                                <i class="fas fa-user-plus"></i> 添加好友
                            </button>
                            ${userPosts.length > 0 ? `
                                <button class="btn btn-outline" onclick="requestJoinGroup('${author.chatId}', '${author.name}')">
                                    <i class="fas fa-users"></i> 申请加入兴趣小组
                                </button>
                            ` : ''}
                        </div>
                    </div>
                    <div style="border-top: 2px solid rgba(139, 154, 91, 0.2); padding-top: 1.5rem;">
                        <h4 style="color: #2C3E50; margin-bottom: 1rem;"><i class="fas fa-file-alt"></i> TA的动态 (${userPosts.length})</h4>
                        ${userPosts.length > 0 ? userPosts.map(post => `
                            <div style="padding: 1rem; background: rgba(139, 154, 91, 0.05); border-radius: 10px; margin-bottom: 1rem; cursor: pointer;" onclick="document.getElementById('user-profile-modal').classList.remove('active'); showPostDetail('${post.id}');">
                                <div style="font-weight: 600; color: #2C3E50; margin-bottom: 0.3rem;">${post.title}</div>
                                <div style="color: #666; font-size: 0.9rem; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">${post.content}</div>
                                <div style="color: #999; font-size: 0.85rem; margin-top: 0.5rem;">${post.time}</div>
                            </div>
                        `).join('') : '<div style="text-align: center; color: #999; padding: 2rem;">还没有发布动态</div>'}
                    </div>
                `;
                
                document.getElementById('user-profile-modal').classList.add('active');
            }
            
            // 发送好友申请
            window.sendFriendRequest = function(targetChatId, targetName) {
                // 检查是否已是好友
                if (friends.find(f => f.chatId === targetChatId)) {
                    showNotification('该用户已经是你的好友了', 'info');
                    return;
                }
                
                // 添加好友
                const newFriend = {
                    id: targetChatId,
                    name: targetName,
                    avatar: '👤',
                    status: '在线',
                    chatId: targetChatId
                };
                
                friends.push(newFriend);
                localStorage.setItem('friends', JSON.stringify(friends));
                loadFriendsList();
                
                showNotification('好友申请已发送！', 'success');
                document.getElementById('user-profile-modal').classList.remove('active');
            };
            
            // 申请加入兴趣小组
            window.requestJoinGroup = function(ownerChatId, ownerName) {
                showNotification(`已向 ${ownerName} 发送加入兴趣小组的申请`, 'success');
                document.getElementById('user-profile-modal').classList.remove('active');
            };
            
            // 发帖按钮
            document.getElementById('create-post-btn').addEventListener('click', function() {
                document.getElementById('create-post-modal').classList.add('active');
            });
            
            document.getElementById('close-create-post-modal').addEventListener('click', function() {
                document.getElementById('create-post-modal').classList.remove('active');
            });
            
            document.getElementById('close-post-detail-modal').addEventListener('click', function() {
                document.getElementById('post-detail-modal').classList.remove('active');
            });
            
            document.getElementById('close-user-profile-modal').addEventListener('click', function() {
                document.getElementById('user-profile-modal').classList.remove('active');
            });
            
            // 发布帖子
            document.getElementById('publish-post-btn').addEventListener('click', function() {
                const title = document.getElementById('post-title').value.trim();
                const content = document.getElementById('post-content').value.trim();
                const topic = document.getElementById('post-topic').value;
                
                if (!title || !content) {
                    showNotification('请填写标题和内容', 'error');
                    return;
                }
                
                const userProfile = userManager.getUserProfile();
                const newPost = {
                    id: 'post_' + Date.now(),
                    author: {
                        name: userProfile.username || '匿名用户',
                        avatar: userProfile.avatar || '👤',
                        chatId: chatId
                    },
                    title: title,
                    content: content,
                    topic: topic,
                    time: '刚刚',
                    likes: 0,
                    comments: [],
                    favorites: 0,
                    likedBy: [],
                    favoritedBy: []
                };
                
                posts.unshift(newPost);
                localStorage.setItem('community_posts', JSON.stringify(posts));
                
                document.getElementById('post-title').value = '';
                document.getElementById('post-content').value = '';
                document.getElementById('create-post-modal').classList.remove('active');
                
                loadPosts();
                showNotification('发布成功！', 'success');
            });
            
            // 兴趣小组功能
            // 初始化示例兴趣小组
            if (interestGroups.length === 0) {
                interestGroups = [
                    {
                        id: 'group_' + Date.now() + '_1',
                        name: '编程爱好者',
                        description: '一起学习编程，分享技术心得，共同进步！',
                        category: '科技编程',
                        owner: { name: '技术达人', avatar: '💻', chatId: 'XY100010' },
                        members: [{ name: '技术达人', avatar: '💻', chatId: 'XY100010' }],
                        createdTime: '3天前'
                    },
                    {
                        id: 'group_' + Date.now() + '_2',
                        name: '绘画交流',
                        description: '热爱绘画的小伙伴们，一起分享作品，交流技巧~',
                        category: '艺术创作',
                        owner: { name: '画画小能手', avatar: '🎨', chatId: 'XY100011' },
                        members: [{ name: '画画小能手', avatar: '🎨', chatId: 'XY100011' }],
                        createdTime: '5天前'
                    }
                ];
                localStorage.setItem('interest_groups', JSON.stringify(interestGroups));
            }
            
            // 加载兴趣小组列表
            function loadInterestGroups() {
                const container = document.getElementById('interest-groups-container');
                if (!container) return;
                
                if (interestGroups.length === 0) {
                    container.innerHTML = '<div style="text-align: center; padding: 3rem; color: #999;">还没有兴趣小组，快来创建第一个吧！</div>';
                    return;
                }
                
                container.innerHTML = interestGroups.map(group => `
                    <div class="post-card" style="cursor: default;">
                        <div class="post-card-header">
                            <div class="post-author-avatar" style="cursor: pointer;" onclick="showUserProfile('${group.owner.chatId}')">${group.owner.avatar}</div>
                            <div class="post-author-info">
                                <div class="post-author-name" style="cursor: pointer;" onclick="showUserProfile('${group.owner.chatId}')">${group.owner.name}</div>
                                <div class="post-time">${group.createdTime}</div>
                            </div>
                        </div>
                        <div class="post-card-body">
                            <div class="post-topic">${group.category}</div>
                            <div class="post-title">${group.name}</div>
                            <div class="post-content-preview">${group.description}</div>
                            <div style="margin-top: 1rem; color: #8B9A5B; font-size: 0.9rem;">
                                <i class="fas fa-users"></i> ${group.members.length} 位成员
                            </div>
                        </div>
                        <div class="post-card-footer">
                            ${group.members.some(m => m.chatId === chatId) ? 
                                '<button class="btn btn-primary" style="width: 100%;" disabled><i class="fas fa-check"></i> 已加入</button>' :
                                '<button class="btn btn-outline" style="width: 100%;" onclick="joinInterestGroup(\'' + group.id + '\')"><i class="fas fa-user-plus"></i> 申请加入</button>'
                            }
                        </div>
                    </div>
                `).join('');
            }
            
            // 加入兴趣小组
            window.joinInterestGroup = function(groupId) {
                const group = interestGroups.find(g => g.id === groupId);
                if (!group) return;
                
                // 检查是否已加入
                if (group.members.some(m => m.chatId === chatId)) {
                    showNotification('你已经是该小组成员了', 'info');
                    return;
                }
                
                // 添加成员
                const userProfile = userManager.getUserProfile();
                group.members.push({
                    name: userProfile.username || '匿名用户',
                    avatar: userProfile.avatar || '👤',
                    chatId: chatId
                });
                
                localStorage.setItem('interest_groups', JSON.stringify(interestGroups));
                loadInterestGroups();
                showNotification(`已成功加入 "${group.name}"！`, 'success');
            };
            
            // 创建兴趣小组按钮
            document.getElementById('create-group-btn-community').addEventListener('click', function() {
                document.getElementById('create-interest-group-modal').classList.add('active');
            });
            
            document.getElementById('close-create-group-modal').addEventListener('click', function() {
                document.getElementById('create-interest-group-modal').classList.remove('active');
            });
            
            // 创建兴趣小组
            document.getElementById('create-group-submit-btn').addEventListener('click', function() {
                const name = document.getElementById('group-name').value.trim();
                const description = document.getElementById('group-description').value.trim();
                const category = document.getElementById('group-category').value;
                
                if (!name || !description) {
                    showNotification('请填写小组名称和简介', 'error');
                    return;
                }
                
                const userProfile = userManager.getUserProfile();
                const newGroup = {
                    id: 'group_' + Date.now(),
                    name: name,
                    description: description,
                    category: category,
                    owner: {
                        name: userProfile.username || '匿名用户',
                        avatar: userProfile.avatar || '👤',
                        chatId: chatId
                    },
                    members: [{
                        name: userProfile.username || '匿名用户',
                        avatar: userProfile.avatar || '👤',
                        chatId: chatId
                    }],
                    createdTime: '刚刚'
                };
                
                interestGroups.unshift(newGroup);
                localStorage.setItem('interest_groups', JSON.stringify(interestGroups));
                
                document.getElementById('group-name').value = '';
                document.getElementById('group-description').value = '';
                document.getElementById('create-interest-group-modal').classList.remove('active');
                
                loadInterestGroups();
                showNotification('兴趣小组创建成功！', 'success');
            });
            
            // 修改申请加入小组功能，使其真正加入小组
            window.requestJoinGroup = function(ownerChatId, ownerName) {
                // 查找该用户创建的小组
                const group = interestGroups.find(g => g.owner.chatId === ownerChatId);
                if (group) {
                    joinInterestGroup(group.id);
                } else {
                    showNotification(`已向 ${ownerName} 发送加入兴趣小组的申请`, 'success');
                }
                document.getElementById('user-profile-modal').classList.remove('active');
            };
            
            // 初始化加载帖子和兴趣小组
            loadPosts();
            loadInterestGroups();

            // ============= 霍格沃茨分院测试系统 =============
            
            // 分院测试题目
            // 分院测试题目 - 经过深度优化，选项顺序随机化
            const sortingQuestions = [
                {
                    question: "深夜时分，你发现同学在考试中作弊。你会如何处理这个情况？",
                    options: [
                        { text: "虽然心里不认同，但选择保持沉默，毕竟没有直接伤害到我", house: "slytherin" },
                        { text: "私下找那位同学谈话，耐心了解原因并帮助他们走回正轨", house: "hufflepuff" },
                        { text: "立即向老师报告，因为作弊违反了公平原则，必须制止", house: "gryffindor" },
                        { text: "思考这种行为背后的深层原因，以及如何从制度上预防类似事件", house: "ravenclaw" }
                    ]
                },
                {
                    question: "如果你可以拥有一项超能力，你会选择哪一个？",
                    options: [
                        { text: "读心术，了解他人真实想法能帮我更好地达成目标", house: "slytherin" },
                        { text: "心灵感应，这样我能更好地理解和帮助身边的人", house: "hufflepuff" },
                        { text: "预知未来，可以提前规避危险，保护重要的人", house: "gryffindor" },
                        { text: "过目不忘，能够学习和掌握所有知识", house: "ravenclaw" }
                    ]
                },
                {
                    question: "你和朋友约好去看电影，但路上遇到一位迷路的老人需要帮助。此时电影马上开场，你会？",
                    options: [
                        { text: "评估情况，如果可以快速指路就帮忙，否则建议老人寻求其他帮助", house: "ravenclaw" },
                        { text: "毫不犹豫留下来帮助老人，朋友会理解的，电影可以改天再看", house: "hufflepuff" },
                        { text: "权衡利弊，如果帮忙不影响观影时间就帮，但朋友的约定也很重要", house: "slytherin" },
                        { text: "立即决定帮助老人，即使错过电影也在所不惜，这是应该做的事", house: "gryffindor" }
                    ]
                },
                {
                    question: "在一次重要的小组项目中，有个成员总是不贡献但想分享荣誉。作为组长，你会？",
                    options: [
                        { text: "与他单独沟通，了解是否有困难，并给予机会让他补上工作", house: "hufflepuff" },
                        { text: "据实向老师报告每个人的贡献，确保评分公正", house: "gryffindor" },
                        { text: "分析他不参与的原因，设计能激发他参与的任务分配方式", house: "ravenclaw" },
                        { text: "向他明确说明：只有实际贡献才能获得相应的成果", house: "slytherin" }
                    ]
                },
                {
                    question: "你最珍惜的是以下哪种时刻？",
                    options: [
                        { text: "独自思考时的顿悟瞬间，那种豁然开朗的感觉无与伦比", house: "ravenclaw" },
                        { text: "达成重要目标的那一刻，所有的努力都得到了回报", house: "slytherin" },
                        { text: "与好友分享快乐或分担忧愁的温馨时光", house: "hufflepuff" },
                        { text: "为了坚持自己的信念，勇敢说出真相的那一刻", house: "gryffindor" }
                    ]
                },
                {
                    question: "如果让你选择一本书来描述你的人生哲学，你会选？",
                    options: [
                        { text: "《如何赢得朋友与影响他人》- 成功需要智慧地经营人际关系", house: "slytherin" },
                        { text: "《活出生命的意义》- 即使在困境中也要找到生活的价值", house: "gryffindor" },
                        { text: "《给予者》- 真诚地帮助他人，收获的远比付出的多", house: "hufflepuff" },
                        { text: "《思考，快与慢》- 理解思维方式，做出更明智的决策", house: "ravenclaw" }
                    ]
                },
                {
                    question: "面对一个极具挑战但充满未知的机会，你的第一反应是？",
                    options: [
                        { text: "认真分析这个机会，收集足够信息后再决定", house: "ravenclaw" },
                        { text: "心里有些紧张，但还是决定试一试，不让自己后悔", house: "gryffindor" },
                        { text: "考虑这个机会是否符合我的长远规划和目标", house: "slytherin" },
                        { text: "想想是否能在这个过程中帮助到其他人，创造更大价值", house: "hufflepuff" }
                    ]
                },
                {
                    question: "在学校里，你最希望被认可的是什么？",
                    options: [
                        { text: "在关键时刻能够挺身而出，为正义发声", house: "gryffindor" },
                        { text: "有独特的见解和创新的想法", house: "ravenclaw" },
                        { text: "对朋友忠诚可靠，困难时总能依靠我", house: "hufflepuff" },
                        { text: "有明确的目标，并且总能高效地达成", house: "slytherin" }
                    ]
                },
                {
                    question: "假如你必须在以下四种情况中选择一种，你会选？",
                    options: [
                        { text: "为了揭露一个重大不公，可能要面对强大的压力和阻力", house: "gryffindor" },
                        { text: "放弃个人成就的机会，去帮助一个真正需要帮助的人", house: "hufflepuff" },
                        { text: "做出一个高难度但有重大意义的选择，可能改变很多人", house: "slytherin" },
                        { text: "解决一个复杂的问题，虽然过程艰辛但能学到很多", house: "ravenclaw" }
                    ]
                },
                {
                    question: "你认为真正的智慧体现在？",
                    options: [
                        { text: "知道何时该坚持，何时该妥协，达到最佳结果", house: "slytherin" },
                        { text: "能够深入理解事物本质，看透表象背后的规律", house: "ravenclaw" },
                        { text: "用善良和耐心化解矛盾，让每个人都感到被尊重", house: "hufflepuff" },
                        { text: "在道德困境中依然能坚守原则，不被利益动摇", house: "gryffindor" }
                    ]
                },
                {
                    question: "如果让你重新设计学校的规则体系，你最重视的是？",
                    options: [
                        { text: "确保规则能激发学生的创造力和独立思考能力", house: "ravenclaw" },
                        { text: "让规则能够保护弱者的利益，促进公平正义", house: "hufflepuff" },
                        { text: "建立清晰的责任体系，奖励优秀者，激励所有人进步", house: "slytherin" },
                        { text: "制定能够培养学生勇气和担当精神的规则", house: "gryffindor" }
                    ]
                },
                {
                    question: "在一个充满争议的校园事件中，你的立场是？",
                    options: [
                        { text: "收集各方信息，分析事件的前因后果，再做出判断", house: "ravenclaw" },
                        { text: "站在正义和公平的一方，即使面对压力也要坚持", house: "gryffindor" },
                        { text: "寻找能让所有人都有所得益的解决方案", house: "hufflepuff" },
                        { text: "评估各方的利益和立场，找到最有利的平衡点", house: "slytherin" }
                    ]
                },
                {
                    question: "当你的理想与现实发生冲突时，你会？",
                    options: [
                        { text: "坚持理想，即使要付出巨大代价也在所不惜", house: "gryffindor" },
                        { text: "分析现实限制，找到既保持理想又能适应现实的方法", house: "ravenclaw" },
                        { text: "调整理想，让它更贴近现实，同时不失去核心价值", house: "hufflepuff" },
                        { text: "暂时妥协，积累实力，等待更好的时机实现理想", house: "slytherin" }
                    ]
                },
                {
                    question: "你认为成功最重要的因素是什么？",
                    options: [
                        { text: "敏锐的洞察力和持续的学习能力", house: "ravenclaw" },
                        { text: "明确的目标和为实现目标不择手段的决心", house: "slytherin" },
                        { text: "真诚待人和团队合作的精神", house: "hufflepuff" },
                        { text: "面对困难不退缩的勇气和坚持到底的毅力", house: "gryffindor" }
                    ]
                },
                {
                    question: "在面临一个会影响很多人的重大决定时，你会？",
                    options: [
                        { text: "深入调研，收集数据，做出最理性的决策", house: "ravenclaw" },
                        { text: "考虑每个人的感受，尽量让所有人都满意", house: "hufflepuff" },
                        { text: "分析各种方案的利弊，选择最优策略", house: "slytherin" },
                        { text: "遵循内心的道德准则，即使可能得罪一些人", house: "gryffindor" }
                    ]
                },
                {
                    question: "你希望别人如何记住你？",
                    options: [
                        { text: "一个勇敢的人，在关键时刻能够挺身而出", house: "gryffindor" },
                        { text: "一个可靠的朋友，总是愿意帮助他人", house: "hufflepuff" },
                        { text: "一个聪明的人，总能提出独特的见解", house: "ravenclaw" },
                        { text: "一个有远见的人，能够成就大事", house: "slytherin" }
                    ]
                },
                {
                    question: "面对不公平的现象，你的第一反应是？",
                    options: [
                        { text: "立即采取行动，纠正这种不公", house: "gryffindor" },
                        { text: "思考这种现象的根源，寻找系统性解决方案", house: "ravenclaw" },
                        { text: "关注受伤害的人，尽力帮助他们", house: "hufflepuff" },
                        { text: "分析如何从中获得优势，同时避免自己受到伤害", house: "slytherin" }
                    ]
                },
                {
                    question: "你更愿意选择哪种学习方式？",
                    options: [
                        { text: "独立探索，深入研究自己感兴趣的领域", house: "ravenclaw" },
                        { text: "在挑战中学习，通过实践获得经验", house: "gryffindor" },
                        { text: "与伙伴一起学习，互相帮助共同进步", house: "hufflepuff" },
                        { text: "有明确目标和计划的学习，追求效率和结果", house: "slytherin" }
                    ]
                },
                {
                    question: "当你发现自己的价值观与身边的人不同时，你会？",
                    options: [
                        { text: "坚持自己的价值观，即使被孤立也在所不惜", house: "gryffindor" },
                        { text: "尊重他人的选择，同时保持自己的立场", house: "hufflepuff" },
                        { text: "分析不同价值观的优劣，找出最适合的融合方式", house: "ravenclaw" },
                        { text: "在保持核心价值的同时，灵活调整以适应环境", house: "slytherin" }
                    ]
                },
                {
                    question: "你认为改变世界最重要的能力是？",
                    options: [
                        { text: "强大的知识储备和创新能力", house: "ravenclaw" },
                        { text: "坚定的信念和敢于挑战权威的勇气", house: "gryffindor" },
                        { text: "能够团结他人，形成强大集体的能力", house: "hufflepuff" },
                        { text: "清晰的战略眼光和执行能力", house: "slytherin" }
                    ]
                },
                {
                    question: "在一个理想的社会中，你最希望看到什么？",
                    options: [
                        { text: "每个人都有追求真理和知识的自由", house: "ravenclaw" },
                        { text: "每个人都有公平的机会和公正的待遇", house: "hufflepuff" },
                        { text: "每个人都有实现自己抱负的舞台", house: "slytherin" },
                        { text: "每个人都有为正义发声的勇气", house: "gryffindor" }
                    ]
                }
            ];

            const houseInfo = {
                gryffindor: {
                    name: "格兰芬多",
                    icon: "🦁",
                    color: "#7D1F1F",
                    description: "格兰芬多学院重视勇气、胆量和骑士精神。你勇敢正直，敢于为正义挺身而出，是天生的领导者。"
                },
                hufflepuff: {
                    name: "赫奇帕奇",
                    icon: "🦡",
                    color: "#1F7D1F",
                    description: "赫奇帕奇学院重视勤奋、忠诚和公平竞争。你善良可靠，懂得坚持，是最值得信赖的伙伴。"
                },
                ravenclaw: {
                    name: "拉文克劳",
                    icon: "🦅",
                    color: "#1F1F7D",
                    description: "拉文克劳学院重视智慧、创造力和学习。你聪明好学，富有创造力，善于思考和解决问题。"
                },
                slytherin: {
                    name: "斯莱特林",
                    icon: "🐍",
                    color: "#1F7D4F",
                    description: "斯莱特林学院重视野心、领导力和机智。你目标明确，善于把握机会，是天生的战略家。"
                }
            };

            let currentQuestionIndex = 0;
            let userAnswers = [];

            // 显示分院测试
            function showSortingHat() {
                document.getElementById('sorting-modal').classList.add('active');
                currentQuestionIndex = 0;
                userAnswers = [];
                // 每次显示测试时，随机打乱题目顺序
                shuffledQuestions = shuffleArray([...sortingQuestions]);
                showSortingWelcome();
            }
            
            // 保存随机打乱后的题目
            let shuffledQuestions = [];

            // 显示欢迎界面
            function showSortingWelcome() {
                document.getElementById('sorting-welcome').style.display = 'block';
                document.getElementById('sorting-quiz').style.display = 'none';
                document.getElementById('sorting-result').style.display = 'none';
            }

            // 开始测试
            document.getElementById('sorting-start-btn').addEventListener('click', function() {
                document.getElementById('sorting-welcome').style.display = 'none';
                document.getElementById('sorting-quiz').style.display = 'block';
                currentQuestionIndex = 0;
                userAnswers = [];
                // 确保题目已随机打乱
                if (shuffledQuestions.length === 0) {
                    shuffledQuestions = shuffleArray([...sortingQuestions]);
                }
                showQuestion(0);
            });

            // 随机打乱数组的函数
            function shuffleArray(array) {
                const newArray = [...array];
                for (let i = newArray.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
                }
                return newArray;
            }

            // 显示问题
            function showQuestion(index) {
                // 确保使用随机打乱后的题目
                if (shuffledQuestions.length === 0) {
                    shuffledQuestions = shuffleArray([...sortingQuestions]);
                }
                
                if (index >= shuffledQuestions.length) {
                    showSortingResult();
                    return;
                }

                const question = shuffledQuestions[index];
                currentQuestionIndex = index;

                document.getElementById('question-title').textContent = question.question;
                
                const optionsContainer = document.getElementById('question-options');
                optionsContainer.innerHTML = '';

                // 随机打乱选项顺序，增加测试难度
                const shuffledOptions = shuffleArray(question.options);

                shuffledOptions.forEach((option, i) => {
                    const optionBtn = document.createElement('button');
                    optionBtn.className = 'option-btn';
                    optionBtn.innerHTML = `
                        <span class="option-number">${String.fromCharCode(65 + i)}</span>
                        <span>${option.text}</span>
                    `;
                    optionBtn.onclick = () => selectOption(option.house, optionBtn);
                    optionsContainer.appendChild(optionBtn);
                });

                // 更新进度
                const progress = ((index + 1) / shuffledQuestions.length) * 100;
                document.getElementById('sorting-progress').style.width = progress + '%';
                document.getElementById('sorting-progress-text').textContent = `问题 ${index + 1}/${shuffledQuestions.length}`;

                // 更新导航按钮
                document.getElementById('sorting-prev-btn').style.display = index > 0 ? 'inline-block' : 'none';
            }

            // 选择选项
            function selectOption(house, button) {
                // 移除其他选项的选中状态
                document.querySelectorAll('.option-btn').forEach(btn => {
                    btn.classList.remove('selected');
                });
                
                // 标记当前选项
                button.classList.add('selected');
                
                // 记录答案
                userAnswers[currentQuestionIndex] = house;
                
                // 延迟后自动进入下一题
                setTimeout(() => {
                    showQuestion(currentQuestionIndex + 1);
                }, 500);
            }

            // 上一题
            document.getElementById('sorting-prev-btn').addEventListener('click', function() {
                if (currentQuestionIndex > 0) {
                    showQuestion(currentQuestionIndex - 1);
                }
            });

            // 显示结果
            function showSortingResult() {
                // 统计各学院得分
                const scores = {
                    gryffindor: 0,
                    hufflepuff: 0,
                    ravenclaw: 0,
                    slytherin: 0
                };

                userAnswers.forEach(house => {
                    scores[house]++;
                });

                // 找出最高分
                let maxScore = 0;
                let selectedHouse = 'gryffindor';
                for (const house in scores) {
                    if (scores[house] > maxScore) {
                        maxScore = scores[house];
                        selectedHouse = house;
                    }
                }

                // 如果有平局，随机选择
                const tiedHouses = Object.keys(scores).filter(h => scores[h] === maxScore);
                if (tiedHouses.length > 1) {
                    selectedHouse = tiedHouses[Math.floor(Math.random() * tiedHouses.length)];
                }

                const house = houseInfo[selectedHouse];

                // 显示结果
                document.getElementById('sorting-quiz').style.display = 'none';
                document.getElementById('sorting-result').style.display = 'block';

                document.getElementById('result-house').innerHTML = `
                    <div class="house-badge-large">${house.icon}</div>
                    <div class="house-name" style="color: ${house.color}">${house.name}</div>
                `;
                document.getElementById('result-house').style.background = `linear-gradient(135deg, ${house.color}99, ${house.color}66)`;
                document.getElementById('result-description').textContent = house.description;

                // 保存用户学院
                userManager.currentUser.house = selectedHouse;
                localStorage.setItem('heartland_user', JSON.stringify(userManager.currentUser));
                userManager.updateUI();
            }

            // 完成分院
            document.getElementById('sorting-complete-btn').addEventListener('click', function() {
                document.getElementById('sorting-modal').classList.remove('active');
                showNotification('欢迎加入你的学院！✨', 'success');
            });

            // ============= 匿名树洞系统 =============
            
            // 树洞数据
            let treeHolePosts = JSON.parse(localStorage.getItem('tree_hole_posts')) || [
                {
                    id: 1,
                    category: "学业压力",
                    content: "最近学习压力好大，感觉自己怎么努力都追不上别人的进度...",
                    time: "2小时前",
                    likes: 5,
                    comments: 3,
                    likedByMe: false
                },
                {
                    id: 2,
                    category: "人际关系",
                    content: "今天终于鼓起勇气和朋友说出了心里话，感觉轻松多了。",
                    time: "5小时前",
                    likes: 12,
                    comments: 7,
                    likedByMe: false
                }
            ];

            // 打开匿名树洞
            document.getElementById('anonymous-tree-btn').addEventListener('click', function() {
                document.getElementById('tree-hole-modal').classList.add('active');
                loadTreeHolePosts();
            });

            // 关闭树洞
            document.getElementById('close-tree-hole-modal').addEventListener('click', function() {
                document.getElementById('tree-hole-modal').classList.remove('active');
            });

            // 树洞标签切换
            document.querySelectorAll('.tree-hole-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.tree-hole-tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    document.querySelectorAll('.tree-hole-tab-content').forEach(c => c.classList.remove('active'));
                    document.getElementById('tree-hole-' + this.getAttribute('data-tab')).classList.add('active');
                    
                    if (this.getAttribute('data-tab') === 'view') {
                        loadTreeHolePosts();
                    }
                });
            });

            // 字数统计
            document.getElementById('tree-hole-content').addEventListener('input', function() {
                document.getElementById('tree-hole-char-count').textContent = this.value.length;
            });

            // 提交树洞
            document.getElementById('submit-tree-hole').addEventListener('click', function() {
                const category = document.getElementById('tree-hole-category').value;
                const content = document.getElementById('tree-hole-content').value.trim();
                
                if (!content) {
                    showNotification('请写下你的心里话', 'error');
                    return;
                }
                
                const newPost = {
                    id: Date.now(),
                    category: category || "未分类",
                    content: content,
                    time: "刚刚",
                    likes: 0,
                    comments: 0,
                    likedByMe: false
                };
                
                treeHolePosts.unshift(newPost);
                localStorage.setItem('tree_hole_posts', JSON.stringify(treeHolePosts));
                
                document.getElementById('tree-hole-content').value = '';
                document.getElementById('tree-hole-category').value = '';
                document.getElementById('tree-hole-char-count').textContent = '0';
                
                showNotification('已匿名发送到树洞 🌳', 'success');
                
                // 切换到查看界面
                document.querySelector('.tree-hole-tab[data-tab="view"]').click();
            });

            // 加载树洞内容
            function loadTreeHolePosts() {
                const filter = document.getElementById('tree-hole-filter').value;
                const container = document.getElementById('tree-hole-posts');
                
                let filteredPosts = treeHolePosts;
                if (filter !== 'all') {
                    filteredPosts = treeHolePosts.filter(p => p.category === filter);
                }
                
                if (filteredPosts.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #999; padding: 2rem;">暂无内容</p>';
                    return;
                }
                
                container.innerHTML = filteredPosts.map(post => `
                    <div class="tree-hole-post-item">
                        <div class="tree-hole-post-header">
                            <span class="tree-hole-post-category">${post.category}</span>
                            <span class="tree-hole-post-time">${post.time}</span>
                        </div>
                        <div class="tree-hole-post-content">${post.content}</div>
                        <div class="tree-hole-post-actions">
                            <button class="tree-hole-action-btn ${post.likedByMe ? 'active' : ''}" onclick="likeTreeHolePost(${post.id})">
                                <i class="fas fa-heart"></i>
                                <span>${post.likes}</span>
                            </button>
                            <button class="tree-hole-action-btn">
                                <i class="fas fa-comment"></i>
                                <span>鼓励</span>
                            </button>
                        </div>
                    </div>
                `).join('');
            }

            // 点赞树洞
            window.likeTreeHolePost = function(postId) {
                const post = treeHolePosts.find(p => p.id === postId);
                if (post) {
                    if (post.likedByMe) {
                        post.likes--;
                        post.likedByMe = false;
                    } else {
                        post.likes++;
                        post.likedByMe = true;
                    }
                    localStorage.setItem('tree_hole_posts', JSON.stringify(treeHolePosts));
                    loadTreeHolePosts();
                }
            };

            // 筛选变化
            document.getElementById('tree-hole-filter').addEventListener('change', loadTreeHolePosts);

            // ============= 同伴支持系统 =============
            
            // 同伴数据
            let peerProfiles = JSON.parse(localStorage.getItem('peer_profiles')) || [
                {
                    id: 1,
                    avatar: "🌟",
                    name: "星光同行者",
                    concerns: ["学业压力", "焦虑情绪"],
                    about: "高三学生，正在努力克服考前焦虑，希望找到同路人一起加油。",
                    matchScore: 0
                },
                {
                    id: 2,
                    avatar: "🌈",
                    name: "彩虹守护者",
                    concerns: ["人际关系", "自我认知"],
                    about: "喜欢帮助他人，也在学习如何更好地认识自己。",
                    matchScore: 0
                }
            ];

            let myPeers = JSON.parse(localStorage.getItem('my_peers')) || [];

            // 打开同伴支持
            document.getElementById('peer-support-btn').addEventListener('click', function() {
                document.getElementById('peer-support-modal').classList.add('active');
                loadMyPeers();
            });

            // 关闭同伴支持
            document.getElementById('close-peer-support-modal').addEventListener('click', function() {
                document.getElementById('peer-support-modal').classList.remove('active');
            });

            // ============ 图书馆功能 ============
            
            // 图书馆数据
            const libraryBooks = [
                {
                    id: 1,
                    title: '情绪急救',
                    author: '盖伊·温奇',
                    category: 'emotion',
                    price: 0,
                    isFree: true,
                    icon: '📘',
                    description: '这本书教你如何处理日常生活中的心理创伤，就像我们处理身体创伤一样。作者提供了实用的策略来应对拒绝、失败、孤独等常见的情绪问题。',
                    reason: '这本书就像是心理健康的"急救箱"，当你感到情绪低落或受伤时，它能给你立即的帮助和指导。作者用通俗易懂的语言，让你明白情绪问题并不可怕，关键是要学会正确的应对方法。',
                    pages: 280,
                    rating: 4.8,
                    downloads: 1523
                },
                {
                    id: 2,
                    title: '自卑与超越',
                    author: '阿尔弗雷德·阿德勒',
                    category: 'growth',
                    price: 50,
                    isFree: false,
                    icon: '📗',
                    description: '心理学大师阿德勒的经典之作，探讨了自卑感的起源以及如何将其转化为成长的动力。书中提出的"超越自卑"理念影响了无数人。',
                    reason: '每个人都会有自卑的时刻，但这本书告诉你，自卑并不是坏事，它可以成为你前进的动力。阿德勒用温和而有力的语言，帮助你重新认识自己，找到属于自己的人生意义。',
                    pages: 320,
                    rating: 4.9,
                    downloads: 2341
                },
                {
                    id: 3,
                    title: '非暴力沟通',
                    author: '马歇尔·卢森堡',
                    category: 'relationship',
                    price: 0,
                    isFree: true,
                    icon: '📙',
                    description: '这本书教你如何用更有效、更有爱的方式与他人沟通。通过观察、感受、需要和请求四个步骤，建立更和谐的人际关系。',
                    reason: '沟通是人际关系的基础，但很多时候我们的沟通方式会无意中伤害他人。这本书教你如何表达自己的真实感受，同时也理解他人的需求，让你的人际关系更加和谐美好。',
                    pages: 256,
                    rating: 4.7,
                    downloads: 1876
                },
                {
                    id: 4,
                    title: '学习之道',
                    author: '乔希·维茨金',
                    category: 'learning',
                    price: 30,
                    isFree: false,
                    icon: '📕',
                    description: '国际象棋大师和太极拳冠军分享他的学习心得，揭示了如何在任何领域达到卓越的秘密。',
                    reason: '学习不是死记硬背，而是一种艺术。这本书会改变你对学习的看法，让你明白真正的学习是如何发生的。作者的亲身经历让这些道理变得生动而有说服力。',
                    pages: 288,
                    rating: 4.6,
                    downloads: 1234
                },
                {
                    id: 5,
                    title: '蛤蟆先生去看心理医生',
                    author: '罗伯特·戴博德',
                    category: 'emotion',
                    price: 0,
                    isFree: true,
                    icon: '📘',
                    description: '通过蛤蟆先生的心理咨询过程，用故事的形式深入浅出地介绍了心理咨询的过程和自我成长的道路。',
                    reason: '这是一本特别温暖的书，用童话般的故事讲述了深刻的心理学道理。跟随蛤蟆先生的成长之旅，你会发现自己内心的答案。这本书让心理咨询变得不再神秘，而是充满希望和力量。',
                    pages: 192,
                    rating: 4.9,
                    downloads: 3456
                },
                {
                    id: 6,
                    title: '心流',
                    author: '米哈里·契克森米哈赖',
                    category: 'growth',
                    price: 40,
                    isFree: false,
                    icon: '📗',
                    description: '探讨了"心流"这种最优体验状态，以及如何在日常生活中创造更多的心流体验，从而获得真正的幸福。',
                    reason: '你有没有过那种完全沉浸在某件事中，忘记时间流逝的体验？这就是"心流"。这本书教你如何主动创造这种美妙的状态，让学习和生活都变得更加充实和有意义。',
                    pages: 368,
                    rating: 4.8,
                    downloads: 1987
                },
                {
                    id: 7,
                    title: '亲密关系',
                    author: '罗兰·米勒',
                    category: 'relationship',
                    price: 60,
                    isFree: false,
                    icon: '📙',
                    description: '全面而深入地探讨了人际关系的方方面面，从友谊到爱情，从沟通到冲突解决，是一本关系心理学的经典教材。',
                    reason: '人际关系是我们生活中最重要的部分，但也是最复杂的。这本书用科学的方法帮你理解关系的本质，让你在与他人相处时更加自信和从容。',
                    pages: 512,
                    rating: 4.7,
                    downloads: 1654
                },
                {
                    id: 8,
                    title: '高效能人士的七个习惯',
                    author: '史蒂芬·柯维',
                    category: 'learning',
                    price: 0,
                    isFree: true,
                    icon: '📕',
                    description: '全球畅销的个人成长经典，提出了七个能够改变人生的习惯，帮助读者实现个人和职业上的成功。',
                    reason: '这本书不是教你快速成功的技巧，而是帮你建立真正有效的人生习惯。这些习惯会陪伴你一生，让你在面对任何挑战时都能从容应对。',
                    pages: 384,
                    rating: 4.8,
                    downloads: 2789
                },
                {
                    id: 9,
                    title: '正念的奇迹',
                    author: '一行禅师',
                    category: 'emotion',
                    price: 20,
                    isFree: false,
                    icon: '📘',
                    description: '禅宗大师一行禅师教你如何在日常生活中练习正念，通过简单的呼吸和觉察，找到内心的平静和喜悦。',
                    reason: '在这个快节奏的时代，我们常常忘记活在当下。这本书用最简单的方法，教你如何重新与自己连接，在平凡的生活中发现不平凡的美好。',
                    pages: 224,
                    rating: 4.9,
                    downloads: 2134
                },
                {
                    id: 10,
                    title: '终身成长',
                    author: '卡罗尔·德韦克',
                    category: 'growth',
                    price: 0,
                    isFree: true,
                    icon: '📗',
                    description: '斯坦福大学心理学教授提出的"成长型思维"理论，告诉我们能力是可以通过努力培养的，而不是固定不变的。',
                    reason: '这本书会彻底改变你对自己能力的看法。当你相信自己可以成长和改变时，你就已经踏上了成功的道路。这种思维方式会让你在面对困难时更有韧性，在追求目标时更有动力。',
                    pages: 296,
                    rating: 4.8,
                    downloads: 2567
                },
                {
                    id: 11,
                    title: '社交天性',
                    author: '马修·利伯曼',
                    category: 'relationship',
                    price: 45,
                    isFree: false,
                    icon: '📙',
                    description: '从神经科学的角度解释了人类为什么需要社交，以及社交如何影响我们的大脑和行为。',
                    reason: '你知道吗？我们的大脑天生就是为社交而设计的。这本书用最新的科学研究告诉你，社交不仅是一种需要，更是我们大脑的基本功能。理解这一点，会让你更好地理解自己和他人。',
                    pages: 352,
                    rating: 4.6,
                    downloads: 1432
                },
                {
                    id: 12,
                    title: '刻意练习',
                    author: '安德斯·艾利克森',
                    category: 'learning',
                    price: 35,
                    isFree: false,
                    icon: '📕',
                    description: '揭示了从新手到大师的成长秘密，告诉我们天才是如何炼成的，以及如何通过正确的练习方法提升任何技能。',
                    reason: '天才不是天生的，而是练出来的。但不是所有的练习都有效，这本书教你如何进行真正有效的"刻意练习"，让你的努力不再白费，每一次练习都能带来实实在在的进步。',
                    pages: 328,
                    rating: 4.7,
                    downloads: 1876
                }
            ];

            // 推荐图书（用于轮播海报）
            const featuredBooks = [
                libraryBooks[4], // 蛤蟆先生去看心理医生
                libraryBooks[1], // 自卑与超越
                libraryBooks[5], // 心流
                libraryBooks[9]  // 终身成长
            ];

            let currentBannerIndex = 0;
            let bannerInterval = null;

            // 打开图书馆
            document.getElementById('library-btn').addEventListener('click', function() {
                document.getElementById('library-modal').classList.add('active');
                initLibrary();
            });

            // 关闭图书馆
            document.getElementById('close-library-modal').addEventListener('click', function() {
                document.getElementById('library-modal').classList.remove('active');
                stopBannerAutoPlay();
            });
            
            // 点击背景关闭图书馆
            document.getElementById('library-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    this.classList.remove('active');
                    stopBannerAutoPlay();
                }
            });
            
            // 点击背景关闭图书详情
            document.getElementById('book-detail-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    this.classList.remove('active');
                }
            });

            // 初始化图书馆
            function initLibrary() {
                renderBanner();
                renderBooks('all');
                startBannerAutoPlay();
            }

            // 渲染轮播海报
            function renderBanner() {
                const slider = document.getElementById('library-banner-slider');
                const dots = document.getElementById('banner-dots');
                
                slider.innerHTML = featuredBooks.map((book, index) => `
                    <div class="library-banner-item" data-book-id="${book.id}" style="background: linear-gradient(135deg, ${getBannerGradient(index)});">
                        <div class="library-banner-image">${book.icon}</div>
                        <div class="library-banner-content">
                            <div class="library-banner-title">${book.title}</div>
                            <div class="library-banner-author">作者：${book.author}</div>
                            <div class="library-banner-description">${book.description}</div>
                            <div class="library-banner-reason">
                                <strong>💡 推荐理由：</strong>${book.reason}
                            </div>
                        </div>
                    </div>
                `).join('');
                
                dots.innerHTML = featuredBooks.map((_, index) => 
                    `<div class="library-banner-dot ${index === 0 ? 'active' : ''}" data-index="${index}"></div>`
                ).join('');
                
                // 添加海报点击事件
                slider.querySelectorAll('.library-banner-item').forEach(item => {
                    item.addEventListener('click', function() {
                        const bookId = parseInt(this.getAttribute('data-book-id'));
                        showBookDetail(bookId);
                    });
                });
                
                // 添加指示点点击事件
                dots.querySelectorAll('.library-banner-dot').forEach(dot => {
                    dot.addEventListener('click', function() {
                        const index = parseInt(this.getAttribute('data-index'));
                        goToBanner(index);
                    });
                });
            }

            // 获取海报渐变色
            function getBannerGradient(index) {
                const gradients = [
                    '#667eea 0%, #764ba2 100%',
                    '#f093fb 0%, #f5576c 100%',
                    '#4facfe 0%, #00f2fe 100%',
                    '#43e97b 0%, #38f9d7 100%'
                ];
                return gradients[index % gradients.length];
            }

            // 轮播控制
            function goToBanner(index) {
                currentBannerIndex = index;
                const slider = document.getElementById('library-banner-slider');
                slider.style.transform = `translateX(-${index * 100}%)`;
                
                document.querySelectorAll('.library-banner-dot').forEach((dot, i) => {
                    dot.classList.toggle('active', i === index);
                });
            }

            function nextBanner() {
                currentBannerIndex = (currentBannerIndex + 1) % featuredBooks.length;
                goToBanner(currentBannerIndex);
            }

            function prevBanner() {
                currentBannerIndex = (currentBannerIndex - 1 + featuredBooks.length) % featuredBooks.length;
                goToBanner(currentBannerIndex);
            }

            function startBannerAutoPlay() {
                stopBannerAutoPlay();
                bannerInterval = setInterval(nextBanner, 5000);
            }

            function stopBannerAutoPlay() {
                if (bannerInterval) {
                    clearInterval(bannerInterval);
                    bannerInterval = null;
                }
            }

            // 海报按钮事件
            document.getElementById('banner-prev').addEventListener('click', function() {
                prevBanner();
                startBannerAutoPlay(); // 重置自动播放
            });

            document.getElementById('banner-next').addEventListener('click', function() {
                nextBanner();
                startBannerAutoPlay(); // 重置自动播放
            });

            // 分类标签切换
            document.querySelectorAll('.library-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.library-tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    const category = this.getAttribute('data-category');
                    renderBooks(category);
                });
            });

            // 渲染图书列表
            function renderBooks(category) {
                const grid = document.getElementById('library-books-grid');
                const filteredBooks = category === 'all' 
                    ? libraryBooks 
                    : libraryBooks.filter(book => book.category === category);
                
                grid.innerHTML = filteredBooks.map(book => `
                    <div class="library-book-card" data-book-id="${book.id}">
                        <div class="library-book-cover">${book.icon}</div>
                        <div class="library-book-title">${book.title}</div>
                        <div class="library-book-author">${book.author}</div>
                        <div class="library-book-price ${book.isFree ? 'free' : 'points'}">
                            <i class="fas fa-${book.isFree ? 'gift' : 'coins'}"></i>
                            <span>${book.isFree ? '免费' : book.price + ' 积分'}</span>
                        </div>
                    </div>
                `).join('');
                
                // 添加图书卡片点击事件
                grid.querySelectorAll('.library-book-card').forEach(card => {
                    card.addEventListener('click', function() {
                        const bookId = parseInt(this.getAttribute('data-book-id'));
                        showBookDetail(bookId);
                    });
                });
            }

            // 显示图书详情
            function showBookDetail(bookId) {
                const book = libraryBooks.find(b => b.id === bookId);
                if (!book) return;
                
                const content = document.getElementById('book-detail-content');
                content.innerHTML = `
                    <div class="book-detail-header">
                        <div class="book-detail-cover">${book.icon}</div>
                        <div class="book-detail-info">
                            <div class="book-detail-title">${book.title}</div>
                            <div class="book-detail-author">作者：${book.author}</div>
                            <div class="book-detail-meta">
                                <div class="book-detail-meta-item">
                                    <i class="fas fa-file-alt"></i>
                                    <span>${book.pages} 页</span>
                                </div>
                                <div class="book-detail-meta-item">
                                    <i class="fas fa-star"></i>
                                    <span>${book.rating} 分</span>
                                </div>
                                <div class="book-detail-meta-item">
                                    <i class="fas fa-download"></i>
                                    <span>${book.downloads} 次下载</span>
                                </div>
                                <div class="book-detail-meta-item">
                                    <i class="fas fa-${book.isFree ? 'gift' : 'coins'}"></i>
                                    <span>${book.isFree ? '免费' : book.price + ' 积分'}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="book-detail-section">
                        <h3><i class="fas fa-book-open"></i> 内容简介</h3>
                        <div class="book-detail-description">${book.description}</div>
                    </div>
                    
                    <div class="book-detail-section">
                        <h3><i class="fas fa-heart"></i> 推荐理由</h3>
                        <div class="book-detail-reason">${book.reason}</div>
                    </div>
                    
                    <div class="book-detail-actions">
                        <button class="btn btn-primary" onclick="downloadBook(${book.id})">
                            <i class="fas fa-download"></i> ${book.isFree ? '免费下载' : '兑换下载 (' + book.price + ' 积分)'}
                        </button>
                        <button class="btn btn-outline" onclick="addToFavorites(${book.id})">
                            <i class="fas fa-heart"></i> 收藏
                        </button>
                    </div>
                `;
                
                document.getElementById('book-detail-modal').classList.add('active');
            }

            // 关闭图书详情
            document.getElementById('close-book-detail').addEventListener('click', function() {
                document.getElementById('book-detail-modal').classList.remove('active');
            });

            // 下载图书
            window.downloadBook = function(bookId) {
                const book = libraryBooks.find(b => b.id === bookId);
                if (!book) return;
                
                if (book.isFree) {
                    showNotification('《' + book.title + '》下载成功！', 'success');
                    book.downloads++;
                } else {
                    const currentPoints = parseInt(document.getElementById('user-points').textContent);
                    if (currentPoints >= book.price) {
                        document.getElementById('user-points').textContent = currentPoints - book.price;
                        showNotification('《' + book.title + '》下载成功！已扣除 ' + book.price + ' 积分', 'success');
                        book.downloads++;
                    } else {
                        showNotification('积分不足！还需要 ' + (book.price - currentPoints) + ' 积分', 'error');
                    }
                }
            };

            // 收藏图书
            window.addToFavorites = function(bookId) {
                const book = libraryBooks.find(b => b.id === bookId);
                if (!book) return;
                showNotification('《' + book.title + '》已加入收藏夹', 'success');
            };

            // ============ 图书馆功能结束 ============

            // 同伴支持标签切换
            document.querySelectorAll('.peer-support-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.peer-support-tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    document.querySelectorAll('.peer-support-tab-content').forEach(c => c.classList.remove('active'));
                    document.getElementById('peer-' + this.getAttribute('data-tab')).classList.add('active');
                    
                    if (this.getAttribute('data-tab') === 'my-peers') {
                        loadMyPeers();
                    }
                });
            });

            // 字数统计
            document.getElementById('peer-about').addEventListener('input', function() {
                document.getElementById('peer-about-char-count').textContent = this.value.length;
            });

            // 开始匹配
            document.getElementById('find-peer-match').addEventListener('click', function() {
                const concernSelect = document.getElementById('peer-concern');
                const selectedConcerns = Array.from(concernSelect.selectedOptions).map(opt => opt.value);
                
                if (selectedConcerns.length === 0) {
                    showNotification('请至少选择一个关心的话题', 'error');
                    return;
                }
                
                // 计算匹配度
                peerProfiles.forEach(peer => {
                    const commonConcerns = peer.concerns.filter(c => selectedConcerns.includes(c));
                    peer.matchScore = Math.round((commonConcerns.length / Math.max(peer.concerns.length, selectedConcerns.length)) * 100);
                });
                
                // 按匹配度排序
                peerProfiles.sort((a, b) => b.matchScore - a.matchScore);
                
                // 显示匹配结果
                document.querySelector('.peer-match-form').style.display = 'none';
                document.getElementById('peer-match-results').style.display = 'block';
                
                const matchesList = document.getElementById('peer-matches-list');
                const topMatches = peerProfiles.filter(p => p.matchScore > 30).slice(0, 5);
                
                if (topMatches.length === 0) {
                    matchesList.innerHTML = '<p style="text-align: center; color: #999; padding: 2rem;">暂时没有找到合适的同伴，请稍后再试</p>';
                    return;
                }
                
                matchesList.innerHTML = topMatches.map(peer => `
                    <div class="peer-card">
                        <div class="peer-card-header">
                            <div class="peer-avatar">${peer.avatar}</div>
                            <div class="peer-info">
                                <div class="peer-name">${peer.name}</div>
                                <div class="peer-match-score">
                                    <i class="fas fa-star"></i>
                                    匹配度：${peer.matchScore}%
                                </div>
                            </div>
                        </div>
                        <div class="peer-concerns">
                            ${peer.concerns.map(c => `<span class="peer-concern-tag">${c}</span>`).join('')}
                        </div>
                        <div class="peer-about">${peer.about}</div>
                        <div class="peer-actions">
                            <button class="btn btn-primary" onclick="connectPeer(${peer.id})" style="flex: 1;">
                                <i class="fas fa-user-plus"></i> 建立连接
                            </button>
                        </div>
                    </div>
                `).join('');
            });

            // 建立连接
            window.connectPeer = function(peerId) {
                const peer = peerProfiles.find(p => p.id === peerId);
                if (peer && !myPeers.find(p => p.id === peerId)) {
                    myPeers.push(peer);
                    localStorage.setItem('my_peers', JSON.stringify(myPeers));
                    showNotification(`已与 ${peer.name} 建立连接 💫`, 'success');
                    
                    // 切换到我的同伴界面
                    document.querySelector('.peer-support-tab[data-tab="my-peers"]').click();
                }
            };

            // 加载我的同伴
            function loadMyPeers() {
                const container = document.getElementById('my-peers-list');
                
                if (myPeers.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 3rem; color: #999;">
                            <i class="fas fa-user-friends" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.3;"></i>
                            <p>还没有建立连接的同伴</p>
                            <p style="font-size: 0.9rem; margin-top: 0.5rem;">去"寻找同伴"中发现志同道合的伙伴吧</p>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = myPeers.map(peer => `
                    <div class="peer-card">
                        <div class="peer-card-header">
                            <div class="peer-avatar">${peer.avatar}</div>
                            <div class="peer-info">
                                <div class="peer-name">${peer.name}</div>
                            </div>
                        </div>
                        <div class="peer-concerns">
                            ${peer.concerns.map(c => `<span class="peer-concern-tag">${c}</span>`).join('')}
                        </div>
                        <div class="peer-about">${peer.about}</div>
                        <div class="peer-actions">
                            <button class="btn btn-primary" style="flex: 1;">
                                <i class="fas fa-comments"></i> 发送消息
                            </button>
                            <button class="btn btn-outline" onclick="removePeer(${peer.id})">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                `).join('');
            }

            // 移除同伴
            window.removePeer = function(peerId) {
                if (confirm('确定要断开与这位同伴的连接吗？')) {
                    myPeers = myPeers.filter(p => p.id !== peerId);
                    localStorage.setItem('my_peers', JSON.stringify(myPeers));
                    loadMyPeers();
                    showNotification('已断开连接', 'info');
                }
            };

            // ============= 角色切换系统 =============
            
            let currentRole = localStorage.getItem('current_role') || 'student';
            
            // 角色图标和名称映射
            const roleConfig = {
                student: {
                    icon: 'fas fa-user-graduate',
                    name: '学生端',
                    dashboard: 'dashboard'
                },
                parent: {
                    icon: 'fas fa-user-friends',
                    name: '家长端',
                    dashboard: 'parent-dashboard'
                },
                teacher: {
                    icon: 'fas fa-chalkboard-teacher',
                    name: '教师端',
                    dashboard: 'teacher-dashboard'
                },
                admin: {
                    icon: 'fas fa-user-shield',
                    name: '管理员',
                    dashboard: 'admin-dashboard'
                }
            };

            // 切换角色按钮点击
            document.getElementById('current-role-btn').addEventListener('click', function(e) {
                e.stopPropagation();
                document.getElementById('role-dropdown').classList.toggle('active');
            });

            // 点击页面其他地方关闭下拉菜单
            document.addEventListener('click', function() {
                document.getElementById('role-dropdown').classList.remove('active');
            });

            // 选择角色
            document.querySelectorAll('.role-option').forEach(option => {
                option.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const role = this.getAttribute('data-role');
                    switchRole(role);
                });
            });

            // 切换角色函数
            // 角色权限验证 - 检查用户是否真的拥有该角色
            function hasRole(role) {
                if (!userManager.currentUser) return false;
                
                // 检查主角色
                if (userManager.currentUser.role === role) return true;
                
                // 检查多角色列表
                if (userManager.currentUser.roles && userManager.currentUser.roles.includes(role)) {
                    return true;
                }
                
                return false;
            }
            
            // 获取用户所有可用角色
            function getUserAvailableRoles() {
                if (!userManager.currentUser) return ['student'];
                
                const roles = [userManager.currentUser.role];
                if (userManager.currentUser.roles) {
                    userManager.currentUser.roles.forEach(r => {
                        if (!roles.includes(r)) roles.push(r);
                    });
                }
                return roles;
            }

            function switchRole(role) {
                // 权限验证：检查用户是否真的拥有该角色
                if (!hasRole(role)) {
                    showNotification('您没有此角色的访问权限', 'error');
                    return;
                }
                
                currentRole = role;
                localStorage.setItem('current_role', role);
                
                const config = roleConfig[role];
                
                // 更新角色按钮显示
                document.getElementById('current-role-text').textContent = config.name;
                const icon = document.querySelector('#current-role-btn i:first-child');
                icon.className = config.icon;
                
                // 更新角色选项的激活状态
                document.querySelectorAll('.role-option').forEach(opt => {
                    opt.classList.remove('active');
                });
                document.querySelector(`.role-option[data-role="${role}"]`).classList.add('active');
                
                // 隐藏所有页面
                document.querySelectorAll('.page-container').forEach(page => {
                    page.style.display = 'none';
                    page.classList.remove('active');
                });
                
                // 显示对应的仪表板
                const dashboard = document.getElementById(config.dashboard);
                if (dashboard) {
                    dashboard.style.display = 'block';
                    dashboard.classList.add('active');
                }
                
                // 关闭下拉菜单
                document.getElementById('role-dropdown').classList.remove('active');
                
                // 根据角色加载相应数据
                loadRoleDashboard(role);
                
                showNotification(`已切换到${config.name}`, 'success');
            }

            // 加载角色仪表板数据
            function loadRoleDashboard(role) {
                switch(role) {
                    case 'teacher':
                        loadTeacherClasses();
                        loadStudentActivities();
                        break;
                    case 'admin':
                        // 管理员数据已在HTML中静态显示
                        break;
                }
            }

            // 初始化当前角色
            function initializeRole() {
                // 获取用户可用角色
                const availableRoles = getUserAvailableRoles();
                
                // 验证当前角色是否可用
                if (!availableRoles.includes(currentRole)) {
                    currentRole = availableRoles[0];
                    localStorage.setItem('current_role', currentRole);
                }
                
                const config = roleConfig[currentRole];
                document.getElementById('current-role-text').textContent = config.name;
                const icon = document.querySelector('#current-role-btn i:first-child');
                icon.className = config.icon;
                
                // 只显示用户有权限的角色选项
                document.querySelectorAll('.role-option').forEach(opt => {
                    const role = opt.getAttribute('data-role');
                    
                    if (availableRoles.includes(role)) {
                        opt.style.display = 'flex';
                        if (role === currentRole) {
                            opt.classList.add('active');
                        }
                    } else {
                        opt.style.display = 'none';
                    }
                });
                
                // 如果只有一个角色，隐藏角色切换器
                if (availableRoles.length === 1) {
                    document.getElementById('role-switcher').style.display = 'none';
                }
            }

            initializeRole();

            // ============= 家长端功能 =============
            
            // 查看完整报告
            document.getElementById('view-full-report')?.addEventListener('click', function() {
                showNotification('完整报告功能开发中，敬请期待！', 'info');
            });

            // 更多沟通技巧
            document.getElementById('more-communication-tips')?.addEventListener('click', function() {
                showNotification('更多亲子沟通技巧即将推出！', 'info');
            });

            // 安全设置
            document.getElementById('safety-settings-btn')?.addEventListener('click', function() {
                showNotification('安全设置面板开发中', 'info');
            });

            // 家长预约咨询
            document.getElementById('parent-consult-btn')?.addEventListener('click', function() {
                document.getElementById('appointment-modal').classList.add('active');
            });

            // ============= 教师端功能 =============
            
            // 教师班级数据
            let teacherClasses = JSON.parse(localStorage.getItem('teacher_classes')) || [
                {
                    id: 1,
                    name: '高一(3)班',
                    students: 45,
                    avgMood: '良好',
                    lastActivity: '2小时前'
                },
                {
                    id: 2,
                    name: '高二(1)班',
                    students: 42,
                    avgMood: '优秀',
                    lastActivity: '1天前'
                }
            ];

            // 加载教师班级列表
            function loadTeacherClasses() {
                const container = document.getElementById('teacher-class-list');
                if (!container) return;
                
                if (teacherClasses.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: #999; padding: 2rem;">还没有创建班级</p>';
                    return;
                }
                
                container.innerHTML = teacherClasses.map(cls => `
                    <div class="class-item">
                        <div class="class-info">
                            <h4>${cls.name}</h4>
                            <p>${cls.students}名学生 · 整体情绪：${cls.avgMood} · 最后活动：${cls.lastActivity}</p>
                        </div>
                        <button class="btn btn-outline btn-sm" onclick="viewClassDetail(${cls.id})">
                            查看详情
                        </button>
                    </div>
                `).join('');
            }

            // 查看班级详情
            window.viewClassDetail = function(classId) {
                const cls = teacherClasses.find(c => c.id === classId);
                if (cls) {
                    showNotification(`查看${cls.name}详情`, 'info');
                }
            };

            // 创建班级
            document.getElementById('create-class-btn')?.addEventListener('click', function() {
                const className = prompt('请输入班级名称：');
                if (className) {
                    const newClass = {
                        id: Date.now(),
                        name: className,
                        students: 0,
                        avgMood: '暂无数据',
                        lastActivity: '刚刚'
                    };
                    teacherClasses.push(newClass);
                    localStorage.setItem('teacher_classes', JSON.stringify(teacherClasses));
                    loadTeacherClasses();
                    showNotification(`班级"${className}"创建成功！`, 'success');
                }
            });

            // 开始团体辅导
            document.getElementById('start-group-guidance-btn')?.addEventListener('click', function() {
                showNotification('团体辅导功能开发中', 'info');
            });

            // 详细分析
            document.getElementById('detailed-analysis-btn')?.addEventListener('click', function() {
                showNotification('详细学情分析功能开发中', 'info');
            });

            // 加载学生动态
            function loadStudentActivities() {
                const container = document.getElementById('student-activities');
                if (!container) return;
                
                const activities = [
                    { time: '5分钟前', content: '李明完成了情绪追踪记录' },
                    { time: '1小时前', content: '张小红参与了心理小岛互动' },
                    { time: '2小时前', content: '王强完成了每日学习任务' }
                ];
                
                container.innerHTML = activities.map(act => `
                    <div class="activity-item">
                        <div class="activity-time">${act.time}</div>
                        <div class="activity-content">${act.content}</div>
                    </div>
                `).join('');
            }

            // ============= 管理员端功能 =============
            
            // 管理用户
            document.getElementById('manage-users-btn')?.addEventListener('click', function() {
                showNotification('用户管理面板开发中', 'info');
            });

            // 角色权限管理
            document.getElementById('manage-roles-btn')?.addEventListener('click', function() {
                showNotification('角色权限管理功能开发中', 'info');
            });

            // 操作日志
            document.getElementById('audit-log-btn')?.addEventListener('click', function() {
                showNotification('操作日志查看功能开发中', 'info');
            });

            // 帖子审核
            document.getElementById('manage-posts-btn')?.addEventListener('click', function() {
                showNotification('帖子审核功能开发中', 'info');
            });

            // 树洞监控
            document.getElementById('manage-treehole-btn')?.addEventListener('click', function() {
                showNotification('树洞监控功能开发中', 'info');
            });

            // 资源管理
            document.getElementById('manage-resources-btn')?.addEventListener('click', function() {
                showNotification('资源管理功能开发中', 'info');
            });

            // 系统配置
            document.getElementById('system-config-btn')?.addEventListener('click', function() {
                showNotification('系统配置功能开发中', 'info');
            });

            // 数据备份
            document.getElementById('backup-btn')?.addEventListener('click', function() {
                showNotification('数据备份功能开发中', 'info');
            });

            // 安全设置
            document.getElementById('security-settings-btn')?.addEventListener('click', function() {
                showNotification('安全设置功能开发中', 'info');
            });

            console.log('心屿学院初始化完成');
        });
    </script>
</body>
</html>