# 🚨 服务再次失败 - 检查步骤

## 当前状态
❌ 服务显示失败状态（红色 X）

## 立即检查步骤

### 步骤 1：进入服务详情

1. **点击 "My project" 卡片**
   - 进入项目详情页

2. **找到并点击 "heartland-backend" 服务**
   - 进入服务详情页

### 步骤 2：查看最新日志

1. **切换到 "Logs" 标签**
   - 查看最新的错误信息
   - 确认是否是 Supabase 连接失败

### 步骤 3：检查环境变量

1. **点击左侧 "Settings"**
2. **找到 "Environment" 或 "Environment Variables"**
3. **检查是否已设置以下变量**：
   - `SUPABASE_URL` - 是否存在？值是否正确？
   - `SUPABASE_ANON_KEY` - 是否存在？
   - `SUPABASE_SERVICE_KEY` - 是否存在？
   - `JWT_SECRET` - 是否存在？
   - `PORT` - 应该是 `10000`
   - `NODE_ENV` - 应该是 `production`

### 步骤 4：如果环境变量未设置

**必须设置所有环境变量！**

#### 获取 Supabase 配置

1. **登录 Supabase**
   - 访问：https://supabase.com/dashboard
   - 登录账户

2. **检查项目是否存在**
   - 查看项目列表
   - 确认项目状态为 "Active"

3. **如果项目存在**：
   - 点击进入项目
   - Settings → API
   - 复制以下信息：
     - **Project URL** → 用于 `SUPABASE_URL`
     - **anon public key** → 用于 `SUPABASE_ANON_KEY`
     - **service_role key** → 用于 `SUPABASE_SERVICE_KEY`

4. **如果项目不存在或被删除**：
   - 需要创建新 Supabase 项目
   - 或者使用现有的 Supabase 项目

#### 在 Render 中设置环境变量

1. **在服务 Settings → Environment**
2. **添加以下变量**：

   ```
   SUPABASE_URL=https://您的项目ID.supabase.co
   SUPABASE_ANON_KEY=您的anon密钥
   SUPABASE_SERVICE_KEY=您的service_role密钥
   JWT_SECRET=随机长字符串（至少32位）
   PORT=10000
   NODE_ENV=production
   FRONTEND_URL=https://heartland-webapp.vercel.app
   ```

3. **生成 JWT_SECRET**（如果需要）：
   在终端运行：
   ```bash
   node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
   ```

4. **保存环境变量**

### 步骤 5：重新部署

1. **返回服务主页**
2. **点击 "Manual Deploy"**
3. **选择 "Deploy latest commit"**
4. **等待部署完成**
5. **查看日志**

### 步骤 6：验证部署

部署成功后，日志应该显示：
```
正在连接数据库...
✓ Supabase数据库连接成功
✓ 服务器启动成功
✓ 监听端口: 10000
```

## 常见问题

### Q1: Supabase 项目不存在怎么办？

**解决方案**：
1. 创建新的 Supabase 项目
2. 在 Supabase SQL Editor 中执行数据库初始化脚本
3. 获取新的 URL 和密钥
4. 在 Render 中设置环境变量

### Q2: 环境变量设置后仍然失败？

**检查**：
- ✅ 确认 Supabase URL 格式正确（https://开头，.supabase.co结尾）
- ✅ 确认密钥没有多余的空格或换行
- ✅ 确认 Supabase 项目状态为 "Active"
- ✅ 确认网络连接正常

### Q3: 如何确认环境变量已生效？

**方法**：
- 在服务 Settings → Environment 中查看
- 重新部署后查看日志
- 日志中不应该再出现 "ENOTFOUND" 错误

## 快速检查清单

- [ ] 已进入服务详情页
- [ ] 已查看最新日志，了解具体错误
- [ ] 已检查环境变量设置
- [ ] 已确认 Supabase 项目存在且为 Active
- [ ] 已获取正确的 Supabase URL 和密钥
- [ ] 已在 Render 中设置所有必需的环境变量
- [ ] 已保存环境变量
- [ ] 已重新部署服务
- [ ] 部署日志显示成功


